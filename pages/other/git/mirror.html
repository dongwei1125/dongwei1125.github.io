<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>DonV</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/header.jpg">
    <meta name="description" content="A paper about JavaScript, HTML and CSS.">
    
    <link rel="preload" href="/assets/css/0.styles.87611319.css" as="style"><link rel="preload" href="/assets/js/app.0aa97f73.js" as="script"><link rel="preload" href="/assets/js/2.f850a8ef.js" as="script"><link rel="preload" href="/assets/js/58.286692ba.js" as="script"><link rel="prefetch" href="/assets/js/10.cb041c1b.js"><link rel="prefetch" href="/assets/js/11.1aadbcee.js"><link rel="prefetch" href="/assets/js/12.77cc8e56.js"><link rel="prefetch" href="/assets/js/13.7e8162d9.js"><link rel="prefetch" href="/assets/js/14.dea6ba67.js"><link rel="prefetch" href="/assets/js/15.a786d687.js"><link rel="prefetch" href="/assets/js/16.163edf25.js"><link rel="prefetch" href="/assets/js/17.3a0232cb.js"><link rel="prefetch" href="/assets/js/18.91bd2dd7.js"><link rel="prefetch" href="/assets/js/19.a36993f8.js"><link rel="prefetch" href="/assets/js/20.30dd9f79.js"><link rel="prefetch" href="/assets/js/21.5e3c83a3.js"><link rel="prefetch" href="/assets/js/22.88d5e321.js"><link rel="prefetch" href="/assets/js/23.b54a65a7.js"><link rel="prefetch" href="/assets/js/24.51df379f.js"><link rel="prefetch" href="/assets/js/25.79342bd2.js"><link rel="prefetch" href="/assets/js/26.643d5441.js"><link rel="prefetch" href="/assets/js/27.54b7d7b4.js"><link rel="prefetch" href="/assets/js/28.d01a4aee.js"><link rel="prefetch" href="/assets/js/29.7d932073.js"><link rel="prefetch" href="/assets/js/3.31ebf682.js"><link rel="prefetch" href="/assets/js/30.4c2f5636.js"><link rel="prefetch" href="/assets/js/31.b00c42d5.js"><link rel="prefetch" href="/assets/js/32.e9a0f488.js"><link rel="prefetch" href="/assets/js/33.f510b5fd.js"><link rel="prefetch" href="/assets/js/34.6e78f32f.js"><link rel="prefetch" href="/assets/js/35.04d666a2.js"><link rel="prefetch" href="/assets/js/36.900a3beb.js"><link rel="prefetch" href="/assets/js/37.19ddf8d7.js"><link rel="prefetch" href="/assets/js/38.35f899bd.js"><link rel="prefetch" href="/assets/js/39.fe9ea525.js"><link rel="prefetch" href="/assets/js/4.3c7083a8.js"><link rel="prefetch" href="/assets/js/40.0d116ce0.js"><link rel="prefetch" href="/assets/js/41.6cdce4cf.js"><link rel="prefetch" href="/assets/js/42.ab0bd0d5.js"><link rel="prefetch" href="/assets/js/43.66c8f8eb.js"><link rel="prefetch" href="/assets/js/44.ac02981e.js"><link rel="prefetch" href="/assets/js/45.479814b0.js"><link rel="prefetch" href="/assets/js/46.29956259.js"><link rel="prefetch" href="/assets/js/47.a89cf7d2.js"><link rel="prefetch" href="/assets/js/48.859e3502.js"><link rel="prefetch" href="/assets/js/49.d0fa0b25.js"><link rel="prefetch" href="/assets/js/5.206809f3.js"><link rel="prefetch" href="/assets/js/50.d051084c.js"><link rel="prefetch" href="/assets/js/51.fa831e6a.js"><link rel="prefetch" href="/assets/js/52.3ed98760.js"><link rel="prefetch" href="/assets/js/53.016b1c3c.js"><link rel="prefetch" href="/assets/js/54.c88e06c5.js"><link rel="prefetch" href="/assets/js/55.937bfe09.js"><link rel="prefetch" href="/assets/js/56.03003660.js"><link rel="prefetch" href="/assets/js/57.8bcda68a.js"><link rel="prefetch" href="/assets/js/59.fbfe98aa.js"><link rel="prefetch" href="/assets/js/6.6f9d9bda.js"><link rel="prefetch" href="/assets/js/60.0975844e.js"><link rel="prefetch" href="/assets/js/61.0af6cf48.js"><link rel="prefetch" href="/assets/js/62.66c23699.js"><link rel="prefetch" href="/assets/js/63.7fda9b3f.js"><link rel="prefetch" href="/assets/js/7.6f64fba1.js"><link rel="prefetch" href="/assets/js/8.a163349f.js"><link rel="prefetch" href="/assets/js/9.9058d3cc.js">
    <link rel="stylesheet" href="/assets/css/0.styles.87611319.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/header.jpg" alt="DonV" class="logo"> <span class="site-name can-hide">DonV</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/pages/js/nav.html" class="nav-link">
  JavaScript
</a></div><div class="nav-item"><a href="/pages/html/nav.html" class="nav-link">
  HTML
</a></div><div class="nav-item"><a href="/pages/css/nav.html" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/pages/other/nav.html" class="nav-link">
  其它
</a></div><div class="nav-item"><a href="/pages/app/nav.html" class="nav-link">
  应用
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="关于" class="dropdown-title"><span class="title">关于</span> <span class="arrow down"></span></button> <button type="button" aria-label="关于" class="mobile-dropdown-title"><span class="title">关于</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/dongwei1125" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/dongwei1125" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://juejin.cn/user/2621689331987783" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://blog.csdn.net/Don_GW" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.npmjs.com/~dongwei1125" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NPM
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/pages/js/nav.html" class="nav-link">
  JavaScript
</a></div><div class="nav-item"><a href="/pages/html/nav.html" class="nav-link">
  HTML
</a></div><div class="nav-item"><a href="/pages/css/nav.html" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/pages/other/nav.html" class="nav-link">
  其它
</a></div><div class="nav-item"><a href="/pages/app/nav.html" class="nav-link">
  应用
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="关于" class="dropdown-title"><span class="title">关于</span> <span class="arrow down"></span></button> <button type="button" aria-label="关于" class="mobile-dropdown-title"><span class="title">关于</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/dongwei1125" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/dongwei1125" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://juejin.cn/user/2621689331987783" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://blog.csdn.net/Don_GW" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.npmjs.com/~dongwei1125" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NPM
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/other/git/mirror.html#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/other/git/mirror.html#同步" class="sidebar-link">同步</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/other/git/mirror.html#维护多个远端" class="sidebar-link">维护多个远端</a></li><li class="sidebar-sub-header"><a href="/pages/other/git/mirror.html#gitee-同步按钮" class="sidebar-link">Gitee 同步按钮</a></li><li class="sidebar-sub-header"><a href="/pages/other/git/mirror.html#webhooks" class="sidebar-link">webhooks</a></li><li class="sidebar-sub-header"><a href="/pages/other/git/mirror.html#github-actions" class="sidebar-link">GitHub Actions</a></li></ul></li><li><a href="/pages/other/git/mirror.html#常见问题" class="sidebar-link">常见问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/other/git/mirror.html#github-actions-如何自动化部署-pages" class="sidebar-link">GitHub Actions 如何自动化部署 Pages</a></li><li class="sidebar-sub-header"><a href="/pages/other/git/mirror.html#vuepress-如何多仓库同步和部署" class="sidebar-link">VuePress 如何多仓库同步和部署</a></li></ul></li><li><a href="/pages/other/git/mirror.html#🎉-写在最后" class="sidebar-link">🎉 写在最后</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p><img src="/other/git/mirror/banner.jpg" alt=""></p> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>  大多数的开发者都或多或少在<code>GitHub</code>上维护有项目，但是通常<code>GitHub</code>访问起来都很慢，或者无法响应。为了不能正常访问<code>GitHub</code>的用户，一般会将<code>Gitee</code>或其它平台托管作为镜像。</p> <p>  我们通常只考虑维护在<code>GitHub</code>上的仓库就足够了，而对于其它镜像仓库，更多的是希望在<code>GitHub</code>更新的同时，都以静默的方式自动同步。</p> <p>  因此以下将以<code>Gitee</code>作为镜像仓库，对比多种同步方式的利弊，跟随此文你将了解到。</p> <ul><li>同步<code>GitHub</code>和<code>Gitee</code>代码仓库的多种方式</li> <li><code>webhooks</code>是什么</li> <li>什么是<code>GitHub Actions</code>，<code>GitHub Actions</code>可以做什么</li> <li><code>GitHub Actions</code>如何自动化部署<code>Pages</code></li></ul> <h2 id="同步"><a href="#同步" class="header-anchor">#</a> 同步</h2> <h3 id="维护多个远端"><a href="#维护多个远端" class="header-anchor">#</a> 维护多个远端</h3> <p>  查看当前仓库关联的远程库。</p> <p><img src="/other/git/mirror/current.png" alt=""></p> <h4 id="推送多次"><a href="#推送多次" class="header-anchor">#</a> 推送多次</h4> <p>  删除<code>origin</code>，然后依次关联远程<code>GitHub</code>和<code>Gitee</code>仓库。</p> <p>  本地关联的远程库名称大多数都是<code>origin</code>，此情况对于单个远端来说很适用。若关联有多个远端，名称最好还是要容易区分。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>git remote rm origin
git remote add github https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>xxx<span class="token operator">/</span>repo<span class="token punctuation">.</span>git
git remote add gitee https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>gitee<span class="token punctuation">.</span>com<span class="token operator">/</span>xxx<span class="token operator">/</span>repo<span class="token punctuation">.</span>git
</code></pre></div><p>  查看关联的远程库。</p> <p><img src="/other/git/mirror/v.png" alt=""></p> <p>  本地代码提交后，分别推送至两个远端。缺点也比较明显，即推送多次显得冗余。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>git push github master
git push gitee master
</code></pre></div><h4 id="添加-package-json-脚本命令"><a href="#添加-package-json-脚本命令" class="header-anchor">#</a> 添加 package.json 脚本命令</h4> <p>  可在<code>package.json</code>中合并两个命令，推送时只运行<code>npm run push</code>即可。实际看似简化了输入，却添加了与项目无关的<code>scripts</code>命令。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// package.json</span>
<span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token string-property property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;push&quot;</span><span class="token operator">:</span> <span class="token string">&quot;git push github master &amp;&amp; git push gitee master&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="修改-git-内部配置"><a href="#修改-git-内部配置" class="header-anchor">#</a> 修改 Git 内部配置</h4> <p>  当前远端还是只有<code>origin</code>。</p> <p><img src="/other/git/mirror/current.png" alt=""></p> <p>  添加一条<code>push</code>的远端地址。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>git remote set<span class="token operator">-</span>url <span class="token operator">--</span>add origin https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>gitee<span class="token punctuation">.</span>com<span class="token operator">/</span>xxx<span class="token operator">/</span>repo<span class="token punctuation">.</span>git
</code></pre></div><p>  可以看到推送<code>push</code>的<code>url</code>多了一条。</p> <p><img src="/other/git/mirror/add.png" alt=""></p> <p>  因此<code>fetch</code>时将从<code>GitHub</code>拉取代码，<code>push</code>时将推送到<code>Gitee</code>和<code>GitHub</code>两个远端。此方式相对可用，但是无法做到部分的自动化功能，例如测试、部署等。</p> <p><img src="/other/git/mirror/push.png" alt=""></p> <h3 id="gitee-同步按钮"><a href="#gitee-同步按钮" class="header-anchor">#</a> Gitee 同步按钮</h3> <p>  若仓库还未创建，可在头部选择导入仓库。</p> <p><img src="/other/git/mirror/header.png" alt=""></p> <p>  若仓库已存在，可在仓库主页的管理菜单的功能设置下配置地址。</p> <p><img src="/other/git/mirror/url.png" alt=""></p> <p>  两种方式都将在仓库主页创建同步按钮。</p> <p><img src="/other/git/mirror/btn.png" alt=""></p> <p>  注意强制同步将覆盖当前仓库。</p> <p><img src="/other/git/mirror/click.png" alt=""></p> <h3 id="webhooks"><a href="#webhooks" class="header-anchor">#</a> webhooks</h3> <p>  ;<a href="https://docs.github.com/cn/developers/webhooks-and-events/webhooks/about-webhooks" target="_blank" rel="noopener noreferrer">webhooks<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 即<code>web</code>钩子，是一个可以接收<code>http/s</code>请求（多为<code>post</code>）的<code>URL</code>。大多数情况下都是客户端调用<code>api</code>获取服务端提供的数据。而在<code>webhooks</code>中，服务端则将在特定事件时调用<code>webhooks</code>钩子。</p> <p>  ;<code>GitHub</code>也提供了<code>webhooks</code>，当用户向仓库<code>push</code>推送（不单单是推送事件）代码时，<code>GitHub</code>将向配置的<code>URL</code>发送<code>http/s</code>请求，可用于发邮件、自动部署、备份镜像等等。</p> <p>  代码仓库可访问 <a href="https://github.com/dongwei1125/mirror-repo.git" target="_blank" rel="noopener noreferrer">GitHub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h4 id="准备工作"><a href="#准备工作" class="header-anchor">#</a> 准备工作</h4> <p>  根据以上特性，搭建一个<code>express</code>服务器，目的用于启动一个用于同步代码的服务端<code>post</code>接口。</p> <p>  目录结构如下，<code>app.js</code>为入口文件，<code>webhook-handler</code>用于提供同步代码的核心功能。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>├── webhook<span class="token operator">-</span>handler
│   ├── index<span class="token punctuation">.</span>js
│   ├── mirror<span class="token punctuation">.</span>js
│   ├── shell<span class="token punctuation">.</span>sh
│   ├── webhook<span class="token punctuation">.</span>config<span class="token punctuation">.</span>js
├── app<span class="token punctuation">.</span>js
├── <span class="token keyword">const</span><span class="token punctuation">.</span>js
├── <span class="token keyword">package</span><span class="token punctuation">.</span>json
├── <span class="token operator">...</span>
</code></pre></div><p>  ;<code>app.js</code>中引入<code>webhook-handler</code>处理函数，注意<code>GitHub</code>触发<code>webhooks</code>传递的是<code>json</code>格式的数据，要用到<code>express.json()</code>中间件，继续往下看。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// app.js</span>
<span class="token keyword">const</span> handler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webhook-handler'</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/mirror'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">handler</span><span class="token punctuation">(</span> <span class="token operator">...</span> <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="处理函数"><a href="#处理函数" class="header-anchor">#</a> 处理函数</h4> <p>  当<code>GitHub</code>调用<code>mirror</code>接口时，会将用户预设的秘钥<code>secret</code>和参数体<code>json</code>进行加密，加密后的序列会携带在请求头<code>header</code>的 <a href="https://docs.github.com/cn/developers/webhooks-and-events/webhooks/securing-your-webhooks#validating-payloads-from-github" target="_blank" rel="noopener noreferrer">x-hub-signature<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 中。</p> <p>  工具类函数<code>encrypted</code>，主要用于进行<code>hmacsha1</code>算法加密，参数<code>secret</code>为秘钥，<code>sign</code>为被用于加密的数据。</p> <p>  函数<code>isEqual</code>，用于对比两字符串是否一致，但是注意判断相等 <a href="https://docs.github.com/cn/developers/webhooks-and-events/webhooks/securing-your-webhooks#validating-payloads-from-github" target="_blank" rel="noopener noreferrer">不建议<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 用<code>===</code>，而应该使用 <a href="http://nodejs.cn/api/crypto.html#cryptotimingsafeequala-b" target="_blank" rel="noopener noreferrer">恒定时间<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 字符串比较，有助于提高服务端的安全性。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// webhook-handler/index.js</span>
<span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> sign <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'x-hub-signature'</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> encrypted <span class="token operator">=</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token constant">GITHUB_WEBHOOK_SECRET</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token parameter">secret<span class="token punctuation">,</span> sign</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sha1=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>crypto<span class="token punctuation">.</span><span class="token function">createHmac</span><span class="token punctuation">(</span><span class="token string">'sha1'</span><span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>sign<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">isEqual</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span> other <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>length <span class="token operator">!==</span> other<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span>

  <span class="token keyword">return</span> crypto<span class="token punctuation">.</span><span class="token function">timingSafeEqual</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>other<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  思考一下，为什么<code>GitHub</code>会将用户预设的秘钥和参数体加密呢？</p> <p>  秘钥加密可以理解，因为不能明文传递。</p> <p>  以上提供的<code>post</code>接口，对于<code>GitHub</code>的任意仓库都能触发，别人的仓库是不是也可以呢。那么如何区分是否是我们的仓库触发了呢，秘钥就派上用场了。当服务端保存的静态秘钥与<code>GitHub</code>仓库预设的秘钥一致时，就能确定是我们的仓库了。</p> <h4 id="同步代码"><a href="#同步代码" class="header-anchor">#</a> 同步代码</h4> <p>  ;<code>mirror.js</code>用于启动子进程，运行<code>shell</code>脚本来同步代码。</p> <p>  要明确的是，当我们向<code>https://github.com/xxx/repo.git</code>推送代码时，是无法登录验证权限的，而应当携带上用户名密码来推送，即推送到<code>https://<strong>username:password@</strong>github.com/xxx/repo.git</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// webhook-handler/mirror.js</span>
<span class="token keyword">const</span> fullPath <span class="token operator">=</span> <span class="token function">getFullPath</span><span class="token punctuation">(</span><span class="token constant">DIST_REPO</span><span class="token punctuation">,</span> <span class="token constant">GITEE_USERNAME</span><span class="token punctuation">,</span> <span class="token constant">GITEE_PASSWORD</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">getFullPath</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> index <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'//'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> protocol <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> index <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> path <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>protocol<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>username<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>password<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">@</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>
</code></pre></div><p>  ;<code>shell</code>脚本中，接收两个参数，分别为源仓库和目标仓库地址，注意<code>$1</code>和<code>$2</code>没有语义，可声明变量来保存。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// webhook-handler/mirror.js</span>
<span class="token keyword">const</span> shPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'shell.sh'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> command <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>shPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">SRC_REPO</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fullPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>

<span class="token comment">// webhook-handler/shell.sh</span>
<span class="token constant">SRC_REPO</span><span class="token operator">=</span>$1
<span class="token constant">DIST_REPO</span><span class="token operator">=</span>$2
<span class="token operator">...</span>
</code></pre></div><p>  有必要解释下<code>shell.sh</code>脚本的工作流程。</p> <ul><li><code>mkdir _temp ...</code>：根目录下创建临时目录<code>_temp</code>，切换工作目录到<code>_temp</code>下</li> <li><code>git clone --mirror ...</code>：镜像克隆，完全复制源仓库（包括分支、引用等等）</li> <li><code>git remote set-url --push ...</code>：将当前副本仓库的推送源地址修改为目标仓库</li> <li><code>git push --mirror</code>：镜像推送，完全推送到目标仓库（包括分支、引用等等）</li> <li><code>cd ...</code>：切换到初始的目录，删除临时仓库<code>_temp</code></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// webhook-handler/shell.sh</span>
mkdir _temp <span class="token operator">&amp;&amp;</span> cd _temp

git clone <span class="token operator">--</span>mirror <span class="token string">&quot;$SRC_REPO&quot;</span> <span class="token operator">&amp;&amp;</span> cd <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">basename &quot;$SRC_REPO&quot;</span><span class="token template-punctuation string">`</span></span>

git remote set<span class="token operator">-</span>url <span class="token operator">--</span>push origin <span class="token string">&quot;$DIST_REPO&quot;</span>

git push <span class="token operator">--</span>mirror

cd <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span> <span class="token operator">&amp;&amp;</span> rm <span class="token operator">-</span>rf _temp
</code></pre></div><h4 id="github-添加-webhooks"><a href="#github-添加-webhooks" class="header-anchor">#</a> GitHub 添加 webhooks</h4> <p>  在<code>GitHub</code>仓库下，选中<code>Settings</code>功能的<code>Webhooks</code>菜单，单击<code>Add webhook</code>添加。</p> <p><img src="/other/git/mirror/webhooks.png" alt=""></p> <p>  输入你部署在服务器上的<code>post</code>接口，设置<code>Secret</code>秘钥，注意<code>Content type</code>选择为<code>json</code>，另外触发<code>webhook</code>的事件类型，默认只有推送事件，你也可以自定义选择。</p> <p><img src="/other/git/mirror/trigger.png" alt=""></p> <p>  当你的仓库发生以上勾选的事件时，<code>GitHub</code>就会自动帮你调用部署在服务器上的<code>mirror</code>接口，进而镜像同步你的仓库代码。</p> <p>  ;<code>webhooks</code>的方式相对来说比较可行，但是缺点也很明显，一方面必须额外的服务器（有<code>node</code>环境且安装了<code>Git</code>）支持用来部署接口。另一方面，单个仓库同步还是很便捷，但是如果说多个仓库要镜像同步呢？</p> <p>  那我们的处理函数就要去判断请求接口的<code>GitHub</code>仓库来源，同时每多同步一组仓库，就要在服务端新增一组源仓库和目标仓库的地址。</p> <blockquote><p>提供一个 <a href="https://gitee.com/help/articles/4336#article-header0" target="_blank" rel="noopener noreferrer">Gitee<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 官方的<code>webhooks</code>，用于<code>Gitee</code>和<code>GitHub</code>双向同步的功能，但是注意目前尚处于内测期，只能 <a href="https://gitee.com/gitee-community/mirror-repository" target="_blank" rel="noopener noreferrer">申请<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 开通</p></blockquote> <h3 id="github-actions"><a href="#github-actions" class="header-anchor">#</a> GitHub Actions</h3> <p>  ;<a href="https://docs.github.com/cn/actions/learn-github-actions/understanding-github-actions" target="_blank" rel="noopener noreferrer">GitHub Actions<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 即是一个免费的虚拟机，提供了三种可选的操作系统（<code>Ubuntu Linux</code>、<code>Microsoft Windows</code>和<code>macOS</code>），用以执行用户自定义的工作流程。</p> <p>  那么何为工作流程呢？就是一个以<code>.yml</code>为后缀的文件（<code>YAML</code>语法），注意此文件要放置在代码仓库中的目录<code>.github/workflows</code>下才会生效。</p> <blockquote><p>注意对于每个工作流程，<code>GitHub</code>都会在预先配置好的全新虚拟机中执行</p></blockquote> <h4 id="hello-world"><a href="#hello-world" class="header-anchor">#</a> Hello world</h4> <p>  我们就用<code>GitHub Actions</code>打印<code>Hello world</code>试试，不用太过复杂的例子。</p> <p>  在<code>GitHub</code>仓库上选中<code>Actions</code>，单击<code>set up a workflow yourself</code>创建工作流程。</p> <p><img src="/other/git/mirror/setup.png" alt=""></p> <p>  然后在代码编辑器粘贴以下代码，以下为相关命令的含义，更多可 <a href="https://docs.github.com/cn/actions/using-workflows/workflow-syntax-for-github-actions" target="_blank" rel="noopener noreferrer">参考<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <ul><li><code>name: ...</code>：工作流程的名称为<code>Console hello world</code></li> <li><code>on: ...</code>：仓库发生推送<code>push</code>事件时执行</li> <li><code>jobs</code>：表示执行的一项或多项任务，当前仅有一个任务<code>console</code></li> <li><code>console</code>：任务名为<code>console</code></li> <li><code>runs-on ...</code>：任务<code>console</code>运行的虚拟机为最新的<code>Ubuntu Linux</code>环境</li> <li><code>steps</code>：任务<code>console</code>的运行步骤，当前仅有一个步骤</li> <li><code>- run ...</code>：运行命令<code>echo Hello world</code></li></ul> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token comment"># .github/gitflows/main.yml</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> Console hello world

<span class="token key atrule">on</span><span class="token punctuation">:</span> push

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">console</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> echo Hello world
</code></pre></div><p>  点击<code>Start Commit</code>然后<code>Commit new file</code>提交。</p> <p><img src="/other/git/mirror/edit.png" alt=""></p> <p>  仓库目录下将生成<code>main.yml</code>文件，另外会创建一次提交记录<code>Create main.yml</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>├── <span class="token punctuation">.</span>github
│   ├── workflows
│   │   ├── main<span class="token punctuation">.</span>yml
├── <span class="token operator">...</span>
</code></pre></div><p>  由于代码是在<code>GitHub</code>上提交的，相当于是本地代码推送<code>push</code>了一次，而脚本的执行条件就是<code>push</code>事件的发生，因此<code>GitHub Actions</code>将会触发。</p> <p><img src="/other/git/mirror/all.png" alt=""></p> <p>  单击<code>Create main.yml</code>查看此次推送执行的工作流程，成功在虚拟机下打印出<code>Hello world</code>。</p> <p><img src="/other/git/mirror/console.png" alt=""></p> <h4 id="准备工作-2"><a href="#准备工作-2" class="header-anchor">#</a> 准备工作</h4> <p>  先要保证本机环境有<code>Git</code>公钥和私钥。</p> <p>  然后在<code>Gitee</code>用户<code>SSH</code>公钥中，添加标题并粘贴公钥保存。
<img src="/other/git/mirror/ssh.png" alt=""></p> <p>  然后在<code>GitHub</code>的仓库<code>repo</code>下，<code>Settings</code>功能选择<code>Actions</code>，单击<code>New repository secret</code>添加秘钥。</p> <p><img src="/other/git/mirror/secrets.png" alt=""></p> <p>  呐，粘贴你的私钥，准备工作就完成了。</p> <p><img src="/other/git/mirror/finish.png" alt=""></p> <h4 id="添加脚本"><a href="#添加脚本" class="header-anchor">#</a> 添加脚本</h4> <p>  修改<code>.github/workflow/main.yml</code>。</p> <p>  根据刚才<code>Hello world</code>的例子，很容易知道当前工作流程的名称为<code>Mirror to Gitee repo</code>，仓库在推送<code>push</code>代码、删除<code>delete</code>分支或者创建<code>create</code>分支时，将执行此脚本。</p> <p>  脚本包含一个任务，名为<code>mirror</code>，运行的虚拟机为最新的<code>Ubuntu Linux</code>环境。而此任务下又包含两个名为<code>Config private key</code>和<code>Clone repo and push</code>的步骤。</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token comment"># .github/gitflows/main.yml</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> Mirror to Gitee repo

<span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> push<span class="token punctuation">,</span> delete<span class="token punctuation">,</span> create <span class="token punctuation">]</span>

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">mirror</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Config private key
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token key atrule">SSH_PRIVATE_KEY</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GITEE_PRIVATE_KEY <span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          mkdir -p ~/.ssh
          echo &quot;$SSH_PRIVATE_KEY&quot; &gt; ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo &quot;StrictHostKeyChecking no&quot; &gt;&gt; ~/.ssh/config</span>

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Clone repo and push
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token key atrule">SRC_REPO</span><span class="token punctuation">:</span> <span class="token string">&quot;https://github.com/xxx/repo.git&quot;</span>
          <span class="token key atrule">DIST_REPO</span><span class="token punctuation">:</span> <span class="token string">&quot;git@gitee.com:xxx/repo.git&quot;</span>
        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          git clone --mirror &quot;$SRC_REPO&quot;
          cd `basename &quot;$SRC_REPO&quot;`
          git remote set-url --push origin &quot;$DIST_REPO&quot;
          git push --mirror</span>
</code></pre></div><p>  ;<code>Config private key</code>用于在虚拟机的用户目录中写入私钥。<code>env</code>下有环境变量<code>SSH_PRIVATE_KEY</code>，变量值由 <a href="https://docs.github.com/cn/actions/learn-github-actions/contexts#secrets-context" target="_blank" rel="noopener noreferrer">secrets<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 上下文获取而来。</p> <p>  有没有觉得<code>GITEE_PRIVATE_KEY</code>很眼熟呢？没错，就是刚才保存在仓库目录下的私钥。</p> <p>  当用户向诸如<code>git@github.com:xxx/xx.git</code>的仓库推送代码时，遵循<code>SSH</code>传输协议。在推送前，<code>Git</code>将提交用户根目录下的私钥<code>id_rsa</code>到远端，远端则会将私钥和公钥（<code>GitHub</code>或者<code>Gitee</code>用户在服务端添加的公钥<code>id_rsa.pub</code>）对一起做验证，判别此私钥是否有推送权限。</p> <p>  而我们已经将公钥保存在了<code>Gitee</code>远端服务器上，私钥保存在<code>GitHub</code>仓库内的<code>GITEE_PRIVATE_KEY</code>上，<code>GitHub</code>平台会将私钥传递在<code>yml</code>脚本中的<code>secrets</code>上下文内，然后脚本获取后，将其写在了虚拟机的用户根目录下。此时虚拟机要推送的话，它当然是有权限的。</p> <p>  还是不太清楚的话，可以理解为。依托<code>GitHub</code>平台和<code>yml</code>脚本，我们本机的私钥将会被复制成为虚拟机的私钥。</p> <p>  以下为<code>Config private key</code>写入私钥的过程。</p> <ul><li><code>mkdir -p ...</code>：虚拟机根目录下创建<code>.ssh</code>文件夹。<code>-p</code>表示即使上级目录不存在，也要按目录层级自动创建</li> <li><code>echo ...</code>：将私钥写入<code>.ssh</code>文件夹下的<code>id_rsa</code>文件中</li> <li><code>chmod ...</code>：修改<code>id_rsa</code>的权限为<code>600</code>（仅所有者可读写）</li></ul> <p>  创建的<code>id_rsa</code>的访问权限<code>0644</code>过于开放，<code>Git</code>要求私钥文件不能被其他人访问。</p> <p><img src="/other/git/mirror/600.png" alt=""></p> <ul><li><code>echo ...</code>：关闭初次连接服务器时的提示</li></ul> <p>  当第一次连接服务器时，例如<code>push</code>提交，<code>Git</code>将弹出公钥确认的提示，将导致自动化任务中断。</p> <p><img src="/other/git/mirror/host.png" alt=""></p> <h4 id="同步代码-2"><a href="#同步代码-2" class="header-anchor">#</a> 同步代码</h4> <p>  当我们向<code>GitHub</code>仓库推送代码时，<code>GitHub Actions</code>将自动运行仓库下的<code>yml</code>脚本。若任务和任务下的步骤都通过，则表示执行成功。</p> <p><img src="/other/git/mirror/success.png" alt=""></p> <h4 id="actions"><a href="#actions" class="header-anchor">#</a> actions</h4> <p>  现在来思考一个问题，如果要同步另外的<code>GitHub</code>仓库到<code>Gitee</code>呢？</p> <p>  那么我们是不要复制以上代码，修改源和目的仓库地址呢？可以明确告诉你，不用。</p> <p>  ;<code>GitHub</code>想到了一个很好的办法，开发者可以发布不同的工作流程到 <a href="https://github.com/marketplace?type=actions" target="_blank" rel="noopener noreferrer">官方市场<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，而用户可以引用别人的<code>actions</code>即可。同步<code>GitHub</code>仓库到<code>Gitee</code>的功能，很早就有团队写好发布了，缺陷相对也很少。刚才讲那么多命令，只是为了更好地帮助你理解<code>GitHub Actions</code>的工作原理。</p> <p>  以下为 <a href="https://github.com/marketplace/actions/hub-mirror-action" target="_blank" rel="noopener noreferrer">hub-mirror-action<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 配置参数。</p> <ul><li><code>src</code>：源平台账户名</li> <li><code>dst</code>：目标平台账户名</li> <li><code>dst_key</code>：源仓库下保存的私钥</li> <li><code>static_list</code>：仅同步指定的仓库</li> <li><code>force_update</code>：强制同步</li></ul> <blockquote><p><code>hub-mirror-action</code>远远不止同步单个仓库，它可以将两个平台下的所有仓库都同步</p></blockquote> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token comment"># .github/gitflows/main.yml</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> Mirror to Gitee repo

<span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> push<span class="token punctuation">,</span> delete<span class="token punctuation">,</span> create <span class="token punctuation">]</span>

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">mirror</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> Yikun/hub<span class="token punctuation">-</span>mirror<span class="token punctuation">-</span>action@v1.2
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">src</span><span class="token punctuation">:</span> github/username
          <span class="token key atrule">dst</span><span class="token punctuation">:</span> gitee/username
          <span class="token key atrule">dst_key</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GITEE_PRIVATE_KEY <span class="token punctuation">}</span><span class="token punctuation">}</span>
          <span class="token key atrule">static_list</span><span class="token punctuation">:</span> <span class="token string">'repo'</span>
          <span class="token key atrule">force_update</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><h2 id="常见问题"><a href="#常见问题" class="header-anchor">#</a> 常见问题</h2> <h3 id="github-actions-如何自动化部署-pages"><a href="#github-actions-如何自动化部署-pages" class="header-anchor">#</a> GitHub Actions 如何自动化部署 Pages</h3> <p>  一个很常见的场景，当我们将本地仓库代码推送至远端<code>GitHub</code>仓库时，要同步代码到<code>Gitee</code>，并且自动部署<code>GitHub</code>和<code>Gitee</code>的<code>Pages</code>。</p> <p>  此处用<code>vuecli3</code>脚手架作为示例，运行<code>vue create app</code>安装<code>vue</code>空脚手架，然后修改<code>vue.config.js</code>中的生产路径。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// vue.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">publicPath</span><span class="token operator">:</span> <span class="token string">'./'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  根目录<code>app</code>下目录结构，<code>main.yml</code>用于部署<code>Pages</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>├── <span class="token punctuation">.</span>github
│   ├── workflows
│   │   ├── main<span class="token punctuation">.</span>yml
├── node_modules
├── src
│   ├── App<span class="token punctuation">.</span>vue
│   ├── main<span class="token punctuation">.</span>js
│   ├── <span class="token operator">...</span>
├── <span class="token operator">...</span>
├── vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>js
</code></pre></div><p>  部署<code>GitHub Pages</code>相对容易，<code>GitHub Pages</code>关联的分支有更新时将自动部署。</p> <p>  而<code>Gitee Pages</code>相对麻烦，只能手动更新部署。第三方<code>gitee-pages-action</code>内部实际是利用<code>Gitee</code>用户名和密码登录至平台，调用更新接口的方式来实现的自动部署。</p> <p>  以下为各个<code>actions</code>的功能及参数的作用。</p> <ul><li><a href="https://github.com/marketplace/actions/checkout" target="_blank" rel="noopener noreferrer">checkout<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：检出当前仓库。你可以想象成在虚拟机内克隆了当前仓库，然后就可以运行<code>package.json</code>中的<code>scripts</code>命令，例如<code>npm run build</code>等。</li> <li><a href="https://github.com/marketplace/actions/setup-node-js-environment" target="_blank" rel="noopener noreferrer">setup-node<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：虚拟机安装<code>node</code>环境。其中<code>node-version</code>用于指定<code>node</code>版本</li> <li><a href="https://github.com/marketplace/actions/github-pages-action" target="_blank" rel="noopener noreferrer">actions-gh-pages<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：部署<code>GitHub Pages</code>页面。将<code>npm run build</code>命令构建出的<code>dist</code>目录，创建为新分支<code>page</code>用于部署。<code>force_orphan</code>表示<code>page</code>分支只生成一次提交记录，<code>full_commit_message</code>为提交说明，<code>allow_empty_commit</code>表示即使<code>dist</code>文件没有更新，也要重新提交</li> <li><a href="https://github.com/marketplace/actions/hub-mirror-action" target="_blank" rel="noopener noreferrer">hub-mirror-action<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：镜像同步仓库</li> <li><a href="https://github.com/marketplace/actions/gitee-pages-action" target="_blank" rel="noopener noreferrer">gitee-pages-action<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：部署<code>Gitee Pages</code>页面。其中<code>GITEE_PASSWORD</code>为<code>GitHub</code>仓库下添加的<code>Gitee</code>平台密码，<code>gitee-repo</code>和<code>branch</code>表示对<code>Gitee</code>下的<code>repo</code>仓库的<code>page</code>分支进行部署</li></ul> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token comment"># .github/gitflows/main.yml</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> Mirror to Gitee repo and deploy pages

<span class="token key atrule">on</span><span class="token punctuation">:</span>
  <span class="token key atrule">push</span><span class="token punctuation">:</span>
    <span class="token key atrule">branches</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> master

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">deploy-github</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v3
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Setup node
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>node@v3
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">node-version</span><span class="token punctuation">:</span> <span class="token string">'16.14.0'</span>

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Depend install and build
        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          npm install
          npm run build</span>

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Deploy GitHub pages
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> peaceiris/actions<span class="token punctuation">-</span>gh<span class="token punctuation">-</span>pages@v3
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">deploy_key</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GITEE_PRIVATE_KEY <span class="token punctuation">}</span><span class="token punctuation">}</span>
          <span class="token key atrule">publish_branch</span><span class="token punctuation">:</span> page
          <span class="token key atrule">publish_dir</span><span class="token punctuation">:</span> dist
          <span class="token key atrule">allow_empty_commit</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">force_orphan</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">full_commit_message</span><span class="token punctuation">:</span> <span class="token string">'feat: deploy pages'</span>

  <span class="token key atrule">deploy-gitee</span><span class="token punctuation">:</span>
    <span class="token key atrule">needs</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>github
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Mirror to Gitee repo
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> Yikun/hub<span class="token punctuation">-</span>mirror<span class="token punctuation">-</span>action@v1.2
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">src</span><span class="token punctuation">:</span> github/username
          <span class="token key atrule">dst</span><span class="token punctuation">:</span> gitee/username
          <span class="token key atrule">dst_key</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GITEE_PRIVATE_KEY <span class="token punctuation">}</span><span class="token punctuation">}</span>
          <span class="token key atrule">static_list</span><span class="token punctuation">:</span> <span class="token string">'repo'</span>
          <span class="token key atrule">force_update</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Deploy Gitee pages
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> yanglbme/gitee<span class="token punctuation">-</span>pages<span class="token punctuation">-</span>action@v1.4.0
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">gitee-username</span><span class="token punctuation">:</span> username
          <span class="token key atrule">gitee-password</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GITEE_PASSWORD <span class="token punctuation">}</span><span class="token punctuation">}</span>
          <span class="token key atrule">gitee-repo</span><span class="token punctuation">:</span> repo
          <span class="token key atrule">branch</span><span class="token punctuation">:</span> page
</code></pre></div><p>  因此<code>main.yml</code>脚本的工作流程也非常清晰了，任务<code>deploy-github</code>用于检出仓库后构建代码，部署至<code>GitHub</code>对应仓库的<code>page</code>分支。任务<code>deploy-gitee</code>用于同步<code>GitHub</code>仓库至<code>Gitee</code>，然后在<code>Gitee</code>平台，对仓库的<code>page</code>分支再单独部署。</p> <p>  注意任务<code>deploy-gitee</code>一定是在<code>deploy-github</code>后运行的，否则仓库同步将无法达到预期。<a href="https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idneeds" target="_blank" rel="noopener noreferrer">needs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 表示当前任务要等待指定任务完成后才能执行。</p> <h3 id="vuepress-如何多仓库同步和部署"><a href="#vuepress-如何多仓库同步和部署" class="header-anchor">#</a> VuePress 如何多仓库同步和部署</h3> <p>  ;<a href="https://vuepress.vuejs.org/zh/" target="_blank" rel="noopener noreferrer">VuePress<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 也有仓库的同步和部署<code>Pages</code>的场景，但是相对来说有很大的差异性，主要原因在于部署<code>Pages</code>的代码位于另外的仓库下，而不是当前仓库的<code>page</code>分支。</p> <h4 id="准备工作-3"><a href="#准备工作-3" class="header-anchor">#</a> 准备工作</h4> <p>  你的<code>GitHub</code>应该包括两个仓库，一个用于保存<code>VuePress</code>的源码，一个用于静态博客，保存<code>VuePress</code>打包后的代码，另外<code>Gitee</code>仓库也是同理。</p> <p>  可能你会问，用一个命名分支（例如<code>page</code>）保存打包后的代码，在部署页面时选择此分支不是更好，还能节省一个仓库。</p> <p>  为什么会这样做呢？</p> <p>  在<code>Gitee</code>平台中，如果你的用户名为<code>username</code>，当你的仓库名和用户名一致时，就会触发一个 <a href="https://gitee.com/help/articles/4136#article-header0" target="_blank" rel="noopener noreferrer">隐藏特性<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，即访问地址<code>https://username.gitee.io</code>，就能访问你部署在<code>username</code>仓库的静态页面。</p> <blockquote><p>一般的<code>Gitee</code>仓库，部署为静态<code>Pages</code>后，访问地址都为二级目录。例如<code>repo</code>仓库，部署后的地址为<code>http://username.gitee.io/repo</code></p></blockquote> <p>  而在<code>GitHub</code>平台中，如果你的用户名为<code>username</code>，当你的仓库名为<code>username.github.io</code>时，也会触发一个隐藏特性，即访问地址<code>https://username.github.io</code>，就能访问部署在<code>username.github.io</code>仓库的静态页面，否则也会是二级目录的形式。</p> <blockquote><p><code>GitHub</code>平台，用户名和仓库名一致时，还会有另外的隐藏特性</p></blockquote> <p>  为什么会创建两个仓库，而不是以分支的方式就不用我多说了吧。为了触发平台的隐藏特性，让你的个人主页地址更加简洁，容易记忆。</p> <p>  因此我们实际要有四个仓库，<code>Gitee</code>平台的<code>vuepress</code>和<code>username</code>仓库，<code>GitHub</code>的<code>vuepress</code>和<code>username.github.io</code>仓库。</p> <h4 id="添加脚本-2"><a href="#添加脚本-2" class="header-anchor">#</a> 添加脚本</h4> <p>  默认你的目录结构为以下，其中<code>deploy-pages.yml</code>用于部署<code>Pages</code>，<code>mirror-repo.yml</code>用于同步<code>VuePress</code>源码仓库。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>├── <span class="token punctuation">.</span>github
│   ├── workflows
│   │   ├── deploy<span class="token operator">-</span>pages<span class="token punctuation">.</span>yml
│   │   ├── mirror<span class="token operator">-</span>repo<span class="token punctuation">.</span>yml
├── node_modules
├── docs
│   ├── <span class="token punctuation">.</span>vuepress
│   │   ├── config<span class="token punctuation">.</span>js
│   ├── <span class="token constant">README</span><span class="token punctuation">.</span>md
├── <span class="token keyword">package</span><span class="token punctuation">.</span>json
├── <span class="token punctuation">.</span>gitignore
</code></pre></div><p>  ;<code>package.json</code>添加<code>scripts</code>命令。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// package.json</span>
<span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token string-property property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vuepress dev docs --temp .temp&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vuepress build docs&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  然后新增<code>mirror-repo.yml</code>脚本，作用很简单，即将<code>Github</code>平台用户<code>username</code>的仓库<code>vuepress</code>，强制同步到<code>Gitee</code>平台用户<code>username</code>的仓库<code>vuepress</code>。</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token comment"># .github/workflows/mirror-repo.yml</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> Mirror to Gitee repo

<span class="token key atrule">on</span><span class="token punctuation">:</span>
  <span class="token key atrule">push</span><span class="token punctuation">:</span>
    <span class="token key atrule">branches</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> master

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">mirror</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> Yikun/hub<span class="token punctuation">-</span>mirror<span class="token punctuation">-</span>action@v1.2
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">src</span><span class="token punctuation">:</span> github/username
          <span class="token key atrule">dst</span><span class="token punctuation">:</span> gitee/username
          <span class="token key atrule">dst_key</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GITEE_PRIVATE_KEY <span class="token punctuation">}</span><span class="token punctuation">}</span>
          <span class="token key atrule">static_list</span><span class="token punctuation">:</span> <span class="token string">'vuepress'</span>
          <span class="token key atrule">force_update</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><p>  最后新增<code>deploy-pages.yml</code>脚本，以下为各步骤作用。</p> <ul><li><code>Setup node</code>：签出当前仓库并安装<code>node</code>环境</li> <li><code>Depend install and build</code>：安装依赖并打包代码</li> <li><code>Deploy GitHub pages</code>：将打包后的代码（位于<code>docs/.vuepress/dist</code>目录下），推送到用户<code>username</code>的<code>username.github.io</code>仓库</li> <li><code>Mirror to Gitee repo</code>：同步<code>GitHub</code>平台的仓库<code>username.github.io</code>代码，至<code>Gitee</code>平台的<code>username</code>仓库。其中<code>mappings</code>参数表示仓库名不同时的映射</li> <li><code>Deploy Gitee pages</code>：将<code>Gitee</code>平台的用户<code>username</code>下的<code>username</code>仓库，其中的<code>master</code>分支代码部署为<code>Pages</code></li></ul> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token comment"># .github/workflows/mirror-repo.yml</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> Deploy pages

<span class="token key atrule">on</span><span class="token punctuation">:</span>
  <span class="token key atrule">push</span><span class="token punctuation">:</span>
    <span class="token key atrule">branches</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> master

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">deploy-github</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v3
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Setup node
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>node@v3
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">node-version</span><span class="token punctuation">:</span> <span class="token string">'16.14.0'</span>

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Depend install and build
        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          npm install
          npm run build</span>
          
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Deploy GitHub pages
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> peaceiris/actions<span class="token punctuation">-</span>gh<span class="token punctuation">-</span>pages@v3
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">deploy_key</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GITEE_PRIVATE_KEY <span class="token punctuation">}</span><span class="token punctuation">}</span>
          <span class="token key atrule">external_repository</span><span class="token punctuation">:</span> username/username.github.io
          <span class="token key atrule">publish_branch</span><span class="token punctuation">:</span> master
          <span class="token key atrule">publish_dir</span><span class="token punctuation">:</span> docs/.vuepress/dist
          <span class="token key atrule">allow_empty_commit</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">force_orphan</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">full_commit_message</span><span class="token punctuation">:</span> <span class="token string">'feat: deploy pages'</span>

  <span class="token key atrule">deploy-gitee</span><span class="token punctuation">:</span>
    <span class="token key atrule">needs</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>github
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Mirror to Gitee repo
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> Yikun/hub<span class="token punctuation">-</span>mirror<span class="token punctuation">-</span>action@v1.2
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">src</span><span class="token punctuation">:</span> github/username
          <span class="token key atrule">dst</span><span class="token punctuation">:</span> gitee/username
          <span class="token key atrule">dst_key</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GITEE_PRIVATE_KEY <span class="token punctuation">}</span><span class="token punctuation">}</span>
          <span class="token key atrule">mappings</span><span class="token punctuation">:</span> <span class="token string">&quot;username.github.io=&gt;username&quot;</span>
          <span class="token key atrule">static_list</span><span class="token punctuation">:</span> <span class="token string">'username.github.io'</span>
          <span class="token key atrule">force_update</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Deploy Gitee pages
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> yanglbme/gitee<span class="token punctuation">-</span>pages<span class="token punctuation">-</span>action@v1.4.0
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">gitee-username</span><span class="token punctuation">:</span> username
          <span class="token key atrule">gitee-password</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GITEE_PASSWORD <span class="token punctuation">}</span><span class="token punctuation">}</span>
          <span class="token key atrule">gitee-repo</span><span class="token punctuation">:</span> username
          <span class="token key atrule">branch</span><span class="token punctuation">:</span> master
</code></pre></div><h2 id="🎉-写在最后"><a href="#🎉-写在最后" class="header-anchor">#</a> 🎉 写在最后</h2> <p>🍻伙伴们，如果你已经看到了这里，觉得这篇文章有帮助到你的话不妨点赞👍或 <a href="https://github.com/dongwei1125/blog" target="_blank" rel="noopener noreferrer">Star<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ✨支持一下哦！</p> <p>手动码字，如有错误，欢迎在评论区指正💬~</p> <p>你的支持就是我更新的最大动力💪~</p> <p><a href="https://github.com/dongwei1125" target="_blank" rel="noopener noreferrer">GitHub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> / <a href="https://gitee.com/dongwei1125" target="_blank" rel="noopener noreferrer">Gitee<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://dongwei1125.github.io/" target="_blank" rel="noopener noreferrer">GitHub Pages<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://juejin.cn/user/2621689331987783" target="_blank" rel="noopener noreferrer">掘金<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://blog.csdn.net/Don_GW" target="_blank" rel="noopener noreferrer">CSDN<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 同步更新，欢迎关注😉~</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">6/13/2022, 8:34:24 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.0aa97f73.js" defer></script><script src="/assets/js/2.f850a8ef.js" defer></script><script src="/assets/js/58.286692ba.js" defer></script>
  </body>
</html>
