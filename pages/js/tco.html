<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>关于取消 ES6 函数尾递归的相关探究 | DonV</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/header.jpg">
    <meta name="description" content="A paper about JavaScript, HTML and CSS.">
    
    <link rel="preload" href="/assets/css/0.styles.87611319.css" as="style"><link rel="preload" href="/assets/js/app.0aa97f73.js" as="script"><link rel="preload" href="/assets/js/2.f850a8ef.js" as="script"><link rel="preload" href="/assets/js/53.016b1c3c.js" as="script"><link rel="preload" href="/assets/js/3.31ebf682.js" as="script"><link rel="prefetch" href="/assets/js/10.cb041c1b.js"><link rel="prefetch" href="/assets/js/11.1aadbcee.js"><link rel="prefetch" href="/assets/js/12.77cc8e56.js"><link rel="prefetch" href="/assets/js/13.7e8162d9.js"><link rel="prefetch" href="/assets/js/14.dea6ba67.js"><link rel="prefetch" href="/assets/js/15.a786d687.js"><link rel="prefetch" href="/assets/js/16.163edf25.js"><link rel="prefetch" href="/assets/js/17.3a0232cb.js"><link rel="prefetch" href="/assets/js/18.91bd2dd7.js"><link rel="prefetch" href="/assets/js/19.a36993f8.js"><link rel="prefetch" href="/assets/js/20.30dd9f79.js"><link rel="prefetch" href="/assets/js/21.5e3c83a3.js"><link rel="prefetch" href="/assets/js/22.88d5e321.js"><link rel="prefetch" href="/assets/js/23.b54a65a7.js"><link rel="prefetch" href="/assets/js/24.51df379f.js"><link rel="prefetch" href="/assets/js/25.79342bd2.js"><link rel="prefetch" href="/assets/js/26.643d5441.js"><link rel="prefetch" href="/assets/js/27.54b7d7b4.js"><link rel="prefetch" href="/assets/js/28.d01a4aee.js"><link rel="prefetch" href="/assets/js/29.7d932073.js"><link rel="prefetch" href="/assets/js/30.4c2f5636.js"><link rel="prefetch" href="/assets/js/31.b00c42d5.js"><link rel="prefetch" href="/assets/js/32.e9a0f488.js"><link rel="prefetch" href="/assets/js/33.f510b5fd.js"><link rel="prefetch" href="/assets/js/34.6e78f32f.js"><link rel="prefetch" href="/assets/js/35.04d666a2.js"><link rel="prefetch" href="/assets/js/36.900a3beb.js"><link rel="prefetch" href="/assets/js/37.19ddf8d7.js"><link rel="prefetch" href="/assets/js/38.35f899bd.js"><link rel="prefetch" href="/assets/js/39.fe9ea525.js"><link rel="prefetch" href="/assets/js/4.3c7083a8.js"><link rel="prefetch" href="/assets/js/40.0d116ce0.js"><link rel="prefetch" href="/assets/js/41.6cdce4cf.js"><link rel="prefetch" href="/assets/js/42.ab0bd0d5.js"><link rel="prefetch" href="/assets/js/43.66c8f8eb.js"><link rel="prefetch" href="/assets/js/44.ac02981e.js"><link rel="prefetch" href="/assets/js/45.479814b0.js"><link rel="prefetch" href="/assets/js/46.29956259.js"><link rel="prefetch" href="/assets/js/47.a89cf7d2.js"><link rel="prefetch" href="/assets/js/48.859e3502.js"><link rel="prefetch" href="/assets/js/49.d0fa0b25.js"><link rel="prefetch" href="/assets/js/5.206809f3.js"><link rel="prefetch" href="/assets/js/50.d051084c.js"><link rel="prefetch" href="/assets/js/51.fa831e6a.js"><link rel="prefetch" href="/assets/js/52.3ed98760.js"><link rel="prefetch" href="/assets/js/54.c88e06c5.js"><link rel="prefetch" href="/assets/js/55.937bfe09.js"><link rel="prefetch" href="/assets/js/56.03003660.js"><link rel="prefetch" href="/assets/js/57.8bcda68a.js"><link rel="prefetch" href="/assets/js/58.286692ba.js"><link rel="prefetch" href="/assets/js/59.fbfe98aa.js"><link rel="prefetch" href="/assets/js/6.6f9d9bda.js"><link rel="prefetch" href="/assets/js/60.0975844e.js"><link rel="prefetch" href="/assets/js/61.0af6cf48.js"><link rel="prefetch" href="/assets/js/62.66c23699.js"><link rel="prefetch" href="/assets/js/63.7fda9b3f.js"><link rel="prefetch" href="/assets/js/7.6f64fba1.js"><link rel="prefetch" href="/assets/js/8.a163349f.js"><link rel="prefetch" href="/assets/js/9.9058d3cc.js">
    <link rel="stylesheet" href="/assets/css/0.styles.87611319.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/header.jpg" alt="DonV" class="logo"> <span class="site-name can-hide">DonV</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/pages/js/nav.html" class="nav-link">
  JavaScript
</a></div><div class="nav-item"><a href="/pages/html/nav.html" class="nav-link">
  HTML
</a></div><div class="nav-item"><a href="/pages/css/nav.html" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/pages/other/nav.html" class="nav-link">
  其它
</a></div><div class="nav-item"><a href="/pages/app/nav.html" class="nav-link">
  应用
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="关于" class="dropdown-title"><span class="title">关于</span> <span class="arrow down"></span></button> <button type="button" aria-label="关于" class="mobile-dropdown-title"><span class="title">关于</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/dongwei1125" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/dongwei1125" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://juejin.cn/user/2621689331987783" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://blog.csdn.net/Don_GW" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.npmjs.com/~dongwei1125" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NPM
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/pages/js/nav.html" class="nav-link">
  JavaScript
</a></div><div class="nav-item"><a href="/pages/html/nav.html" class="nav-link">
  HTML
</a></div><div class="nav-item"><a href="/pages/css/nav.html" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/pages/other/nav.html" class="nav-link">
  其它
</a></div><div class="nav-item"><a href="/pages/app/nav.html" class="nav-link">
  应用
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="关于" class="dropdown-title"><span class="title">关于</span> <span class="arrow down"></span></button> <button type="button" aria-label="关于" class="mobile-dropdown-title"><span class="title">关于</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/dongwei1125" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/dongwei1125" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://juejin.cn/user/2621689331987783" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://blog.csdn.net/Don_GW" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.npmjs.com/~dongwei1125" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NPM
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>关于取消 ES6 函数尾递归的相关探究</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/js/tco.html#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/js/tco.html#尾调用" class="sidebar-link">尾调用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/js/tco.html#调用栈" class="sidebar-link">调用栈</a></li><li class="sidebar-sub-header"><a href="/pages/js/tco.html#尾调用优化" class="sidebar-link">尾调用优化</a></li></ul></li><li><a href="/pages/js/tco.html#斐波那契" class="sidebar-link">斐波那契</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/js/tco.html#最大栈长度" class="sidebar-link">最大栈长度</a></li><li class="sidebar-sub-header"><a href="/pages/js/tco.html#节点数" class="sidebar-link">节点数</a></li><li class="sidebar-sub-header"><a href="/pages/js/tco.html#浏览器" class="sidebar-link">浏览器</a></li><li class="sidebar-sub-header"><a href="/pages/js/tco.html#常见误区" class="sidebar-link">常见误区</a></li><li class="sidebar-sub-header"><a href="/pages/js/tco.html#尾递归" class="sidebar-link">尾递归</a></li><li class="sidebar-sub-header"><a href="/pages/js/tco.html#尾递归优化" class="sidebar-link">尾递归优化</a></li><li class="sidebar-sub-header"><a href="/pages/js/tco.html#主要原因" class="sidebar-link">主要原因</a></li><li class="sidebar-sub-header"><a href="/pages/js/tco.html#stc" class="sidebar-link">STC</a></li></ul></li><li><a href="/pages/js/tco.html#优化" class="sidebar-link">优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/js/tco.html#循环" class="sidebar-link">循环</a></li><li class="sidebar-sub-header"><a href="/pages/js/tco.html#蹦床函数" class="sidebar-link">蹦床函数</a></li><li class="sidebar-sub-header"><a href="/pages/js/tco.html#闭包" class="sidebar-link">闭包</a></li></ul></li><li><a href="/pages/js/tco.html#小结" class="sidebar-link">小结</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/js/tco.html#参考" class="sidebar-link">参考</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/js/tco.html#🎉-写在最后" class="sidebar-link">🎉 写在最后</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="关于取消-es6-函数尾递归的相关探究"><a href="#关于取消-es6-函数尾递归的相关探究" class="header-anchor">#</a> 关于取消 ES6 函数尾递归的相关探究</h1> <p><img src="/js/tco/banner.jpg" alt=""></p> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>  ;<code>ES6</code>中的尾递归优化非常实用，于是乎去初步探究。但是你会非常失望，发现绝大多数浏览器已经不支持，<code>node</code>也在很早的版本中取消了支持。关于尾递归优化的相关文档，也都仅仅是简单提及，只言片语，优化点原理几乎就不提，了解起来非常麻烦。</p> <p>  因此查阅了很多文档，并简单汇总，希望可以由斐波那契数列，逐步展开，引导你了解尾递归的知识点。</p> <p>  以下内容中的知识点包括。</p> <ul><li><code>STC</code>、<code>TCO</code>和<code>STC</code>分别是什么</li> <li>尾调用优化的优化点是什么</li> <li><code>V8</code>为何取消支持尾调用优化</li> <li><code>PTC</code>与<code>STC</code>的优缺点</li></ul> <h2 id="尾调用"><a href="#尾调用" class="header-anchor">#</a> 尾调用</h2> <h3 id="调用栈"><a href="#调用栈" class="header-anchor">#</a> 调用栈</h3> <p>  ;<code>JavaScript</code>调用栈用于存储代码执行期间的所有上下文，每一个执行上下文也叫调用帧，栈内活动通常为。</p> <ul><li>运行全局代码，创建全局执行上下文并压入栈中</li> <li>函数被调用时，创建函数执行上下文并压入栈顶。函数执行完成后，对应的上下文弹出</li> <li>全局代码执行结束，全局执行上下文弹出，调用栈清空</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> x <span class="token comment">// A</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">bar</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span> <span class="token comment">// B</span>
<span class="token punctuation">}</span>

<span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// C</span>
</code></pre></div><p>  以上代码调用栈的活动情况如下。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>	                                  bar context
	                                   ├── x
	                                   └── Line <span class="token constant">B</span>
				   foo context        foo context        foo context
		            ├── x              ├── x              ├── x
		            └── Line <span class="token constant">C</span>	       └── Line <span class="token constant">C</span>         └── Line <span class="token constant">C</span>  
global context <span class="token operator">--</span><span class="token operator">&gt;</span> global context <span class="token operator">--</span><span class="token operator">&gt;</span> global context <span class="token operator">--</span><span class="token operator">&gt;</span> global context <span class="token operator">--</span><span class="token operator">&gt;</span> global context
 ├── bar            ├── bar            ├── bar            ├── bar            ├── bar
 └── foo            └── foo            └── foo            └── foo            └── foo
</code></pre></div><p>  函数在执行前， 除了初始化变量对象、作用域链和<code>this</code>之外，调用帧上还将保存函数返回位置的地址信息。例如<code>bar</code>函数执行完成后，返回代码行<code>B</code>，在<code>bar</code>函数的调用帧就保存了代码行<code>B</code>的位置地址。</p> <h3 id="尾调用优化"><a href="#尾调用优化" class="header-anchor">#</a> 尾调用优化</h3> <p>  将代码改造为尾调用，即在函数的最后一步只调用函数。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> x <span class="token operator">+</span> y <span class="token comment">// A</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">bar</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// B</span>
<span class="token punctuation">}</span>

<span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// C</span>
</code></pre></div><p>  现在来思考一个问题，函数<code>foo</code>运行完最后一行代码后，将执行权交接给了<code>bar</code>函数，<code>foo</code>剩下的唯一用处就是将返回值传递给代码行<code>C</code>。</p> <p>  如果我们将<code>bar</code>函数的返回位置直接修改为<code>C</code>，不再通过<code>B</code>，那么<code>foo</code>是不就没用了啊。</p> <p>  因此我们就可以将<code>foo</code>的调用帧删除了，但是注意要在<code>foo</code>运行后，交出执行权给<code>bar</code>之前删除，因为<code>foo</code>函数中可能有其它的代码要执行。</p> <p>  再来看看调用栈的活动情况。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>				                      bar context
		           foo context         ├── x    
		            ├── x              ├── y
		            └── Line <span class="token constant">C</span>	       └── Line <span class="token constant">C</span> 
global context <span class="token operator">--</span><span class="token operator">&gt;</span> global context <span class="token operator">--</span><span class="token operator">&gt;</span> global context <span class="token operator">--</span><span class="token operator">&gt;</span> global context
 ├── bar            ├── bar            ├── bar            ├── bar
 └── foo            └── foo            └── foo            └── foo
</code></pre></div><p>  以上则是我们经常说的尾调用优化（<code>TCO</code>，<code>Tail Call Optimization</code>），与规范中提到的<code>PTO</code>（<code>Proper Tail Calls</code>）是同一个东西，只是叫法不同。</p> <p>  尾调用优化的优点也很明显，当函数关系复杂时，调用栈的长度会大大减小，从而节省内存，避免出现堆栈溢出的情况。缺点则是，为了改造为尾调用，部分函数的参数将调整，函数的语义将不同于原本的语义，出现偏差，造成维护成本增加。另外此优化是浏览器层面的，依赖引擎支持，会出现兼容性差异。</p> <h2 id="斐波那契"><a href="#斐波那契" class="header-anchor">#</a> 斐波那契</h2> <p>  普通形式的斐波那契数列。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 1 1 2 3 5 8 13 21 34 55</span>
<span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">1</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">f</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="最大栈长度"><a href="#最大栈长度" class="header-anchor">#</a> 最大栈长度</h3> <p>  执行<code>f(4)</code>时的调用栈活动。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>                           <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>              <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                  <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>     <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>     <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>     <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>     <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>              <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>                                <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>              <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
		 <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>     <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>     <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>     <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>     <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>     <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>     <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>     <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>     <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>              <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>     <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>     <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>     <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>     <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token function">f</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
</code></pre></div><p>  更加直观的节点图。</p> <p><img src="/js/tco/f4.png" alt=""></p> <p>  可以归纳出<code>f(n)</code>执行期间的最大调用栈长度为<code>n</code>。</p> <h3 id="节点数"><a href="#节点数" class="header-anchor">#</a> 节点数</h3> <p>  斐波那契的通项公式<code>a(n)</code>为。</p> <div class="math"><span class="latex"></span></div> <p>  节点数量<code>g(n)</code>为。</p> <div class="math"><span class="latex"></span></div> <p>  ;<code>JavaScript</code>代码也贴一下，你可以测试验证。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> sqrt5 <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> sqrt5<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token operator">-</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> sqrt5<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> sqrt5
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token function">a</span><span class="token punctuation">(</span>n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="浏览器"><a href="#浏览器" class="header-anchor">#</a> 浏览器</h3> <p>  以下代码可用于测试浏览器的调用栈长度。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">getDeep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token function">getDeep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">1</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">getDeep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>  相关浏览器的调用栈长度为。</p> <ul><li><code>Chrome</code>：<code>11419</code></li> <li><code>Firefox</code>：<code>25607</code></li> <li><code>Opera</code>：<code>22862</code></li> <li><code>Edge</code>：<code>3718</code></li> <li><code>IE11</code>：<code>1982</code></li></ul> <p>  然后看另外一种情况。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">getDeep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token function">getDeep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">1</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">getDeep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>  ;<code>Chrome</code>浏览器下打印<code>8973</code>，因此可以发现，除了浏览器和浏览器版本的不同，会影响执行栈长度之外，函数体的大小和函数内变量的数量也会影响栈的长度。</p> <h3 id="常见误区"><a href="#常见误区" class="header-anchor">#</a> 常见误区</h3> <p>  ;<code>f(40)</code>运行耗时大概<code>800ms</code>左右，另外根据刚才的结论，<code>f(40)</code>的最大栈长度为<code>40</code>，节点数为<code>331160281</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'f(40)'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 102334155</span>
console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'f(40)'</span><span class="token punctuation">)</span> <span class="token comment">// f(40): 800.323974609375 ms</span>
</code></pre></div><p>  然后运行<code>f(100)</code>试试，容易知道最大栈长度为<code>100</code>，节点数<code>g(100)</code>约为<code>1.146295688027638e+21</code>。</p> <blockquote><p>注意节点数为约数，原因在于<code>JavaScript</code>中数值的有效位数为<code>16</code>位，运算过程中可能存在舍入，造成精度丢失</p></blockquote> <p>  实际你会发现，浏览器将无响应，且长时间处于加载状态。</p> <p>  我们用<code>f(40)</code>来粗略地估计<code>f(100)</code>的执行时长，假设每个节点运行耗时相同，注意实际每个节点耗时肯定不一样，但是足够说明问题了。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> cost <span class="token operator">=</span> <span class="token number">800</span> <span class="token operator">/</span> <span class="token number">331160281</span> <span class="token comment">// 单个节点耗时</span>
<span class="token keyword">var</span> millisecond <span class="token operator">=</span> <span class="token number">12</span> <span class="token operator">*</span> <span class="token number">30</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token comment">// 一年的毫秒数</span>

<span class="token comment">// f(100) 耗时（年）</span>
<span class="token number">1.146295688027638e+21</span> <span class="token operator">*</span> cost <span class="token operator">/</span> millisecond <span class="token comment">// 89029</span>
</code></pre></div><p>  粗略估计<code>f(100)</code>将运行约<code>89029</code>年（无参考性），因此浏览器无响应的根本原因是，节点数过于庞大，浏览器长时间处在运算中。</p> <p>  注意不是爆栈，不是爆栈，<code>f(100)</code>的最大栈长度仅为<code>100</code>，远远小于浏览器的调用栈长度（<code>Chrome</code>调用栈长度<code>11419</code>）。除非是执行<code>f(11419)</code>，才会存在爆栈的情况，另外受函数体的大小和变量数量的影响，实际根本不用达到<code>11419</code>就会爆栈。</p> <blockquote><p>由于一些官方文档排版错误，很容易被误导是爆栈导致浏览器无响应，注意区分</p></blockquote> <h3 id="尾递归"><a href="#尾递归" class="header-anchor">#</a> 尾递归</h3> <p>  节点数过多造成运行超时，现在来考虑优化。</p> <p>  尝试将斐波那契修改为尾递归形式，尾递归即函数尾调用自身。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">,</span> m <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> o <span class="token operator">=</span> <span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> o
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> o<span class="token punctuation">,</span> m <span class="token operator">+</span> o<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  ;<code>f(4)</code>的调用栈活动。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>                              <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
               <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>     <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>     <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token function">f</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><p>  更加直观的节点图。</p> <p><img src="/js/tco/f411.png" alt=""></p> <p>  可归纳出<code>f(n)</code>执行期间的最大调用栈长度和节点数均为<code>n - 1</code>。</p> <p>  ;<code>f(100)</code>的节点数仅<code>99</code>，浏览器运行非常流畅。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'f(100)'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 354224848179262000000</span>
console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'f(100)'</span><span class="token punctuation">)</span> <span class="token comment">// f(100): 0.107177734375 ms</span>
</code></pre></div><p>  甚至可以运算<code>f(6000)</code>，<code>Infinity</code>说明<code>f(6000)</code>的数值已经非常大了。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'f(6000)'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token number">6000</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// Infinity</span>
console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'f(6000)'</span><span class="token punctuation">)</span> <span class="token comment">// f(6000): 1.869873046875 ms</span>
</code></pre></div><p>  斐波那契的普通方式运行<code>f(100)</code>浏览器长时间无响应，而递归方式可以轻松运行<code>f(6000)</code>，对代码的执行效率提升可以说是爆炸级的。</p> <p>  应当明确的是，尾递归方式仅仅优化了节点数，即减少了函数的调用次数，以此避免程序超时，但是代码还是会存在堆栈溢出爆栈的情况的，例如<code>f(10000)</code>。</p> <p><img src="/js/tco/stack.png" alt=""></p> <h3 id="尾递归优化"><a href="#尾递归优化" class="header-anchor">#</a> 尾递归优化</h3> <p>  文初提及的尾调用优化（<code>PTC</code>），可用来减少调用栈，避免堆栈溢出，实际就是用来解决爆栈问题的，另外递归函数中的<code>PTC</code>又被称为尾递归优化。</p> <p>  目前<code>PTC</code>仅在<code>Safari</code>浏览器和部分<code>node</code>版本中支持，<code>node</code>中仅<code>6.0.0 ~ 8.6.0</code>版本支持，<code>5.12.0</code>及之前的版本不支持，从<code>8.7.0</code>开始不再提供支持。</p> <p>  查看当前<code>node</code>版本选项，包含<code>--harmony_tailcalls</code>即表示支持<code>PTC</code>。</p> <p><img src="/js/tco/tc.png" alt=""></p> <p>  我们在<code>node</code>的<code>8.6.0</code>版本中运行斐波那契（尾递归形式）<code>f(100000)</code>。</p> <p><img src="/js/tco/f100000.png" alt=""></p> <p>  ;<code>node</code>的调用栈长度为<code>8961</code>，必然会爆栈。</p> <p>  尝试开启<code>PTC</code>优化。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>node <span class="token operator">--</span>use<span class="token operator">-</span>strict <span class="token operator">--</span>harmony<span class="token operator">-</span>tailcalls tco<span class="token punctuation">.</span>js
</code></pre></div><blockquote><p><code>--use-strict</code>表示开启严格模式，<code>--harmony-tailcalls</code>或者<code>--harmony</code>选项都能开启<code>PTC</code></p></blockquote> <p>  ;<code>f(100000)</code>成功运行，理论上<code>f(n)</code>参数多大都能运行，但是注意节点数会影响运行时间。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'f(100000)'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// Infinity</span>
console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'f(100000)'</span><span class="token punctuation">)</span> <span class="token comment">// f(100000): 13.768ms</span>
</code></pre></div><p>  为什么仅严格模式<code>PTC</code>才会生效呢？</p> <p>  我们在非严格模式运行以下代码，注意<code>baz</code>不是尾调用。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bar<span class="token punctuation">.</span>caller <span class="token operator">===</span> foo<span class="token punctuation">)</span> <span class="token comment">// true</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bar<span class="token punctuation">.</span>arguments<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>caller <span class="token operator">===</span> foo<span class="token punctuation">)</span> <span class="token comment">// true</span>

  <span class="token keyword">return</span> x <span class="token operator">+</span> y <span class="token operator">+</span> z <span class="token comment">// A</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">bar</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// B</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">baz</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">foo</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// C</span>
<span class="token punctuation">}</span>

<span class="token function">baz</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// D</span>
</code></pre></div><p>  ;<code>bar.caller</code>将返回调用<code>bar</code>的那个函数<code>foo</code>，<code>bar.arguments.callee</code>将返回<code>bar</code>函数。</p> <p>  那么引擎是如何获取的呢？</p> <p>  对于<code>bar.caller</code>，在调用栈中引擎将根据当前栈帧（<code>bar</code>栈帧），查找到它的上一个栈帧<code>foo</code>，然后返回那个栈帧所对应的函数，即<code>foo</code>函数。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>bar context
 ├── x
 ├── y
 ├── z
 └── Line <span class="token constant">B</span>
foo context
 ├── x
 ├── y
 └── Line <span class="token constant">C</span>
baz context
 ├── x
 └── Line <span class="token constant">D</span>
global context
 ├── bar
 ├── foo
 └── baz
</code></pre></div><p>  假设<code>PTC</code>在非严格模式下支持，优化后<code>foo</code>栈帧将被删除，<code>bar</code>返回的代码行被修改为<code>C</code>。那么<code>bar.caller</code>和<code>bar.arguments.callee.caller</code>都将返回<code>baz</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>bar context
 ├── x
 ├── y
 ├── z
 └── Line <span class="token constant">C</span>
baz context
 ├── x
 └── Line <span class="token constant">D</span>
global context
 ├── bar
 ├── foo
 └── baz
</code></pre></div><p>  能够发现优化后，造成<code>bar.caller</code>和<code>bar.arguments.callee.caller</code>都失真了，显然不是我们想看到的，为了保证结果正确，如果禁用<code>func.caller</code>和<code>func.arguments</code>问题将迎刃而解。</p> <p>  而恰好，严格模式就禁用了它们，但是注意禁用不单单是因为<code>PTC</code>，还有其他原因。</p> <h3 id="主要原因"><a href="#主要原因" class="header-anchor">#</a> 主要原因</h3> <p>  既然尾递归优化如此好用，那么为何绝大多数浏览器都不支持呢？</p> <h4 id="隐式优化"><a href="#隐式优化" class="header-anchor">#</a> 隐式优化</h4> <p>  有两个主要原因，第一个原因就是隐式优化的问题，看了很多关于此问题的文章，讲的都是含糊不清，模棱两可。</p> <p>  现在来换一个角度，我来问你来答。</p> <p>  你如何确定写出了正确的尾递归？</p> <p>  你可能会说，我来一行一行检查代码，保证递归函数确实为尾部调用。</p> <p>  如果浏览器支持<code>PTC</code>，你将如何确定你的尾递归是被<code>PTC</code>优化了呢？</p> <p>  你可能会说，可以找一个没有开启<code>PTC</code>的浏览器，互相对比运行时间。</p> <p>  现在，你有没有发现，相较于你的日常开发，以上工作完全就是在浪费时间。另外为了写出正确的尾递归，你还要不断修改代码，不断调试。</p> <p>  如果你的尾递归正确，并且你也成功验证了浏览器的<code>PTC</code>优化。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>  以上代码在你的网页里时，当你打开浏览器，浏览器将无响应，且长时间处在加载状态。紧接着你将打开控制台，但是你会发现，控制台并没有任何报错，因为死循环被<code>PTC</code>优化了，将很难抛出爆栈错误。</p> <p>  那么你能否确定是资源加载慢的问题，还是别的代码有问题，还是死循环的问题等？以上代码可能还相对容易，但是代码体量大了之后，几乎很难排查出来。</p> <p>  最后一个问题，倘若浏览器不支持<code>PTC</code>，排查出原因最快多久呢？</p> <p>  哈哈，抢答，分分钟的事，浏览器抛出爆栈，很快就能定位。</p> <p>  因此概况来讲，也就是<code>隐式优化的过程是不受开发者控制和了解的</code>。</p> <h4 id="栈帧丢失"><a href="#栈帧丢失" class="header-anchor">#</a> 栈帧丢失</h4> <p>  第二个原因，由于<code>PTC</code>会删除中间帧，造成堆栈不连续，开发者在断点调试时，将难以理解执行情况。例如堆栈为<code>A B C D E F</code>（栈顶<code>F</code>），优化后为<code>A F</code>，你会非常纳闷，怎么就从函数<code>A</code>执行到函数<code>F</code>了呢。</p> <p>  其次，栈帧丢失也会影响<code>error.stack</code>的错误原因收集，进而造成客户端错误收集和分析工具失效。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>  以上代码未<code>PTC</code>优化的<code>error.stack</code>堆栈。</p> <p><img src="/js/tco/error.png" alt=""></p> <p>  ;<code>PTC</code>优化（<code>v8.6.0</code>）的<code>error.stack</code>堆栈，对比发现，<code>foo</code>栈帧已被删除。</p> <p><img src="/js/tco/error-tco.png" alt=""></p> <p>  为了解决以上<code>error.stack</code>异常堆栈缺失的问题，又衍生了另外一种机制，即用 <a href="https://bugs.webkit.org/attachment.cgi?id=274472&amp;action=review" target="_blank" rel="noopener noreferrer">shadow stack<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（影子堆栈）来恢复被删除的中间帧，为了区别，恢复的调用帧将被置为灰色。</p> <p>  在<code>Safari</code>浏览器已经实现了影子堆栈，但是，<code>V8</code>和<code>DevTools</code>团队认为，控制台的堆栈应当始终与真实情况一致，保证控制台是绝对可靠的。另外，由于是将删除的栈帧又恢复，对浏览器性能也会造成很大影响。</p> <h3 id="stc"><a href="#stc" class="header-anchor">#</a> STC</h3> <p>  由于以上原因，<code>V8</code>强烈支持用特殊语法的方式来表示<code>PTC</code>，称为语法尾调用（<code>STC</code>，<code>Syntactic Tail Calls</code>）。</p> <p>  比较好看且直观的一种语法。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 普通函数</span>
<span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">continue</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 箭头函数</span>
<span class="token keyword">const</span> <span class="token function-variable function">f</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">continue</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>  为什么更加推荐<code>STC</code>呢？</p> <p>  开发者可以确认是否写出了正确的尾递归，例如<code>return continue 1 + f()</code>的非尾递归将在编译阶段就抛出错误。另外对于尾递归死循环无响应的情况，可以通过增删关键字<code>continue</code>进一步确认。</p> <p>  因此可以说<code>STC</code>让隐式优化的过程可控了。但是栈帧丢失的问题，还是没有办法根本解决，毫无进展也是必然了（<a href="https://github.com/tc39/proposals/blob/main/inactive-proposals.md" target="_blank" rel="noopener noreferrer">已被遗弃<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</p> <h2 id="优化"><a href="#优化" class="header-anchor">#</a> 优化</h2> <p>  既然浏览器层面暂时无法实现，那就来手动优化，原理也很简单，即减少调用栈长度，防止溢出爆栈。</p> <p>  尾递归的斐波那契。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">,</span> m <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> o <span class="token operator">=</span> <span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> o
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> o<span class="token punctuation">,</span> m <span class="token operator">+</span> o<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="循环"><a href="#循环" class="header-anchor">#</a> 循环</h3> <p>  调用栈中仅包括<code>f(n)</code>一帧。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">,</span> m <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> o <span class="token operator">=</span> <span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> n<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>m<span class="token punctuation">,</span> o<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>o<span class="token punctuation">,</span> m <span class="token operator">+</span> o<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> o
<span class="token punctuation">}</span>

<span class="token function">f</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span> <span class="token comment">// 102334155</span>
<span class="token function">f</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span> <span class="token comment">// Infinity</span>
</code></pre></div><p>  缺点也很明显，递归不容易改写为循环，另外循环在语义上也不太容易理解。</p> <h3 id="蹦床函数"><a href="#蹦床函数" class="header-anchor">#</a> 蹦床函数</h3> <p>  蹦床函数<code>trampoline</code>内部为循环结构。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">trampoline</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>f <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> f <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    f <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> f
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">,</span> m <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> o <span class="token operator">=</span> <span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> o
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> o<span class="token punctuation">,</span> m <span class="token operator">+</span> o<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">trampoline</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 102334155</span>
<span class="token function">trampoline</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// Infinity</span>
</code></pre></div><p>  ;<code>f(40)</code>调用栈活动。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>			                       <span class="token function">f</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">,</span> <span class="token number">39</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token function">f</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">,</span> <span class="token number">38</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token function">f</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">,</span> <span class="token number">37</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">f</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> ___ <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">trampoline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">trampoline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">trampoline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">trampoline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">trampoline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">trampoline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">trampoline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">...</span>
</code></pre></div><p>  原理上并不是函数内继续调用函数，而是返回一个新的函数，避开了递归执行。同时不会在原函数的调用帧上创建新的调用帧，而是原函数的调用帧弹出后，新的函数帧才会入栈，堆栈将始终在一帧或两帧之间弹跳。视觉上类似弹跳蹦床，蹦床函数名称也由此而来。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>   ___   ___   ___
___   ___   ___     
</code></pre></div><p>  蹦床函数也存在一些缺点。</p> <p>  比如原递归函数要做改动，将返回值修改成返回新的函数。运行<code>f(n)</code>时，要嵌套执行<code>trampoline(f(n))</code>，不容易理解。性能上相对于原递归函数，也将会有所下降。</p> <p>  还有一个严重缺点，即只适用于返回结果为非函数的尾递归。</p> <p>  倘若递归结果就是返回一个函数。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> g
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

<span class="token function">f</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment">// ƒ g()</span>
</code></pre></div><p>  引入蹦床函数。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> g
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

<span class="token function">trampoline</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 1</span>
</code></pre></div><p>  结果不一致了，原因很简单，返回的结果由于是函数，被蹦床函数执行了。</p> <h3 id="闭包"><a href="#闭包" class="header-anchor">#</a> 闭包</h3> <p>  闭包形式的优化。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">tco</span><span class="token punctuation">(</span><span class="token parameter">func</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> value
  <span class="token keyword">var</span> active <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token keyword">const</span> accumulated <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">accumulator</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    accumulated<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      active <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>accumulated<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        value <span class="token operator">=</span> <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> accumulated<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      active <span class="token operator">=</span> <span class="token boolean">false</span>

      <span class="token keyword">return</span> value
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> f <span class="token operator">=</span> <span class="token function">tco</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">,</span> m <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> o <span class="token operator">=</span> <span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> o
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> o<span class="token punctuation">,</span> m <span class="token operator">+</span> o<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">f</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span> <span class="token comment">// 102334155</span>
<span class="token function">f</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span> <span class="token comment">// Infinity</span>
</code></pre></div><p>  ;<code>tco</code>为优化函数，返回<code>accumulator</code>函数。<code>fibonacci</code>为原始的尾递归函数，<code>f</code>为<code>tco</code>优化后的函数。</p> <p>  ;<code>tco</code>闭包保存了四个私有变量，包括<code>value</code>、<code>active</code>和<code>accumulated</code>以及参数<code>func</code>。</p> <p>  以下为<code>f(40)</code>调用栈活动，注意<code>f(n)</code>运行之前，<code>fibonacci</code>等价于<code>func</code>，<code>f</code>等价于<code>accumulator</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>                                  <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">39</span><span class="token punctuation">)</span>                                   <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">38</span><span class="token punctuation">)</span>                                   <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">37</span><span class="token punctuation">)</span>
		                <span class="token function">func</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span>  <span class="token function">func</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span>  <span class="token function">func</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span>            <span class="token function">func</span><span class="token punctuation">(</span><span class="token number">39</span><span class="token punctuation">)</span>  <span class="token function">func</span><span class="token punctuation">(</span><span class="token number">39</span><span class="token punctuation">)</span>  <span class="token function">func</span><span class="token punctuation">(</span><span class="token number">39</span><span class="token punctuation">)</span>            <span class="token function">func</span><span class="token punctuation">(</span><span class="token number">38</span><span class="token punctuation">)</span>  <span class="token function">func</span><span class="token punctuation">(</span><span class="token number">38</span><span class="token punctuation">)</span>  <span class="token function">func</span><span class="token punctuation">(</span><span class="token number">38</span><span class="token punctuation">)</span>
<span class="token function">tco</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> ___ <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span> <span class="token operator">...</span>
</code></pre></div><p>  堆栈可视化，保持在一帧到三帧之间活动。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>      ___         ___         ___
   ___   ___   ___   ___   ___   ___
___         ___         ___         ___
</code></pre></div><p>  优点为原函数不用改动，语义清晰，容易迭代。缺点也很明显，调用栈活动时间长，造成性能大幅下降。</p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <ul><li>尾调用即函数尾部调用函数，若调用自身则为尾递归</li> <li>函数改写为尾递归，可减少函数的调用次数，避免程序超时，不能解决爆栈的问题</li> <li><code>PTC</code>或<code>TCO</code>，即尾调用优化，用以消除尾调用的中间帧，防止爆栈。</li> <li>递归函数的<code>PTC</code>，即为尾递归优化</li> <li><code>PTC</code>，存在隐式优化和栈帧丢失两个主要原因。隐式优化的过程很难受开发者的控制，栈帧丢失不利于调试和错误收集</li> <li>影子堆栈可解决栈帧丢失的问题，但是非常耗费性能</li> <li><code>STC</code>，用特殊语法来表示<code>PTC</code>，可解决隐式优化的问题，但是依然不能解决栈帧丢失</li> <li>尾递归的手动优化，包括改写为循环、蹦床函数、闭包，各有优缺点</li></ul> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ul><li><a href="https://2ality.com/2015/06/tail-call-optimization.html#checking-whether-a-function-call-is-in-a-tail-position" target="_blank" rel="noopener noreferrer">哪些表达式为尾调用<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://kangax.github.io/compat-table/es6/#test-proper_tail_calls_(tail_call_optimisation)" target="_blank" rel="noopener noreferrer">PTC 兼容性<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://v8.dev/blog/modern-javascript#proper-tail-calls" target="_blank" rel="noopener noreferrer">PTC 根本原因<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/tc39/proposal-ptc-syntax" target="_blank" rel="noopener noreferrer">STC<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.zhihu.com/question/473997712" target="_blank" rel="noopener noreferrer">STC / PTC 知乎讨论<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h2 id="🎉-写在最后"><a href="#🎉-写在最后" class="header-anchor">#</a> 🎉 写在最后</h2> <p>🍻伙伴们，如果你已经看到了这里，觉得这篇文章有帮助到你的话不妨点赞👍或 <a href="https://github.com/dongwei1125/blog" target="_blank" rel="noopener noreferrer">Star<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ✨支持一下哦！</p> <p>手动码字，如有错误，欢迎在评论区指正💬~</p> <p>你的支持就是我更新的最大动力💪~</p> <p><a href="https://github.com/dongwei1125" target="_blank" rel="noopener noreferrer">GitHub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> / <a href="https://gitee.com/dongwei1125" target="_blank" rel="noopener noreferrer">Gitee<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://dongwei1125.github.io/" target="_blank" rel="noopener noreferrer">GitHub Pages<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://juejin.cn/user/2621689331987783" target="_blank" rel="noopener noreferrer">掘金<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://blog.csdn.net/Don_GW" target="_blank" rel="noopener noreferrer">CSDN<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 同步更新，欢迎关注😉~</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">3/31/2022, 9:42:00 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.0aa97f73.js" defer></script><script src="/assets/js/2.f850a8ef.js" defer></script><script src="/assets/js/53.016b1c3c.js" defer></script><script src="/assets/js/3.31ebf682.js" defer></script>
  </body>
</html>
