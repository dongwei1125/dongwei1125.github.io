<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ES6 Proxy | DonV</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/header.jpg">
    <meta name="description" content="A paper about JavaScript, HTML and CSS.">
    
    <link rel="preload" href="/assets/css/0.styles.87611319.css" as="style"><link rel="preload" href="/assets/js/app.0aa97f73.js" as="script"><link rel="preload" href="/assets/js/2.f850a8ef.js" as="script"><link rel="preload" href="/assets/js/47.a89cf7d2.js" as="script"><link rel="prefetch" href="/assets/js/10.cb041c1b.js"><link rel="prefetch" href="/assets/js/11.1aadbcee.js"><link rel="prefetch" href="/assets/js/12.77cc8e56.js"><link rel="prefetch" href="/assets/js/13.7e8162d9.js"><link rel="prefetch" href="/assets/js/14.dea6ba67.js"><link rel="prefetch" href="/assets/js/15.a786d687.js"><link rel="prefetch" href="/assets/js/16.163edf25.js"><link rel="prefetch" href="/assets/js/17.3a0232cb.js"><link rel="prefetch" href="/assets/js/18.91bd2dd7.js"><link rel="prefetch" href="/assets/js/19.a36993f8.js"><link rel="prefetch" href="/assets/js/20.30dd9f79.js"><link rel="prefetch" href="/assets/js/21.5e3c83a3.js"><link rel="prefetch" href="/assets/js/22.88d5e321.js"><link rel="prefetch" href="/assets/js/23.b54a65a7.js"><link rel="prefetch" href="/assets/js/24.51df379f.js"><link rel="prefetch" href="/assets/js/25.79342bd2.js"><link rel="prefetch" href="/assets/js/26.643d5441.js"><link rel="prefetch" href="/assets/js/27.54b7d7b4.js"><link rel="prefetch" href="/assets/js/28.d01a4aee.js"><link rel="prefetch" href="/assets/js/29.7d932073.js"><link rel="prefetch" href="/assets/js/3.31ebf682.js"><link rel="prefetch" href="/assets/js/30.4c2f5636.js"><link rel="prefetch" href="/assets/js/31.b00c42d5.js"><link rel="prefetch" href="/assets/js/32.e9a0f488.js"><link rel="prefetch" href="/assets/js/33.f510b5fd.js"><link rel="prefetch" href="/assets/js/34.6e78f32f.js"><link rel="prefetch" href="/assets/js/35.04d666a2.js"><link rel="prefetch" href="/assets/js/36.900a3beb.js"><link rel="prefetch" href="/assets/js/37.19ddf8d7.js"><link rel="prefetch" href="/assets/js/38.35f899bd.js"><link rel="prefetch" href="/assets/js/39.fe9ea525.js"><link rel="prefetch" href="/assets/js/4.3c7083a8.js"><link rel="prefetch" href="/assets/js/40.0d116ce0.js"><link rel="prefetch" href="/assets/js/41.6cdce4cf.js"><link rel="prefetch" href="/assets/js/42.ab0bd0d5.js"><link rel="prefetch" href="/assets/js/43.66c8f8eb.js"><link rel="prefetch" href="/assets/js/44.ac02981e.js"><link rel="prefetch" href="/assets/js/45.479814b0.js"><link rel="prefetch" href="/assets/js/46.29956259.js"><link rel="prefetch" href="/assets/js/48.859e3502.js"><link rel="prefetch" href="/assets/js/49.d0fa0b25.js"><link rel="prefetch" href="/assets/js/5.206809f3.js"><link rel="prefetch" href="/assets/js/50.d051084c.js"><link rel="prefetch" href="/assets/js/51.fa831e6a.js"><link rel="prefetch" href="/assets/js/52.3ed98760.js"><link rel="prefetch" href="/assets/js/53.016b1c3c.js"><link rel="prefetch" href="/assets/js/54.c88e06c5.js"><link rel="prefetch" href="/assets/js/55.937bfe09.js"><link rel="prefetch" href="/assets/js/56.03003660.js"><link rel="prefetch" href="/assets/js/57.8bcda68a.js"><link rel="prefetch" href="/assets/js/58.286692ba.js"><link rel="prefetch" href="/assets/js/59.fbfe98aa.js"><link rel="prefetch" href="/assets/js/6.6f9d9bda.js"><link rel="prefetch" href="/assets/js/60.0975844e.js"><link rel="prefetch" href="/assets/js/61.0af6cf48.js"><link rel="prefetch" href="/assets/js/62.66c23699.js"><link rel="prefetch" href="/assets/js/63.7fda9b3f.js"><link rel="prefetch" href="/assets/js/7.6f64fba1.js"><link rel="prefetch" href="/assets/js/8.a163349f.js"><link rel="prefetch" href="/assets/js/9.9058d3cc.js">
    <link rel="stylesheet" href="/assets/css/0.styles.87611319.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/header.jpg" alt="DonV" class="logo"> <span class="site-name can-hide">DonV</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/pages/js/nav.html" class="nav-link">
  JavaScript
</a></div><div class="nav-item"><a href="/pages/html/nav.html" class="nav-link">
  HTML
</a></div><div class="nav-item"><a href="/pages/css/nav.html" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/pages/other/nav.html" class="nav-link">
  其它
</a></div><div class="nav-item"><a href="/pages/app/nav.html" class="nav-link">
  应用
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="关于" class="dropdown-title"><span class="title">关于</span> <span class="arrow down"></span></button> <button type="button" aria-label="关于" class="mobile-dropdown-title"><span class="title">关于</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/dongwei1125" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/dongwei1125" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://juejin.cn/user/2621689331987783" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://blog.csdn.net/Don_GW" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.npmjs.com/~dongwei1125" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NPM
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/pages/js/nav.html" class="nav-link">
  JavaScript
</a></div><div class="nav-item"><a href="/pages/html/nav.html" class="nav-link">
  HTML
</a></div><div class="nav-item"><a href="/pages/css/nav.html" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/pages/other/nav.html" class="nav-link">
  其它
</a></div><div class="nav-item"><a href="/pages/app/nav.html" class="nav-link">
  应用
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="关于" class="dropdown-title"><span class="title">关于</span> <span class="arrow down"></span></button> <button type="button" aria-label="关于" class="mobile-dropdown-title"><span class="title">关于</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/dongwei1125" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/dongwei1125" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://juejin.cn/user/2621689331987783" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://blog.csdn.net/Don_GW" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.npmjs.com/~dongwei1125" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NPM
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>ES6 Proxy</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/js/proxy.html#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/js/proxy.html#语法" class="sidebar-link">语法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/js/proxy.html#get" class="sidebar-link">get</a></li><li class="sidebar-sub-header"><a href="/pages/js/proxy.html#set" class="sidebar-link">set</a></li><li class="sidebar-sub-header"><a href="/pages/js/proxy.html#has" class="sidebar-link">has</a></li><li class="sidebar-sub-header"><a href="/pages/js/proxy.html#deleteproperty" class="sidebar-link">deleteProperty</a></li><li class="sidebar-sub-header"><a href="/pages/js/proxy.html#ownkeys" class="sidebar-link">ownKeys</a></li><li class="sidebar-sub-header"><a href="/pages/js/proxy.html#getownpropertydescriptor" class="sidebar-link">getOwnPropertyDescriptor</a></li><li class="sidebar-sub-header"><a href="/pages/js/proxy.html#defineproperty" class="sidebar-link">defineProperty</a></li><li class="sidebar-sub-header"><a href="/pages/js/proxy.html#preventextensions" class="sidebar-link">preventExtensions</a></li><li class="sidebar-sub-header"><a href="/pages/js/proxy.html#isextensible" class="sidebar-link">isExtensible</a></li><li class="sidebar-sub-header"><a href="/pages/js/proxy.html#getprototypeof" class="sidebar-link">getPrototypeOf</a></li><li class="sidebar-sub-header"><a href="/pages/js/proxy.html#setprototypeof" class="sidebar-link">setPrototypeOf</a></li><li class="sidebar-sub-header"><a href="/pages/js/proxy.html#apply" class="sidebar-link">apply</a></li><li class="sidebar-sub-header"><a href="/pages/js/proxy.html#construct" class="sidebar-link">construct</a></li><li class="sidebar-sub-header"><a href="/pages/js/proxy.html#proxy-revocable" class="sidebar-link">Proxy.revocable</a></li></ul></li><li><a href="/pages/js/proxy.html#约束" class="sidebar-link">约束</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/js/proxy.html#内部方法" class="sidebar-link">内部方法</a></li><li class="sidebar-sub-header"><a href="/pages/js/proxy.html#对比" class="sidebar-link">对比</a></li><li class="sidebar-sub-header"><a href="/pages/js/proxy.html#不变量" class="sidebar-link">不变量</a></li><li class="sidebar-sub-header"><a href="/pages/js/proxy.html#小结-2" class="sidebar-link">小结</a></li></ul></li><li><a href="/pages/js/proxy.html#应用场景" class="sidebar-link">应用场景</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/js/proxy.html#数组负索引" class="sidebar-link">数组负索引</a></li><li class="sidebar-sub-header"><a href="/pages/js/proxy.html#隐藏内部属性" class="sidebar-link">隐藏内部属性</a></li><li class="sidebar-sub-header"><a href="/pages/js/proxy.html#创建只读对象" class="sidebar-link">创建只读对象</a></li><li class="sidebar-sub-header"><a href="/pages/js/proxy.html#支持链式属性" class="sidebar-link">支持链式属性</a></li><li class="sidebar-sub-header"><a href="/pages/js/proxy.html#属性值校验" class="sidebar-link">属性值校验</a></li><li class="sidebar-sub-header"><a href="/pages/js/proxy.html#管道" class="sidebar-link">管道</a></li><li class="sidebar-sub-header"><a href="/pages/js/proxy.html#数据监听" class="sidebar-link">数据监听</a></li></ul></li><li><a href="/pages/js/proxy.html#常见问题" class="sidebar-link">常见问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/js/proxy.html#为什么-proxy-大多与-reflect-结合使用" class="sidebar-link">为什么 Proxy 大多与 Reflect 结合使用？</a></li><li class="sidebar-sub-header"><a href="/pages/js/proxy.html#proxy-如何代理-map" class="sidebar-link">Proxy 如何代理 Map？</a></li><li class="sidebar-sub-header"><a href="/pages/js/proxy.html#polyfill-原理是什么" class="sidebar-link">Polyfill 原理是什么？</a></li><li class="sidebar-sub-header"><a href="/pages/js/proxy.html#proxy-与类型转换" class="sidebar-link">Proxy 与类型转换</a></li></ul></li><li><a href="/pages/js/proxy.html#小结-4" class="sidebar-link">小结</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/js/proxy.html#参考" class="sidebar-link">参考</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/js/proxy.html#🎉-写在最后" class="sidebar-link">🎉 写在最后</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="es6-proxy"><a href="#es6-proxy" class="header-anchor">#</a> ES6 Proxy</h1> <p><img src="/js/proxy/banner.jpg" alt=""></p> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>  全文共计<code>5</code>万字左右，大约可阅读两小时，并不定时持续更新中。</p> <p>  此文可能是关于<code>Proxy</code>相对较全的文章之一，总结了<code>Proxy</code>代理几乎所有的用法、示例和注意事项，也有对部分代码的细节分析。结合语法和<code>ECMAScript</code>规范，系统性地阐释了<code>JavaScript</code>对象的内部方法和内部槽，对比了普通对象与代理对象之间的差异和共同点。另外也包括一些运用场景，如何分析代理的错误问题，以及如何优化解决等等。</p> <p>  建议阅读中根据目录细化拆分，并试着回答以下问题。</p> <ul><li>什么是<code>trap</code>？</li> <li>内部方法与<code>trap</code>、不变量三者的关系</li> <li><code>Proxy</code>与<code>Reflect</code>之间的联系和作用</li> <li>实例如何在规范层面获取私有属性</li> <li><code>Proxy</code>的缺点和局限性</li></ul> <h2 id="语法"><a href="#语法" class="header-anchor">#</a> 语法</h2> <p>  ;<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy" target="_blank" rel="noopener noreferrer">Proxy<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 为构造函数，用于创建代理对象。参数<code>target</code>为被代理的对象，<code>handler</code>为配置对象，用于自定义不同的代理行为。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
</code></pre></div><p>  两个参数都不能为非对象，否则将抛出错误。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token comment">// Uncaught TypeError: Cannot create proxy with a non-object as target or handler</span>
</code></pre></div><p>  ;<code>Proxy</code>构造函数不能继承，原因在于<code>Proxy</code>上没有<code>prototype</code>原型属性。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">P</span> <span class="token keyword">extends</span> <span class="token class-name">Proxy</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token comment">// Uncaught TypeError: Class extends value does not have valid prototype property undefined</span>
</code></pre></div><p>  手动添加上<code>prototype</code>属性则可以继承。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">Proxy</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">P</span> <span class="token keyword">extends</span> <span class="token class-name">Proxy</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">P</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// Proxy {}</span>
</code></pre></div><h3 id="get"><a href="#get" class="header-anchor">#</a> get</h3> <p>  ;<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/get" target="_blank" rel="noopener noreferrer">get(target, property, receiver)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 用于代理对象的读取操作，包括<code>proxy[prop]</code>或者<code>proxy.prop</code>、<code>Object.create(proxy)[prop]</code>或者<code>Reflect.get(proxy, property)</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">15</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span>value <span class="token comment">// 15</span>
</code></pre></div><p>  函数参数<code>target</code>为目标对象（被代理的对象），<code>property</code>为属性名称，<code>receiver</code>为代理对象，或者继承代理对象的对象。</p> <p>  ;<code>receiver</code>为代理对象<code>proxy</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> receiver
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span>value <span class="token operator">===</span> proxy <span class="token comment">// true</span>
</code></pre></div><p>  对象<code>o</code>不存在<code>value</code>属性，将沿着原型链读取<code>proxy</code>的<code>value</code>属性，进而被<code>get</code>函数代理，<code>receiver</code>则为继承代理对象<code>proxy</code>的对象<code>o</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> receiver
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
<span class="token keyword">var</span> o <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span>

o<span class="token punctuation">.</span>value <span class="token operator">===</span> o <span class="token comment">// true</span>
</code></pre></div><p>  观察发现，在执行<code>proxy.value</code>或<code>o.value</code>时，点运算符（<code>.</code>）左边的对象是谁，<code>receiver</code>就指向谁。</p> <p>  换句话说<code>receiver</code>是触发读取操作时的对象。</p> <h3 id="set"><a href="#set" class="header-anchor">#</a> set</h3> <p>  ;<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/set" target="_blank" rel="noopener noreferrer">set(target, property, value, receiver)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 用于代理对象属性的赋值操作，包括<code>proxy.prop = value</code>或者<code>proxy[prop] = value</code>、<code>Object.create(proxy)[prop] = value</code>或者<code>Reflect.set(proxy, property, value)</code>。返回布尔值，表示是否设置成功。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    object<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">15</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">1</span>

proxy<span class="token punctuation">.</span>value <span class="token comment">// 15</span>
</code></pre></div><p>  函数参数<code>target</code>为目标对象（被代理的对象），<code>property</code>为属性名称，<code>value</code>为设置的属性值，<code>receiver</code>为代理对象，或者继承代理对象的对象。</p> <p>  ;<code>receiver</code>与<code>get</code>一致，点运算符左边的对象是谁，<code>receiver</code>就是谁，即触发赋值操作时的对象。</p> <p>  严格模式下若返回<code>false</code>，将抛出错误。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token string">'use strict'</span>

<span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">15</span>
<span class="token comment">// Uncaught TypeError: 'set' on proxy: trap returned falsish for property 'value'</span>
</code></pre></div><h3 id="has"><a href="#has" class="header-anchor">#</a> has</h3> <p>  ;<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/has" target="_blank" rel="noopener noreferrer">has(target, property)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 用于代理判断对象是否有属性，例如<code>in</code>和<code>with</code>，包括<code>prop in proxy</code>或者<code>prop in Object.create(proxy)</code>、<code>with(proxy){ prop; }</code>或者<code>with(Object.create(proxy)){ prop; }</code>、<code>Reflect.has(proxy, property)</code>。返回布尔值，表示是否有属性。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">has</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> property</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

<span class="token string">'value'</span> <span class="token keyword">in</span> proxy <span class="token comment">// true</span>
</code></pre></div><p>  参数<code>target</code>为目标对象（被代理的对象），<code>property</code>为属性名。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">has</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> property</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

<span class="token keyword">with</span> <span class="token punctuation">(</span>proxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token comment">// Uncaught TypeError: Cannot read properties of undefined (reading 'log')</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  简单分析以上代码的报错原因，执行到<code>console.log</code>语句时，引擎会确认<code>proxy</code>上是否有<code>console</code>属性。此时将调用<code>handler.has()</code>方法，默认返回<code>true</code>，表示<code>proxy</code>上存在<code>console</code>属性。</p> <p>  然后去获取<code>proxy.console</code>的属性值，即<code>undefined</code>，紧接着执行<code>undefined.log</code>，由于<code>undefined</code>上并无<code>log</code>方法，将抛出错误。</p> <p>  可选链<code>?.</code>比较适用此场景。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">with</span> <span class="token punctuation">(</span>proxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token operator">?.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="deleteproperty"><a href="#deleteproperty" class="header-anchor">#</a> deleteProperty</h3> <p>  ;<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/deleteProperty" target="_blank" rel="noopener noreferrer">deleteProperty(target, property)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 用于代理<code>delete</code>操作，包括<code>delete proxy.prop</code>或者<code>delete proxy[prop]</code>、<code>Reflect.deleteProperty(proxy, property)</code>。返回布尔值，表示是否删除成功。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">deleteProperty</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> property</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

<span class="token keyword">delete</span> proxy<span class="token punctuation">.</span>value <span class="token comment">// true</span>
</code></pre></div><p>  参数<code>target</code>为目标对象（被代理的对象），<code>property</code>为属性名。</p> <h3 id="ownkeys"><a href="#ownkeys" class="header-anchor">#</a> ownKeys</h3> <p>  ;<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/ownKeys" target="_blank" rel="noopener noreferrer">ownKeys(target)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 用于代理枚举对象属性的操作，包括。</p> <ul><li><code>for...in</code></li> <li><code>Object.keys(proxy) / Object.values(proxy) / Object.entries(proxy)</code></li> <li><code>Object.getOwnPropertyNames(proxy)</code></li> <li><code>Object.getOwnPropertySymbols(proxy)</code></li> <li><code>Reflect.ownKeys(proxy)</code></li></ul> <h4 id="for-in"><a href="#for-in" class="header-anchor">#</a> for...in</h4> <p>  ;<code>for...in</code>返回对象自身和继承的可枚举属性，不包括<code>Symbol</code>属性。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'y'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token string">'z'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

Object<span class="token punctuation">.</span><span class="token function">setPrototypeOf</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">m</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'n'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
  <span class="token comment">// x</span>
  <span class="token comment">// m</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  代理<code>for...in</code>时，有三种属性会被<code>ownKeys</code>过滤，包括。</p> <ul><li>目标对象上不存在的属性</li> <li><code>Symbol</code>属性</li> <li>目标对象上不可枚举（<code>non-enumerable</code>）的属性</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> y <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'y'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token string">'z'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">ownKeys</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string">'w'</span><span class="token punctuation">,</span> <span class="token string">'x'</span><span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token string">'z'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> proxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
  <span class="token comment">// x</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="object-keys"><a href="#object-keys" class="header-anchor">#</a> Object.keys</h4> <p>  ;<code>Object.keys</code>返回对象自身的可枚举属性，不包括<code>Symbol</code>属性。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'y'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token string">'z'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span> <span class="token comment">// ['x']</span>
</code></pre></div><p>  代理<code>Object.keys</code>时，与<code>for...in</code>一致，也会被<code>ownKeys</code>过滤。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> y <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'y'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token string">'z'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">ownKeys</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string">'w'</span><span class="token punctuation">,</span> <span class="token string">'x'</span><span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token string">'z'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span> <span class="token comment">// ['x']</span>
Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span> <span class="token comment">// [1]</span>
Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span> <span class="token comment">// [['x', 1]]</span>
</code></pre></div><p>  注意<code>Object.values</code>和<code>Object.entries</code>也会被<code>ownKeys</code>代理，且会被过滤。</p> <h4 id="object-getownpropertynames"><a href="#object-getownpropertynames" class="header-anchor">#</a> Object.getOwnPropertyNames</h4> <p>  ;<code>Object.getOwnPropertyNames</code>返回对象自身的属性，不包括<code>Symbol</code>属性。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'y'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token string">'z'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span> <span class="token comment">// ['x', 'z']</span>
</code></pre></div><p>  与<code>for...in</code>和<code>Object.keys</code>的区别在于，代理<code>Object.getOwnPropertyNames</code>可返回目标对象不存在的属性。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>

<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">ownKeys</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span> <span class="token comment">// ['x', 'y']</span>
</code></pre></div><h4 id="object-getownpropertysymbols"><a href="#object-getownpropertysymbols" class="header-anchor">#</a> Object.getOwnPropertySymbols</h4> <p>  ;<code>Object.getOwnPropertySymbols</code>返回对象自身的<code>Symbol</code>属性。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'y'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'z'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

Object<span class="token punctuation">.</span><span class="token function">getOwnPropertySymbols</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span> <span class="token comment">// [Symbol(y), Symbol(z)]</span>
</code></pre></div><p>  代理<code>Object.getOwnPropertySymbols</code>也可返回目标对象不存在的<code>Symbol</code>属性。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>

<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">ownKeys</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'y'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

Object<span class="token punctuation">.</span><span class="token function">getOwnPropertySymbols</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span> <span class="token comment">// [Symbol(x), Symbol(y)]</span>
</code></pre></div><h4 id="reflect-ownkeys"><a href="#reflect-ownkeys" class="header-anchor">#</a> Reflect.ownKeys</h4> <p>  ;<code>Reflect.ownKeys</code>返回对象自身所有属性。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'y'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token string">'z'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span> <span class="token comment">// ['x', 'z', Symbol(y)]</span>
</code></pre></div><p>  代理<code>Reflect.ownKeys</code>也可返回目标对象不存在的属性。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> y <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'y'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>

<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">ownKeys</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string">'v'</span><span class="token punctuation">,</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'w'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'x'</span><span class="token punctuation">,</span> y<span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span> <span class="token comment">// ['v', Symbol(w), 'x', Symbol(y)]</span>
</code></pre></div><h4 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h4> <table><thead><tr><th style="text-align:center;">语句</th> <th style="text-align:center;">特性</th> <th style="text-align:center;"><code>ownKeys</code>是否过滤</th> <th style="text-align:center;"><code>ownKeys</code>是否可返回目标对象不存在的属性</th></tr></thead> <tbody><tr><td style="text-align:center;"><code>for...in</code></td> <td style="text-align:center;">对象自身和继承的可枚举属性，不含<code>Symbol</code>属性</td> <td style="text-align:center;">是</td> <td style="text-align:center;">否</td></tr> <tr><td style="text-align:center;"><code>Object.keys</code></td> <td style="text-align:center;">对象自身的可枚举属性，不含<code>Symbol</code>属性</td> <td style="text-align:center;">是</td> <td style="text-align:center;">否</td></tr> <tr><td style="text-align:center;"><code>Object.getOwnPropertyNames</code></td> <td style="text-align:center;">对象自身的所有属性，不含<code>Symbol</code>属性</td> <td style="text-align:center;">否</td> <td style="text-align:center;">是</td></tr> <tr><td style="text-align:center;"><code>Object.getOwnPropertySymbols</code></td> <td style="text-align:center;">对象自身的所有<code>Symbol</code>属性</td> <td style="text-align:center;">否</td> <td style="text-align:center;">是</td></tr> <tr><td style="text-align:center;"><code>Reflect.ownKeys</code></td> <td style="text-align:center;">对象自身的所有属性</td> <td style="text-align:center;">否</td> <td style="text-align:center;">是</td></tr></tbody></table> <p>  关系图。</p> <p><img src="/js/proxy/forin.png" alt=""></p> <h3 id="getownpropertydescriptor"><a href="#getownpropertydescriptor" class="header-anchor">#</a> getOwnPropertyDescriptor</h3> <p>  ;<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/getOwnPropertyDescriptor" target="_blank" rel="noopener noreferrer">getOwnPropertyDescriptor(target, property)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 用于代理获取对象属性描述符的操作，包括<code>Object.getOwnPropertyDescriptor(proxy, prop)</code>或者<code>Reflect.getOwnPropertyDescriptor(proxy, prop)</code>、<code>Object.getOwnPropertyDescriptors(proxy)</code>。返回值为描述符对象或者<code>undefined</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> property</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span>
<span class="token comment">// {</span>
<span class="token comment">//   value: 2,</span>
<span class="token comment">//   configurable: false,</span>
<span class="token comment">//   writable: false,</span>
<span class="token comment">//   enumerable: false,</span>
<span class="token comment">// }</span>
</code></pre></div><p>  参数<code>target</code>为目标对象（被代理的对象），<code>property</code>为属性名。</p> <p>  ;<code>Object.getOwnPropertyDescriptors</code>内部依赖于<code>Object.getOwnPropertyDescriptor</code>，则也可代理<code>Object.getOwnPropertyDescriptors</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> property</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptors</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span>
<span class="token comment">// {</span>
<span class="token comment">//   x: {</span>
<span class="token comment">//     value: 2,</span>
<span class="token comment">//     configurable: true,</span>
<span class="token comment">//     writable: false,</span>
<span class="token comment">//     enumerable: false,</span>
<span class="token comment">//   },</span>
<span class="token comment">//   y: {</span>
<span class="token comment">//     value: 2,</span>
<span class="token comment">//     configurable: true,</span>
<span class="token comment">//     writable: false,</span>
<span class="token comment">//     enumerable: false,</span>
<span class="token comment">//   },</span>
<span class="token comment">// }</span>
</code></pre></div><h3 id="defineproperty"><a href="#defineproperty" class="header-anchor">#</a> defineProperty</h3> <p>  ;<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/defineProperty" target="_blank" rel="noopener noreferrer">defineProperty(target, property, descriptor)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 用于代理定义属性的操作，包括<code>Object.defineProperty(proxy, prop, descriptor)</code>或者<code>Reflect.defineProperty(proxy, prop, descriptor)</code>、<code>Object.defineProperties(proxy, descriptors)</code>、<code>proxy.prop = value</code>或者<code>proxy[prop] = value</code>。返回值为布尔值，表示操作是否成功。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> descriptor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span>
	<span class="token comment">// {</span>
	<span class="token comment">//   configurable: true,</span>
	<span class="token comment">//   enumerable: true,</span>
	<span class="token comment">//   value: 1,</span>
	<span class="token comment">//   writable: true,</span>
	<span class="token comment">// }</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">1</span>
</code></pre></div><p>  参数<code>target</code>为目标对象（被代理的对象），<code>property</code>为属性名，<code>descriptor</code>为属性描述符。</p> <p>  若<code>handler</code>中<code>set</code>与<code>defineProperty</code>都存在，将优先执行<code>set</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> descriptor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'defineProperty'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'set'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment">// 'set'</span>
</code></pre></div><p>  与<code>set</code>一致，严格模式下若返回<code>false</code>，将抛出错误。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token string">'use strict'</span>

<span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> descriptor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment">// Uncaught TypeError: 'defineProperty' on proxy: trap returned falsish for property 'value'</span>
</code></pre></div><h3 id="preventextensions"><a href="#preventextensions" class="header-anchor">#</a> preventExtensions</h3> <p>  ;<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/preventExtensions" target="_blank" rel="noopener noreferrer">preventExtensions(target)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 用于代理阻止对象拓展的操作，包括<code>Object.preventExtensions(proxy)</code>或者<code>Reflect.preventExtensions(proxy)</code>。返回布尔值，表示阻止成功。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">preventExtensions</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'preventExtensions'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">preventExtensions</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

Object<span class="token punctuation">.</span><span class="token function">preventExtensions</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span>
<span class="token comment">// 'preventExtensions'</span>
</code></pre></div><h3 id="isextensible"><a href="#isextensible" class="header-anchor">#</a> isExtensible</h3> <p>  ;<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/isExtensible" target="_blank" rel="noopener noreferrer">isExtensible(target)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 用于代理判断对象是否可拓展的操作，包括<code>Object.isExtensible(proxy)</code>或者<code>Reflect.isExtensible(proxy)</code>。返回值将转换为布尔值，表示是否可拓展。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">isExtensible</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

Object<span class="token punctuation">.</span><span class="token function">isExtensible</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span> <span class="token comment">// true</span>
</code></pre></div><h3 id="getprototypeof"><a href="#getprototypeof" class="header-anchor">#</a> getPrototypeOf</h3> <p>  ;<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/getPrototypeOf" target="_blank" rel="noopener noreferrer">getPrototypeOf(target)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 用于代理获取对象原型的操作，包括。</p> <ul><li><code>Object.getPrototypeOf(proxy)</code></li> <li><code>Reflect.getPrototypeOf(proxy)</code></li> <li><code>proxy.__proto__</code></li> <li><code>Object.prototype.isPrototypeOf(proxy)</code></li> <li><code>proxy instanceof Object</code></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">getPrototypeOf</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Number</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span> <span class="token comment">// Number {1}</span>
Reflect<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span> <span class="token comment">// Number {1}</span>
proxy<span class="token punctuation">.</span>__proto__ <span class="token comment">// Number {1}</span>
<span class="token class-name">Number</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">isPrototypeOf</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span> <span class="token comment">// true</span>
proxy <span class="token keyword">instanceof</span> <span class="token class-name">Number</span> <span class="token comment">// true</span>
</code></pre></div><h3 id="setprototypeof"><a href="#setprototypeof" class="header-anchor">#</a> setPrototypeOf</h3> <p>  ;<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/setPrototypeOf" target="_blank" rel="noopener noreferrer">setPrototypeOf(target, prototype)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 用于代理设置原型的操作，包括<code>Object.setPrototypeOf(proxy, prototype)</code>或者<code>Reflect.setPrototypeOf(proxy, prototype)</code>。返回布尔值，表示是否设置成功。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">setPrototypeOf</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> prototype</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

Reflect<span class="token punctuation">.</span><span class="token function">setPrototypeOf</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
</code></pre></div><p>  参数<code>target</code>为目标对象（被代理的对象），<code>prototype</code>为原型对象或者<code>null</code>。</p> <h3 id="apply"><a href="#apply" class="header-anchor">#</a> apply</h3> <p>  ;<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/apply" target="_blank" rel="noopener noreferrer">apply(target, thisArg, args)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 用于代理函数的普通调用，包括<code>proxy(args)</code>、<code>proxy.call(thisArg, args)</code>或者<code>proxy.apply(thisArg, args)</code>、<code>Reflect.apply(proxy, thisArg, args)</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> <span class="token function-variable function">func</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> x <span class="token operator">+</span> y
<span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> thisArg<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">Reflect</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> thisArg<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

<span class="token function">proxy</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 9</span>
<span class="token function">proxy</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment">// 21</span>
<span class="token function">Reflect</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 33</span>
</code></pre></div><p>  参数<code>target</code>为目标对象（被代理的对象），<code>thisArg</code>为被调用时的上下文对象<code>this</code>，<code>args</code>为被调用时的参数数组。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 21</span>
</code></pre></div><p>  分析以上语句，也就是<code>Function.prototype.apply</code>函数执行了<code>call</code>方法，函数内部<code>this</code>指向了<code>proxy</code>，参数为<code>null</code> <code>[3, 4]</code>，即<code>Function.prototype.apply(null, [3, 4])</code>（内部<code>this</code>为<code>proxy</code>），等价于运行<code>proxy.apply(null, [3, 4])</code>。</p> <h3 id="construct"><a href="#construct" class="header-anchor">#</a> construct</h3> <p>  ;<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/construct" target="_blank" rel="noopener noreferrer">construct(target, args, newTarget)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 用于代理构造函数的<code>new</code>调用，包括<code>new proxy(args)</code>或者<code>Reflect.construct(proxy, args, newTarget)</code>。返回值为对象。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> <span class="token function-variable function">F</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x
  <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y
<span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">construct</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> args<span class="token punctuation">,</span> newTarget</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newTarget <span class="token operator">===</span> Ctr<span class="token punctuation">)</span> <span class="token comment">// true</span>

    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">construct</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> args<span class="token punctuation">,</span> newTarget<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> Ctr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token constant">F</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

<span class="token keyword">new</span> <span class="token class-name">Ctr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// F {x: 1, y: 2}</span>
</code></pre></div><p>  参数<code>target</code>为目标对象（被代理的对象），<code>args</code>为被调用时的参数数组，<code>newTarget</code>为<code>new</code>命令作用的构造函数。</p> <h3 id="proxy-revocable"><a href="#proxy-revocable" class="header-anchor">#</a> Proxy.revocable</h3> <p>  ;<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/revocable" target="_blank" rel="noopener noreferrer">Proxy.revocable<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 用于创建可撤销的代理对象。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> revocable <span class="token operator">=</span> Proxy<span class="token punctuation">.</span><span class="token function">revocable</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
</code></pre></div><p>  返回值为对象，包括<code>proxy</code>和<code>revoke</code>属性，<code>proxy</code>为新生成的代理对象，<code>revoke</code>为撤销代理的方法。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">1</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> <span class="token punctuation">{</span> proxy<span class="token punctuation">,</span> revoke <span class="token punctuation">}</span> <span class="token operator">=</span> Proxy<span class="token punctuation">.</span><span class="token function">revocable</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span>
<span class="token comment">// {</span>
<span class="token comment">//   [[Handler]]: Object,</span>
<span class="token comment">//   [[Target]]: Object,</span>
<span class="token comment">//   [[IsRevoked]]: false,</span>
<span class="token comment">// }</span>

<span class="token function">revoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span>
<span class="token comment">// {</span>
<span class="token comment">//   [[Handler]]: null,</span>
<span class="token comment">//   [[Target]]: null,</span>
<span class="token comment">//   [[IsRevoked]]: true,</span>
<span class="token comment">// }</span>
</code></pre></div><p>  代理对象被撤销后，执行任何的可代理操作都将抛出错误。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">1</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> <span class="token punctuation">{</span> proxy<span class="token punctuation">,</span> revoke <span class="token punctuation">}</span> <span class="token operator">=</span> Proxy<span class="token punctuation">.</span><span class="token function">revocable</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span>value <span class="token comment">// 1</span>

<span class="token function">revoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span>value <span class="token comment">// Uncaught TypeError: Cannot perform 'get' on a proxy that has been revoked</span>
</code></pre></div><h2 id="约束"><a href="#约束" class="header-anchor">#</a> 约束</h2> <h3 id="内部方法"><a href="#内部方法" class="header-anchor">#</a> 内部方法</h3> <p>  ;<code>JavaScript</code>中创建的对象，会被引擎赋予很多 <a href="https://262.ecma-international.org/13.0/#sec-object-internal-methods-and-internal-slots" target="_blank" rel="noopener noreferrer">内部方法<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，在开发者层面是不可见的。</p> <p>  普通对象上共有<code>11</code>个内部方法。</p> <ul><li><code>[[GetPrototypeOf]]()</code></li> <li><code>[[SetPrototypeOf]](V)</code></li> <li><code>[[IsExtensible]]()</code></li> <li><code>[[PreventExtensions]]()</code></li> <li><code>[[GetOwnProperty]](P)</code></li> <li><code>[[DefineOwnProperty]](P, Desc)</code></li> <li><code>[[HasProperty]](P)</code></li> <li><code>[[Get]](P, Receiver)</code></li> <li><code>[[Set]](P, V, Receiver)</code></li> <li><code>[[Delete]](P)</code></li> <li><code>[[OwnPropertyKeys]]()</code></li></ul> <p>  内部方法什么时候执行呢？</p> <p>  举个例子，在删除对象属性时，引擎会去执行对象上的<code>[[Delete]](P)</code>内部方法。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">delete</span> object<span class="token punctuation">.</span>prop
</code></pre></div><p>  函数作为一类特殊对象，还拓展了部分内部方法。在普通调用时，引擎会去执行<code>[[Call]]</code>内部方法。作为构造函数，被<code>new</code>调用时，引擎会去执行<code>[[Construct]]</code>内部方法。</p> <p>  例如箭头函数只拓展了<code>[[Call]]</code>，没有拓展<code>[[Construct]]</code>内部方法。因此只能普通调用，不能通过<code>new</code>调用，实际也就是箭头函数不能作为构造函数的根本原因。</p> <h3 id="对比"><a href="#对比" class="header-anchor">#</a> 对比</h3> <p>  那开发者能调用内部方法吗？</p> <p>  答案是不能，内部方法是引擎层面的东西。</p> <p>  虽然不能调用，但是有替代实现，即<code>ES6</code>新引入的<code>Proxy</code>代理函数。我们可以用<code>JavaScript</code>代码，自定义刚刚那<code>13</code>个内部方法。</p> <p>  以获取属性值为例，对比普通对象和代理对象的差异。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
object<span class="token punctuation">.</span>value

<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
proxy<span class="token punctuation">.</span>value
</code></pre></div><p>  普通对象在获取属性值时，引擎会去执行对象上的<code>[[Get]](P, Receiver)</code>内部方法。而代理对象在获取属性值时，将会去执行<code>handler</code>对象上的<code>get</code>方法。</p> <p><img src="/js/proxy/get.png" alt=""></p> <p>  ;<code>handler</code>对象中的<code>13</code>个方法刚好对应了引擎层面的<code>13</code>个内部方法。</p> <table><thead><tr><th style="text-align:center;"><code>Handler Method</code></th> <th style="text-align:center;"><code>Internal Method</code></th></tr></thead> <tbody><tr><td style="text-align:center;"><code>getPrototypeOf</code></td> <td style="text-align:center;"><code>[[GetPrototypeOf]]()</code></td></tr> <tr><td style="text-align:center;"><code>setPrototypeOf</code></td> <td style="text-align:center;"><code>[[SetPrototypeOf]](V)</code></td></tr> <tr><td style="text-align:center;"><code>isExtensible</code></td> <td style="text-align:center;"><code>[[IsExtensible]]()</code></td></tr> <tr><td style="text-align:center;"><code>preventExtensions</code></td> <td style="text-align:center;"><code>[[PreventExtensions]]()</code></td></tr> <tr><td style="text-align:center;"><code>getOwnPropertyDescriptor</code></td> <td style="text-align:center;"><code>[[GetOwnProperty]](P)</code></td></tr> <tr><td style="text-align:center;"><code>defineProperty</code></td> <td style="text-align:center;"><code>[[DefineOwnProperty]](P, Desc)</code></td></tr> <tr><td style="text-align:center;"><code>has</code></td> <td style="text-align:center;"><code>[[HasProperty]](P)</code></td></tr> <tr><td style="text-align:center;"><code>get</code></td> <td style="text-align:center;"><code>[[Get]](P, Receiver)</code></td></tr> <tr><td style="text-align:center;"><code>set</code></td> <td style="text-align:center;"><code>[[Set]](P, V, Receiver)</code></td></tr> <tr><td style="text-align:center;"><code>deleteProperty</code></td> <td style="text-align:center;"><code>[[Delete]](P)</code></td></tr> <tr><td style="text-align:center;"><code>ownKeys</code></td> <td style="text-align:center;"><code>[[OwnPropertyKeys]]()</code></td></tr> <tr><td style="text-align:center;"><code>apply</code></td> <td style="text-align:center;"><code>[[Call]]</code></td></tr> <tr><td style="text-align:center;"><code>construct</code></td> <td style="text-align:center;"><code>[[Construct]]</code></td></tr></tbody></table> <h3 id="不变量"><a href="#不变量" class="header-anchor">#</a> 不变量</h3> <p>  你可能发现了图示中的<code>invariant</code>，是什么东西呢？</p> <p>  ;<code>ECMA-262</code>规范中的第 <a href="https://262.ecma-international.org/13.0/#sec-invariants-of-the-essential-internal-methods" target="_blank" rel="noopener noreferrer">6.1.7.3<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 小节给出了答案。</p> <blockquote><p><code>6.1.7.3 Invariants of the Essential Internal Methods</code><br> <code>The Internal Methods of Objects of an ECMAScript engine must conform to the list of invariants specified below. Ordinary ECMAScript Objects as well as all standard exotic objects in this specification maintain these invariants. <strong>ECMAScript Proxy objects maintain these invariants by means of runtime checks on the result of traps invoked on the [[ProxyHandler]] object.</strong></code><br> <code>Any implementation provided exotic objects must also maintain these invariants for those objects. Violation of these invariants may cause ECMAScript code to have unpredictable behaviour and create security issues. However, violation of these invariants must never compromise the memory safety of an implementation.</code></p></blockquote> <p>  大致语义为，<code>ECMAScript</code>中内部方法有一些限制规则，称之为不变量（<code>invariant</code>）。目的是为了避免代码出现不可预测的行为从而导致产生安全问题。</p> <p>  我们来细读规范中<code>[[Construct]]()</code>的不变量。</p> <blockquote><p><code>[[Construct]]()</code><br> <code>The normal return type is Object.</code><br> <code>The target must also have a [[Call]] internal method.</code></p></blockquote> <p>  第一条是方法返回类型必须为对象，第二条是目标对象必须有<code>[[Call]]</code>内部方法。</p> <p>  接着再来看看刚才引用中加粗的部分，什么意思呢？</p> <p>  即是说<code>ECMAScript</code>代理对象在运行<code>trap</code>时，会检测返回结果是否符合对应的不变量，以保持与内部方法的统一性。</p> <blockquote><p><code>trap</code>，即<code>Handler Method</code>，也就是配置对象<code>handler</code>上的方法</p></blockquote> <p>  换句话说，不管是内部方法（<code>Internal Method</code>）还是代理方法（<code>Handler Method</code>），都要符合规范中特定的不变量。</p> <p>  所以<code>handler.construct()</code>方法也要符合<code>[[Construct]]()</code>的不变量，例如第一条中返回值必须为对象。在运行时，不符合将抛出错误。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">1</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> <span class="token constant">P</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

<span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">P</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// Uncaught TypeError: 'construct' on proxy: trap returned non-object ('1')</span>
</code></pre></div><h4 id="get-2"><a href="#get-2" class="header-anchor">#</a> get</h4> <p>  若目标对象的属性是不可配置（<code>non-configurable</code>）且不可写（<code>non-writable</code>）的，则返回值必须与目标对象的属性值相同。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">3</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span>value
<span class="token comment">// Uncaught TypeError: 'get' on proxy: property 'value' is a read-only and non-configurable data property on the proxy target but the proxy did not return its actual value (expected '2' but got '3')</span>
</code></pre></div><p>  若目标对象的属性为不可配置（<code>non-configurable</code>）且没有<code>get</code>描述符，则返回值必须为<code>undefined</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">3</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span>value
<span class="token comment">// Uncaught TypeError: 'get' on proxy: property 'value' is a non-configurable accessor property on the proxy target and does not have a getter function, but the trap did not return 'undefined' (got '3')</span>
</code></pre></div><p>  个人认为，属性为不可配置且不可写，或者为不可配置且没有<code>get</code>，获取属性值时都将返回固定值。而属性读取的代理操作，实际也就没有意义，为了一致性则约束返回值与原值相同。</p> <h4 id="set-2"><a href="#set-2" class="header-anchor">#</a> set</h4> <p>  若目标对象的属性是不可配置（<code>non-configurable</code>）且不可写（<code>non-writable</code>）的，则必须返回<code>false</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">15</span>
<span class="token comment">// Uncaught TypeError: 'set' on proxy: trap returned truish for property 'value' which exists in the proxy target as a non-configurable and non-writable data property with a different value</span>
</code></pre></div><p>  若目标对象的属性为不可配置（<code>non-configurable</code>）且没有<code>set</code>描述符，则必须返回<code>false</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">15</span>
<span class="token comment">// Uncaught TypeError: 'set' on proxy: trap returned truish for property 'value' which exists in the proxy target as a non-configurable and non-writable accessor property without a setter</span>
</code></pre></div><p>  类似的，属性为不可配置且不可写，或者为不可配置且没有<code>set</code>，都意味着原对象的属性值无法修改。而属性修改的代理操作，无论如何都不会成功，为了一致性则必须返回<code>false</code>。</p> <h4 id="has-2"><a href="#has-2" class="header-anchor">#</a> has</h4> <p>  若目标对象的属性为不可配置（<code>non-configurable</code>），则必须返回<code>true</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">has</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> property</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

<span class="token string">'value'</span> <span class="token keyword">in</span> proxy
<span class="token comment">// Uncaught TypeError: 'has' on proxy: trap returned falsish for property 'value' which exists in the proxy target as non-configurable</span>
</code></pre></div><p>  属性为不可配置，原对象的属性不可能被删除，也就意味着原对象肯定有此属性。而是否有此属性的代理操作，也就没有任何意义了，为了一致性则必须返回<code>true</code>。</p> <h4 id="deleteproperty-2"><a href="#deleteproperty-2" class="header-anchor">#</a> deleteProperty</h4> <p>  若目标对象的属性为不可配置（<code>non-configurable</code>），则必须返回<code>false</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">deleteProperty</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> property</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

<span class="token keyword">delete</span> proxy<span class="token punctuation">.</span>value
<span class="token comment">// Uncaught TypeError: 'deleteProperty' on proxy: trap returned truish for property 'value' which is non-configurable in the proxy target</span>
</code></pre></div><p>  属性为不可配置，原对象的属性不可能被删除，而删除属性的代理操作，无论如何都不会成功，为了一致性则必须返回<code>false</code>。</p> <h4 id="ownkeys-2"><a href="#ownkeys-2" class="header-anchor">#</a> ownKeys</h4> <p>  返回的结果列表中，必须要包含所有不可配置（<code>non-configurable</code>）的自身属性。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">ownKeys</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span>
<span class="token comment">// Uncaught TypeError: 'ownKeys' on proxy: trap result did not include 'x'</span>
</code></pre></div><p>  若目标对象不可拓展，则必须返回所有的自身属性。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>

Object<span class="token punctuation">.</span><span class="token function">preventExtensions</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span>

<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">ownKeys</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span>
<span class="token comment">// Uncaught TypeError: 'ownKeys' on proxy: trap result did not include 'x'</span>
</code></pre></div><p>  并且不可返回目标对象不存在的属性。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

Object<span class="token punctuation">.</span><span class="token function">preventExtensions</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span>

<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">ownKeys</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span>
<span class="token comment">// Uncaught TypeError: 'ownKeys' on proxy: trap returned extra keys but proxy target is non-extensible</span>
</code></pre></div><h4 id="getownpropertydescriptor-2"><a href="#getownpropertydescriptor-2" class="header-anchor">#</a> getOwnPropertyDescriptor</h4> <p>  若目标对象的属性为不可配置（<code>non-configurable</code>），不可返回<code>undefined</code>，必须返回属性描述符。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> property</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">undefined</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span>
<span class="token comment">// Uncaught TypeError: 'getOwnPropertyDescriptor' on proxy: trap returned undefined for property 'value' which is non-configurable in the proxy target</span>
</code></pre></div><p>  并且描述符必须与目标对象的一致。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> property</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span>
<span class="token comment">// Uncaught TypeError: 'getOwnPropertyDescriptor' on proxy: trap returned descriptor for property 'value' that is incompatible with the existing property in the proxy target</span>
</code></pre></div><p>  若目标对象的属性可配置，返回的属性描述符中<code>configurable</code>必须为<code>true</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> property</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span>
<span class="token comment">// Uncaught TypeError: 'getOwnPropertyDescriptor' on proxy: trap reported non-configurability for property 'value' which is either non-existent or configurable in the proxy target</span>
</code></pre></div><p>  若目标对象的属性不存在，返回的属性描述符中<code>configurable</code>必须为<code>true</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> property</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span>
<span class="token comment">// Uncaught TypeError: 'getOwnPropertyDescriptor' on proxy: trap reported non-configurability for property 'value' which is either non-existent or configurable in the proxy target</span>
</code></pre></div><p>  若目标对象不可拓展，且属性存在，不可返回<code>undefined</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>

Object<span class="token punctuation">.</span><span class="token function">preventExtensions</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span>

<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> property</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">undefined</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span>
<span class="token comment">// Uncaught TypeError: 'getOwnPropertyDescriptor' on proxy: trap returned undefined for property 'value' which exists in the non-extensible proxy target</span>
</code></pre></div><p>  若目标对象不可拓展，且属性不存在，必须返回<code>undefined</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

Object<span class="token punctuation">.</span><span class="token function">preventExtensions</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span>

<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> property</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span>
<span class="token comment">// Uncaught TypeError: 'getOwnPropertyDescriptor' on proxy: trap returned descriptor for property 'value' that is incompatible with the existing property in the proxy target</span>
</code></pre></div><h4 id="defineproperty-2"><a href="#defineproperty-2" class="header-anchor">#</a> defineProperty</h4> <p>  若目标对象不可拓展，必须返回<code>false</code>，表示不可添加新属性。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

Object<span class="token punctuation">.</span><span class="token function">preventExtensions</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span>

<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> descriptor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment">// Uncaught TypeError: 'defineProperty' on proxy: trap returned truish for adding property 'value'  to the non-extensible proxy target</span>
</code></pre></div><p>  若目标对象的属性不存在，定义的属性描述符<code>configurable</code>必须为<code>true</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> descriptor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// Uncaught TypeError: 'defineProperty' on proxy: trap returned truish for defining non-configurable property 'value' which is either non-existent or configurable in the proxy target</span>
</code></pre></div><p>  若目标对象的属性为可配置（<code>configurable</code>），定义的属性描述符<code>configurable</code>必须为<code>true</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> descriptor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// Uncaught TypeError: 'defineProperty' on proxy: trap returned truish for defining non-configurable property 'value' which is either non-existent or configurable in the proxy target</span>
</code></pre></div><h4 id="preventextensions-2"><a href="#preventextensions-2" class="header-anchor">#</a> preventExtensions</h4> <p>  若目标对象是可拓展的，必须返回<code>false</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">preventExtensions</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

Object<span class="token punctuation">.</span><span class="token function">preventExtensions</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span>
<span class="token comment">// Uncaught TypeError: 'preventExtensions' on proxy: trap returned truish but the proxy target is extensible</span>
</code></pre></div><h4 id="isextensible-2"><a href="#isextensible-2" class="header-anchor">#</a> isExtensible</h4> <p>  ;<code>Object.isExtensible(proxy)</code>返回值必须与<code>Object.isExtensible(target)</code>一致。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">isExtensible</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

Object<span class="token punctuation">.</span><span class="token function">isExtensible</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span>
<span class="token comment">// Uncaught TypeError: 'isExtensible' on proxy: trap result does not reflect extensibility of proxy target (which is 'true')</span>
</code></pre></div><h4 id="getprototypeof-2"><a href="#getprototypeof-2" class="header-anchor">#</a> getPrototypeOf</h4> <p>  若目标对象不可拓展，必须返回目标对象的实际原型。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

Object<span class="token punctuation">.</span><span class="token function">preventExtensions</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span>

<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">getPrototypeOf</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span>
<span class="token comment">// Uncaught TypeError: 'getPrototypeOf' on proxy: proxy target is non-extensible but the trap did not return its actual prototype</span>
</code></pre></div><p>  对象不可拓展，不能修改原型的指向，也就意味着原型是固定的。而代理获取原型的操作，也就没有任何意义了，为了一致性则必须返回对象的实际原型。</p> <h4 id="setprototypeof-2"><a href="#setprototypeof-2" class="header-anchor">#</a> setPrototypeOf</h4> <p>  若目标对象不可拓展，必须返回<code>false</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

Object<span class="token punctuation">.</span><span class="token function">preventExtensions</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span>

<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">setPrototypeOf</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> prototype</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

Reflect<span class="token punctuation">.</span><span class="token function">setPrototypeOf</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// Uncaught TypeError: 'setPrototypeOf' on proxy: trap returned truish for setting a new prototype on the non-extensible proxy target</span>
</code></pre></div><p>  目标对象不可拓展，不能修改原型指向。而代理设置原型的操作，无论如何都不会成功，为了一致性则必须返回<code>false</code>。</p> <h4 id="apply-2"><a href="#apply-2" class="header-anchor">#</a> apply</h4> <p>  无。</p> <h4 id="construct-2"><a href="#construct-2" class="header-anchor">#</a> construct</h4> <p>  必须返回对象。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> <span class="token function-variable function">F</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">construct</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> thisArg<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">1</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> Ctr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token constant">F</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

<span class="token keyword">new</span> <span class="token class-name">Ctr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// Uncaught TypeError: 'construct' on proxy: trap returned non-object ('1')</span>
</code></pre></div><h3 id="小结-2"><a href="#小结-2" class="header-anchor">#</a> 小结</h3> <table><thead><tr><th><code>Handler Method</code></th> <th>代理行为</th> <th>不变量</th></tr></thead> <tbody><tr><td><code>get(target, property, receiver)</code></td> <td align="left"><ul><li><code>proxy[prop]</code></li> <li><code>proxy.prop</code></li> <li><code>Object.create(proxy)[prop]</code></li> <li><code>Reflect.get(proxy, property)</code></li></ul></td> <td align="left"><ul><li>目标对象属性不可配置且不可写，返回值必须与目标对象的属性值相同</li> <li>目标对象属性不可配置且无<code>get</code>描述符，返回值必须为<code>undefined</code></li></ul></td></tr> <tr><td><code>set(target, property, value, receiver)</code></td> <td align="left"><ul><li><code>proxy.prop = value</code></li> <li><code>proxy[prop] = value</code></li> <li><code>Object.create(proxy)[prop] = value</code></li> <li><code>Reflect.set(proxy, property, value)</code></li></ul></td> <td align="left"><ul><li>目标对象属性不可配置且不可写，必须返回<code>false</code></li> <li>目标对象属性不可配置且无<code>set</code>描述符，必须返回<code>false</code></li></ul></td></tr> <tr><td><code>has(target, property)</code></td> <td align="left"><ul><li><code>prop in proxy</code></li> <li><code>prop in Object.create(proxy)</code></li> <li><code>with(proxy){ prop; }</code></li> <li><code>with(Object.create(proxy)){ prop; }</code></li> <li><code>Reflect.has(proxy, property)</code></li></ul></td> <td align="left"><ul><li>目标对象属性不可配置，必须返回<code>true</code></li></ul></td></tr> <tr><td><code>deleteProperty(target, property)</code></td> <td align="left"><ul><li><code>delete proxy.prop</code></li> <li><code>delete proxy[prop]</code></li> <li><code>Reflect.deleteProperty(proxy, property)</code></li></ul></td> <td align="left"><ul><li>目标对象属性不可配置，必须返回<code>false</code></li></ul></td></tr> <tr><td><code>ownKeys(target)</code></td> <td align="left"><ul><li><code>for...in</code></li> <li><code>Object.keys(proxy) / Object.values(proxy) / Object.entries(proxy)</code></li> <li><code>Object.getOwnPropertyNames(proxy)</code></li> <li><code>Object.getOwnPropertySymbols(proxy)</code></li> <li><code>Reflect.ownKeys(proxy)</code></li></ul></td> <td align="left"><ul><li>返回的结果列表，必须包含所有不可配置的自身属性</li> <li>目标对象不可拓展，必须返回所有的自身属性，且不可返回目标对象不存在的属性</li></ul></td></tr> <tr><td><code>getOwnPropertyDescriptor(target, property)</code></td> <td align="left"><ul><li><code>Object.getOwnPropertyDescriptor(proxy, prop)</code></li> <li><code>Reflect.getOwnPropertyDescriptor(proxy, prop)</code></li> <li><code>Object.getOwnPropertyDescriptors(proxy)</code></li></ul></td> <td align="left"><ul><li>
            目标对象属性不可配置，不可返回<code>undefined</code>，必须返回属性描述符，且描述符必须与目标对象的一致
          </li> <li>目标对象属性可配置，返回的属性描述符中<code>configurable</code>必须为<code>true</code></li> <li>目标对象属性不存在，返回的属性描述符中<code>configurable</code>必须为<code>true</code></li> <li>目标对象不可拓展，且属性存在，不可返回<code>undefined</code></li> <li>目标对象不可拓展，且属性不存在，必须返回<code>undefined</code></li></ul></td></tr> <tr><td><code>defineProperty(target, property, descriptor)</code></td> <td align="left"><ul><li><code>Object.defineProperty(proxy, prop, descriptor)</code></li> <li><code>Reflect.defineProperty(proxy, prop, descriptor)</code></li> <li><code>Object.defineProperties(proxy, descriptors)</code></li> <li><code>proxy.prop = value</code></li> <li><code>proxy[prop] = value</code></li></ul></td> <td align="left"><ul><li>目标对象不可拓展，必须返回<code>false</code>，即不可添加新属性</li> <li>目标对象属性不存在，定义的属性描述符<code>configurable</code>必须为<code>true</code></li> <li>目标对象属性可配置，定义的属性描述符<code>configurable</code>必须为<code>true</code></li></ul></td></tr> <tr><td><code>preventExtensions(target)</code></td> <td align="left"><ul><li><code>Object.preventExtensions(proxy)</code></li> <li><code>Reflect.preventExtensions(proxy)</code></li></ul></td> <td align="left"><ul><li>目标对象可拓展，必须返回<code>false</code></li></ul></td></tr> <tr><td><code>isExtensible(target)</code></td> <td align="left"><ul><li><code>Object.isExtensible(proxy)</code></li> <li><code>Reflect.isExtensible(proxy)</code></li></ul></td> <td align="left"><ul><li><code>Object.isExtensible(proxy)</code>返回值必须与<code>Object.isExtensible(target)</code>一致
          </li></ul></td></tr> <tr><td><code>getPrototypeOf(target)</code></td> <td align="left"><ul><li><code>Object.getPrototypeOf(proxy)</code></li> <li><code>Reflect.getPrototypeOf(proxy)</code></li> <li><code>proxy.__proto__</code></li> <li><code>Object.prototype.isPrototypeOf(proxy)</code></li> <li><code>proxy instanceof Object</code></li></ul></td> <td align="left"><ul><li>目标对象不可拓展，必须返回目标对象的实际原型</li></ul></td></tr> <tr><td><code>setPrototypeOf(target, prototype)</code></td> <td align="left"><ul><li><code>Object.setPrototypeOf(proxy, prototype)</code></li> <li><code>Reflect.setPrototypeOf(proxy, prototype)</code></li></ul></td> <td align="left"><ul><li>目标对象不可拓展，必须返回<code>false</code></li></ul></td></tr> <tr><td><code>apply(target, thisArg, args)</code></td> <td align="left"><ul><li><code>proxy(args)</code></li> <li><code>proxy.call(thisArg, args)</code></li> <li><code>proxy.apply(thisArg, args)</code></li> <li><code>Reflect.apply(proxy, thisArg, args)</code></li></ul></td> <td>-</td></tr> <tr><td><code>construct(target, args, newTarget)</code></td> <td align="left"><ul><li><code>new proxy(args)</code></li> <li><code>Reflect.construct(proxy, args, newTarget)</code></li></ul></td> <td align="left"><ul><li>必须返回对象</li></ul></td></tr></tbody></table> <h2 id="应用场景"><a href="#应用场景" class="header-anchor">#</a> 应用场景</h2> <h3 id="数组负索引"><a href="#数组负索引" class="header-anchor">#</a> 数组负索引</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">negative</span><span class="token punctuation">(</span><span class="token parameter">array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> property <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">&amp;&amp;</span> property <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        property <span class="token operator">=</span> target<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token function">Number</span><span class="token punctuation">(</span>property<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> array <span class="token operator">=</span> <span class="token function">negative</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
array<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token comment">// 3</span>
</code></pre></div><h3 id="隐藏内部属性"><a href="#隐藏内部属性" class="header-anchor">#</a> 隐藏内部属性</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>property<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'_'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">undefined</span>

    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span>_id <span class="token comment">// undefined</span>
</code></pre></div><h3 id="创建只读对象"><a href="#创建只读对象" class="header-anchor">#</a> 创建只读对象</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">readonly</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">deleteProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">setPrototypeOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token function">readonly</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
object<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">2</span>

object<span class="token punctuation">.</span>value <span class="token comment">// 1</span>
</code></pre></div><blockquote><p>参考 <a href="https://cn.vuejs.org/api/reactivity-core.html#readonly" target="_blank" rel="noopener noreferrer">vue<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 响应式<code>api</code>核心方法 <a href="https://github.com/vuejs/core/blob/v3.2.41/packages/reactivity/src/baseHandlers.ts#L222" target="_blank" rel="noopener noreferrer">readonly<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 创建只读代理</p></blockquote> <h3 id="支持链式属性"><a href="#支持链式属性" class="header-anchor">#</a> 支持链式属性</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">chaining</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> property<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">chaining</span><span class="token punctuation">(</span><span class="token punctuation">(</span>target <span class="token operator">??</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">[</span>property<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> target
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span> <span class="token comment">// {x: 1}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>object<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token comment">// 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>object<span class="token punctuation">.</span>x<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token comment">// undefined</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>object<span class="token punctuation">.</span>x<span class="token punctuation">.</span>y<span class="token punctuation">.</span>z<span class="token punctuation">)</span> <span class="token comment">// Uncaught TypeError: Cannot read properties of undefined (reading 'z')</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">chaining</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// {x: 1}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">chaining</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">chaining</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// undefined</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">chaining</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">.</span>y<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// undefined</span>
</code></pre></div><h3 id="属性值校验"><a href="#属性值校验" class="header-anchor">#</a> 属性值校验</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">validate</span><span class="token punctuation">(</span><span class="token parameter">object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>property <span class="token operator">===</span> <span class="token string">'age'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Number<span class="token punctuation">.</span><span class="token function">isInteger</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'The age is not an integer'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> person <span class="token operator">=</span> <span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">18</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
person<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">18.5</span> <span class="token comment">// Uncaught TypeError: The age is not an integer</span>
</code></pre></div><h3 id="管道"><a href="#管道" class="header-anchor">#</a> 管道</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">pipe</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> funcs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> property<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      funcs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>window<span class="token punctuation">[</span>property<span class="token punctuation">]</span><span class="token punctuation">)</span>

      <span class="token keyword">return</span> proxy
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> funcs<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result<span class="token punctuation">,</span> func</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">func</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> proxy
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token function-variable function">double</span> <span class="token operator">=</span> <span class="token parameter">n</span> <span class="token operator">=&gt;</span> n <span class="token operator">*</span> <span class="token number">2</span>
<span class="token keyword">var</span> <span class="token function-variable function">pow</span> <span class="token operator">=</span> <span class="token parameter">n</span> <span class="token operator">=&gt;</span> n <span class="token operator">*</span> n

<span class="token function">pipe</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>double<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 36</span>
</code></pre></div><h3 id="数据监听"><a href="#数据监听" class="header-anchor">#</a> 数据监听</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token operator">&lt;</span>span<span class="token operator">&gt;</span><span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>button<span class="token operator">&gt;</span>按钮<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>

<span class="token keyword">function</span> <span class="token function">watch</span><span class="token punctuation">(</span><span class="token parameter">object<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">(</span>property<span class="token punctuation">,</span> value<span class="token punctuation">)</span>

      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token function">watch</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'value'</span><span class="token punctuation">)</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> value
<span class="token punctuation">}</span><span class="token punctuation">)</span>

document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  proxy<span class="token punctuation">.</span>value<span class="token operator">++</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="常见问题"><a href="#常见问题" class="header-anchor">#</a> 常见问题</h2> <h3 id="为什么-proxy-大多与-reflect-结合使用"><a href="#为什么-proxy-大多与-reflect-结合使用" class="header-anchor">#</a> 为什么 Proxy 大多与 Reflect 结合使用？</h3> <p>  以属性赋值时打印日志为例。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">set</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setter'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">// setter</span>
</code></pre></div><p>  ;<code>Reflect</code>将<code>set</code>语义透传到目标对象上，保持了默认的赋值行为。</p> <p>  以上也可写成。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setter'</span><span class="token punctuation">)</span>

    target<span class="token punctuation">[</span>property<span class="token punctuation">]</span> <span class="token operator">=</span> value

    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>  两者没有太大区别，但是注意像<code>set/get</code>此类<code>trap</code>相对容易，有些<code>trap</code>例如<code>ownKeys</code>，开发者几乎很难编写出来。</p> <p>  相对合理的是，所有<code>trap</code>的默认行为都统一由<code>Reflect</code>来做。换句话说，无论<code>Proxy</code>代理何种操作，总是可以在<code>Reflect</code>上找到对应的默认行为，也说明了为什么<code>trap</code>与<code>Reflect</code>方法是一对一的。</p> <p>  另外<code>set/get</code>中额外的参数<code>receiver</code>，用来保证<code>this</code>的正确传递。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> y <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// or target[property]</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

x<span class="token punctuation">.</span>value <span class="token operator">===</span> x <span class="token comment">// true</span>
y<span class="token punctuation">.</span>value <span class="token operator">===</span> y <span class="token comment">// false</span>
</code></pre></div><p>  综上所述。</p> <ul><li>保持默认行为，透传语义，且正确传递<code>this</code></li> <li>函数式编程，语义清晰，代码可自解释</li> <li>语言内部操作统一部署至<code>Reflect</code>，有利于管理和维护</li></ul> <h3 id="proxy-如何代理-map"><a href="#proxy-如何代理-map" class="header-anchor">#</a> Proxy 如何代理 Map？</h3> <p>  ;<code>JavaScript</code>对象除了会被引擎赋予内部方法，也会赋予内部槽。内部槽不是属性，类似属性，用于在对象上记录状态或数据。</p> <p>  以<code>Map</code>类型为例，引擎会赋予实例 <a href="https://262.ecma-international.org/13.0/#sec-properties-of-array-instances" target="_blank" rel="noopener noreferrer">[[MapData]]<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 内部槽，将各数据项存储在<code>[[MapData]]</code>上。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

map <span class="token comment">// Map(1) {1 =&gt; 2}</span>
</code></pre></div><p>  运行<code>map.set(1, 2)</code>时，由于实例上没有<code>set</code>方法，将沿着原型链寻找原型方法，则相当于运行<code>Map.prototype.set.call(map, 1, 2)</code>。紧接着<code>Map.prototype.set</code>方法内部将访问<code>this</code>实例对象的<code>[[MapData]]</code>内部槽，即<code>this.[[MapData]]</code>，也就是<code>map.[[MapData]]</code>，然后添加数据项。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// Uncaught TypeError: Method Map.prototype.set called on incompatible receiver #&lt;Map&gt;</span>
</code></pre></div><p>  而运行<code>proxy.set(1, 2)</code>时，<code>handler</code>为空<code>proxy</code>未代理任何操作，将获取<code>map.set</code>方法，则相当于<code>Map.prototype.set.call(<strong>proxy</strong>, 1, 2)</code>，<code>Map.prototype.set</code>即访问内部槽<code>proxy.[[MapData]]</code>。由于<code>proxy</code>对象没有此内部槽，将抛出错误。</p> <p>  那如何解决呢？</p> <p>  可将<code>set</code>方法内部<code>this</code>固定为<code>map</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> value <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token keyword">instanceof</span> <span class="token class-name">Map</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      value <span class="token operator">=</span> <span class="token function">value</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> value
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

map <span class="token comment">// Map(1) {1 =&gt; 2}</span>
</code></pre></div><h4 id="内置对象"><a href="#内置对象" class="header-anchor">#</a> 内置对象</h4> <p>  以上可总结出，即使<code>Proxy</code>未代理任何操作，也会将目标对象上方法或访问器内部<code>this</code>的指向修改为代理对象。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span>value <span class="token operator">===</span> proxy <span class="token comment">// true</span>
proxy<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> proxy <span class="token comment">// true</span>
</code></pre></div><p>  进一步的，在目标对象方法或访问器内部，若严格依赖<code>this</code>实例对象上的内部槽，而代理对象没有，运行可能会造成错误。</p> <p>  例如代理<code>Set</code>实例，<code>proxy</code>上没有 <a href="https://262.ecma-international.org/13.0/#sec-properties-of-set-instances" target="_blank" rel="noopener noreferrer">[[SetData]]<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 内部槽。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> set <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>set<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// Uncaught TypeError: Method Set.prototype.add called on incompatible receiver #&lt;Set&gt;</span>
</code></pre></div><p>  优化为。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> set <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>set<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> value <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token keyword">instanceof</span> <span class="token class-name">Set</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      value <span class="token operator">=</span> <span class="token function">value</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> value
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">set</span> <span class="token comment">// Set(1) {1}</span>
</code></pre></div><p>  或者代理<code>Promise</code>实例，<code>proxy</code>上没有 <a href="https://262.ecma-international.org/13.0/#sec-properties-of-promise-instances" target="_blank" rel="noopener noreferrer">[[PromiseState]]<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 内部槽。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> promise <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// Uncaught TypeError: Method Promise.prototype.then called on incompatible receiver #&lt;Promise&gt;</span>
</code></pre></div><p>  优化为。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> promise <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> value <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      value <span class="token operator">=</span> <span class="token function">value</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> value
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 1</span>
</code></pre></div><p>  又或者代理<code>Date</code>，<code>proxy</code>上没有 <a href="https://262.ecma-international.org/13.0/#sec-properties-of-date-instances" target="_blank" rel="noopener noreferrer">[[DateValue]]<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 内部槽。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>date<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span><span class="token function">getFullYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Uncaught TypeError: this is not a Date object</span>
</code></pre></div><p>  优化为。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>date<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> value <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token keyword">instanceof</span> <span class="token class-name">Date</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      value <span class="token operator">=</span> <span class="token function">value</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> value
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span><span class="token function">getFullYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 2022</span>
</code></pre></div><h4 id="私有属性"><a href="#私有属性" class="header-anchor">#</a> 私有属性</h4> <p>  类的私有属性中也存在类似问题。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
  #name <span class="token operator">=</span> <span class="token string">'xxx'</span>
  
  <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#name
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Uncaught TypeError: Cannot read private member #name from an object whose class did not declare it</span>
</code></pre></div><p>  先来看看<code>ECMA-262</code>规范中与私有属性有关的内部槽。</p> <blockquote><p><code>6.1.7.2 Object Internal Methods and Internal Slots</code><br> <code>All objects have an internal slot named [[PrivateElements]], which is a List of PrivateElements. This List represents the values of the private fields, methods, and accessors for the object. Initially, it is an empty List.</code></p></blockquote> <p>  大致语义为所有对象都有<code>[[PrivateElements]]</code>内部槽，是一个<code>PrivateElements</code>列表，记录对象的私有属性、方法和访问器。</p> <p>  ;<code>PrivateElements</code>又是什么呢？</p> <blockquote><p><code>6.2.9 The PrivateElement Specification Type</code><br> <code>...</code><br> <code>Values of the PrivateElement type are Record values whose fields are defined by Table 9. Such values are referred to as <strong>PrivateElements</strong>.</code></p></blockquote> <p>  ;<code>PrivateElement</code>是一种规范类型，字段包括。</p> <ul><li><code>[[Key]]</code>：属性、方法或访问器的名称</li> <li><code>[[Kind]]</code>：种类，属性、方法或访问器的一种</li> <li><code>[[Value]]</code>：值</li> <li><code>[[Get]]</code>：访问器<code>getter</code></li> <li><code>[[Set]]</code>：访问器<code>setter</code></li></ul> <p>  ;<code>PrivateElement</code>字段与字段值一起称为<code>PrivateElements</code>。</p> <p>  以<code>user</code>实例为例，私有属性<code>#name</code>对应的<code>PrivateElements</code>为。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token punctuation">[</span><span class="token punctuation">[</span>Key<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">:</span> #name<span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token punctuation">[</span>Kind<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">:</span> field<span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token punctuation">[</span>Value<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  内部槽为。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token punctuation">[</span><span class="token punctuation">[</span>PrivateElements<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token punctuation">[</span><span class="token punctuation">[</span>Key<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">:</span> #name<span class="token punctuation">,</span>
      <span class="token punctuation">[</span><span class="token punctuation">[</span>Kind<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">:</span> field<span class="token punctuation">,</span>
      <span class="token punctuation">[</span><span class="token punctuation">[</span>Value<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  而在<code>this.#name</code>获取私有属性时，将执行 <a href="https://262.ecma-international.org/13.0/#sec-privateelementfind" target="_blank" rel="noopener noreferrer">PrivateElementFind<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 抽象方法，返回<code>#name</code>对应的<code>PrivateElements</code>。然后执行 <a href="https://262.ecma-international.org/13.0/#sec-privateget" target="_blank" rel="noopener noreferrer">PrivateGet<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 抽象方法，返回<code>PrivateElements</code>上的<code>[[Value]]</code>字段值。</p> <p>  代理<code>user</code>导致<code>getName</code>方法内部<code>this</code>指向<code>proxy</code>，<code>proxy</code>虽为对象且有<code>[[PrivateElements]]</code>内部槽，但是<code>[[PrivateElements]]</code>值为空列表，获取属性时抽象方法<code>PrivateElementFind</code>会返回<code>empty</code>空值。继续执行抽象方法<code>PrivateGet</code>，空值将抛出错误。</p> <p>  类似的优化为。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
  #name <span class="token operator">=</span> <span class="token string">'xxx'</span>

  <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#name
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> value <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      value <span class="token operator">=</span> <span class="token function">value</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> value
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// xxx</span>
</code></pre></div><h4 id="性能局限"><a href="#性能局限" class="header-anchor">#</a> 性能局限</h4> <p>  ;<code>Proxy</code>也存在一些性能问题。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">normal</span><span class="token punctuation">(</span><span class="token parameter">count</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span>

  console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'normal'</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    object<span class="token punctuation">.</span>value<span class="token operator">++</span>
  <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'normal'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">defaultTrap</span><span class="token punctuation">(</span><span class="token parameter">count</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span>
  <span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

  console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'defaultTrap'</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    proxy<span class="token punctuation">.</span>value<span class="token operator">++</span>
  <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'defaultTrap'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">expressionTrap</span><span class="token punctuation">(</span><span class="token parameter">count</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span>
  <span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> target<span class="token punctuation">[</span>property<span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      target<span class="token punctuation">[</span>property<span class="token punctuation">]</span> <span class="token operator">=</span> value

      <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'expressionTrap'</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    proxy<span class="token punctuation">.</span>value<span class="token operator">++</span>
  <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'expressionTrap'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">reflectTrap</span><span class="token punctuation">(</span><span class="token parameter">count</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span>
  <span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'reflectTrap'</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    proxy<span class="token punctuation">.</span>value<span class="token operator">++</span>
  <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'reflectTrap'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token parameter">count</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span>
  <span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> object<span class="token punctuation">.</span>value
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">set</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      object<span class="token punctuation">.</span>value <span class="token operator">=</span> val
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'defineProperty'</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    proxy<span class="token punctuation">.</span>value<span class="token operator">++</span>
  <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'defineProperty'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">1000000</span>

<span class="token function">normal</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span>
<span class="token function">defaultTrap</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span>
<span class="token function">expressionTrap</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span>
<span class="token function">reflectTrap</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span>
<span class="token function">defineProperty</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span>
</code></pre></div><p>  ;<code>node</code>版本<code>v16.14.0</code>测试结果，其中<code>reflectTrap</code>相较于<code>normal</code>性能差了很多。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token literal-property property">normal</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">.</span>681ms
<span class="token literal-property property">defaultTrap</span><span class="token operator">:</span> <span class="token number">386</span><span class="token punctuation">.</span>346ms
<span class="token literal-property property">expressionTrap</span><span class="token operator">:</span> <span class="token number">61</span><span class="token punctuation">.</span>572ms
<span class="token literal-property property">reflectTrap</span><span class="token operator">:</span> <span class="token number">430</span><span class="token punctuation">.</span>464ms
<span class="token literal-property property">defineProperty</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">.</span>848ms
</code></pre></div><h3 id="polyfill-原理是什么"><a href="#polyfill-原理是什么" class="header-anchor">#</a> Polyfill 原理是什么？</h3> <p>  ;<code>Proxy</code>的 <a href="https://caniuse.com/?search=proxy" target="_blank" rel="noopener noreferrer">兼容性<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 相对较好，但<code>IE</code>浏览器的任何版本都不支持。</p> <p>  相关<code>polyfill</code>库内部都是用<code>Object.defineProperty</code>模拟<code>Proxy</code>语法，<code>es6-proxy-polyfill</code>相对较新，逻辑更加清晰，符合函数式编程。</p> <table><thead><tr><th style="text-align:center;"><code>polyfill</code></th> <th style="text-align:center;">兼容</th> <th style="text-align:center;"><code>traps</code></th> <th style="text-align:center;">支持度</th> <th style="text-align:center;">说明</th></tr></thead> <tbody><tr><td style="text-align:center;"><a href="https://github.com/GoogleChrome/proxy-polyfill" target="_blank" rel="noopener noreferrer">proxy-polyfill<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:center;"><code>IE9+</code></td> <td style="text-align:center;"><code>get</code>、<code>set</code>、<code>apply</code>和<code>construct</code></td> <td style="text-align:center;">对象、函数</td> <td style="text-align:center;">对象仅代理已存在属性，无法代理新属性</td></tr> <tr><td style="text-align:center;"><a href="https://github.com/ambit-tsai/es6-proxy-polyfill" target="_blank" rel="noopener noreferrer">es6-proxy-polyfill<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:center;"><code>IE6+</code></td> <td style="text-align:center;"><code>get</code>、<code>set</code>、<code>apply</code>和<code>construct</code></td> <td style="text-align:center;">对象、函数和数组</td> <td style="text-align:center;">非数组对象，仅代理已存在属性，无法代理新属性。<code>IE8</code>及以下依赖<code>object-defineproperty-ie</code>库支持</td></tr></tbody></table> <p>  以下将分析<code>es6-proxy-polyfill/src/index.js</code>核心部分。</p> <h4 id="内部类"><a href="#内部类" class="header-anchor">#</a> 内部类</h4> <p>  构造函数<code>Internal</code>创建内部实例，保存目标对象<code>target</code>和配置对象<code>handler</code>。外部统一调用实例方法来修改<code>target</code>，包括<code>GET</code>、<code>SET</code>、<code>CALL</code>和<code>CONSTRUCT</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> <span class="token constant">PROXY_TARGET</span> <span class="token operator">=</span> <span class="token string">'[[ProxyTarget]]'</span>
<span class="token keyword">var</span> <span class="token constant">PROXY_HANDLER</span> <span class="token operator">=</span> <span class="token string">'[[ProxyHandler]]'</span>
<span class="token keyword">var</span> <span class="token constant">GET</span> <span class="token operator">=</span> <span class="token string">'[[Get]]'</span>
<span class="token keyword">var</span> <span class="token constant">SET</span> <span class="token operator">=</span> <span class="token string">'[[Set]]'</span>
<span class="token keyword">var</span> <span class="token constant">CALL</span> <span class="token operator">=</span> <span class="token string">'[[Call]]'</span>
<span class="token keyword">var</span> <span class="token constant">CONSTRUCT</span> <span class="token operator">=</span> <span class="token string">'[[Construct]]'</span>

<span class="token keyword">function</span> <span class="token function">Internal</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> handler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token constant">PROXY_TARGET</span><span class="token punctuation">]</span> <span class="token operator">=</span> target
  <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token constant">PROXY_HANDLER</span><span class="token punctuation">]</span> <span class="token operator">=</span> handler
<span class="token punctuation">}</span>

<span class="token class-name">Internal</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span><span class="token constant">GET</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token class-name">Internal</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span><span class="token constant">SET</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token class-name">Internal</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span><span class="token constant">CALL</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token class-name">Internal</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span><span class="token constant">CONSTRUCT</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>  以<code>SET</code>修改属性值为例。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">Internal</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span><span class="token constant">SET</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">property<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> target <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token constant">PROXY_TARGET</span><span class="token punctuation">]</span><span class="token punctuation">,</span> handler <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token constant">PROXY_HANDLER</span><span class="token punctuation">]</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>handler<span class="token punctuation">.</span>set <span class="token operator">==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">[</span>property<span class="token punctuation">]</span> <span class="token operator">=</span> value
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> handler<span class="token punctuation">.</span>set <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> handler<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token function">Boolean</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  第一种情况在未指定<code>handler.set</code>时，默认修改目标对象。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

<span class="token keyword">var</span> internal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Internal</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
internal<span class="token punctuation">[</span><span class="token constant">SET</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

object <span class="token comment">// {x: 2}</span>
</code></pre></div><p>  第二种情况若指定了<code>handler.set</code>，则正确传递参数由<code>handler.set</code>来修改目标对象。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> value <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

<span class="token keyword">var</span> internal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Internal</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
internal<span class="token punctuation">[</span><span class="token constant">SET</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

object <span class="token comment">// {x: 6}</span>
</code></pre></div><h4 id="观察函数"><a href="#观察函数" class="header-anchor">#</a> 观察函数</h4> <p>  ;<code>observeProperty</code>观察对象已存在属性的读写操作，返回属性描述符。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">observeProperty</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> internal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> desc <span class="token operator">=</span> <span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> prop<span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'set'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">enumerable</span><span class="token operator">:</span> desc<span class="token punctuation">.</span>enumerable<span class="token punctuation">,</span>
    <span class="token literal-property property">configurable</span><span class="token operator">:</span> desc<span class="token punctuation">.</span>configurable<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  先不考虑<code>get</code>和<code>set</code>内逻辑，修改为<code>log</code>函数。</p> <p>  ;<code>observeProperties</code>观察对象自身所有属性。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">observeProperties</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> internal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> names <span class="token operator">=</span> <span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">,</span> descMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> names<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    descMap<span class="token punctuation">[</span>names<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">observeProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> names<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> internal<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">return</span> descMap
<span class="token punctuation">}</span>
</code></pre></div><p>  配合<code>Object.defineProperties</code>，可拦截对象属性的读写操作。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>

<span class="token keyword">var</span> descMap <span class="token operator">=</span> <span class="token function">observeProperties</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> descMap<span class="token punctuation">)</span>

object<span class="token punctuation">.</span>x <span class="token comment">// get</span>
object<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment">// set</span>
</code></pre></div><p>  ;<code>observeProto</code>观察对象原型链上所有属性，返回属性描述符。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">observeProto</span><span class="token punctuation">(</span><span class="token parameter">internal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> descMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> proto <span class="token operator">=</span> internal<span class="token punctuation">[</span><span class="token constant">PROXY_TARGET</span><span class="token punctuation">]</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>proto <span class="token operator">=</span> <span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>proto<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> props <span class="token operator">=</span> <span class="token function">observeProperties</span><span class="token punctuation">(</span>proto<span class="token punctuation">,</span> internal<span class="token punctuation">)</span>
    <span class="token function">objectAssign</span><span class="token punctuation">(</span>descMap<span class="token punctuation">,</span> props<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> descMap
<span class="token punctuation">}</span>
</code></pre></div><p>  例如观察数组原型。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">var</span> internal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Internal</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
<span class="token function">observeProto</span><span class="token punctuation">(</span>internal<span class="token punctuation">)</span>
</code></pre></div><p>  返回属性描述符，由数组每一级的原型对象的属性构成。</p> <p><img src="/js/proxy/proto.png" alt=""></p> <p>  暂时不关注<code>observeProto</code>作用，接着往下看。</p> <h4 id="主函数"><a href="#主函数" class="header-anchor">#</a> 主函数</h4> <p>  代理类型包括数组、对象和函数三种。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">ProxyPolyfill</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> handler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token keyword">return</span> <span class="token function">createProxy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Internal</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createProxy</span><span class="token punctuation">(</span><span class="token parameter">internal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> proxy<span class="token punctuation">,</span> target <span class="token operator">=</span> internal<span class="token punctuation">[</span><span class="token constant">PROXY_TARGET</span><span class="token punctuation">]</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> target <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    proxy <span class="token operator">=</span> <span class="token function">proxyFunction</span><span class="token punctuation">(</span>internal<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token keyword">instanceof</span> <span class="token class-name">Array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    proxy <span class="token operator">=</span> <span class="token function">proxyArray</span><span class="token punctuation">(</span>internal<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    proxy <span class="token operator">=</span> <span class="token function">proxyObject</span><span class="token punctuation">(</span>internal<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> proxy
<span class="token punctuation">}</span>

window<span class="token punctuation">.</span>Proxy <span class="token operator">=</span> ProxyPolyfill
</code></pre></div><p>  分类型的原因是什么呢？</p> <p>  返回值<code>proxy</code>类型与目标对象<code>target</code>类型存在一些关联。</p> <p>  例如代理函数，若支持<code>proxy()</code>函数式调用，<code>proxy</code>类型一定为函数。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">proxy</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="代理对象"><a href="#代理对象" class="header-anchor">#</a> 代理对象</h4> <p>  我们来手动编写一个代理对象函数<code>proxyObject</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">proxyObject</span><span class="token punctuation">(</span><span class="token parameter">internal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> descMap<span class="token punctuation">,</span> proxy <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> target <span class="token operator">=</span> internal<span class="token punctuation">[</span><span class="token constant">PROXY_TARGET</span><span class="token punctuation">]</span>

  descMap <span class="token operator">=</span> <span class="token function">observeProperties</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> internal<span class="token punctuation">)</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> descMap<span class="token punctuation">)</span>

  <span class="token keyword">return</span> proxy
<span class="token punctuation">}</span>
</code></pre></div><p>  观察并拦截了对象自身所有属性。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">var</span> internal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Internal</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token function">proxyObject</span><span class="token punctuation">(</span>internal<span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span>x <span class="token comment">// get</span>
proxy<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment">// set</span>
</code></pre></div><p>  然后考虑补全<code>observeProperty</code>函数内<code>set</code>和<code>get</code>。</p> <p>  即修改和读取目标对象的属性，我们可以借助内部实例的<code>SET</code>和<code>GET</code>方法。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">observeProperty</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> internal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> desc <span class="token operator">=</span> <span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> prop<span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> internal<span class="token punctuation">[</span><span class="token constant">GET</span><span class="token punctuation">]</span><span class="token punctuation">(</span>prop<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      internal<span class="token punctuation">[</span><span class="token constant">SET</span><span class="token punctuation">]</span><span class="token punctuation">(</span>prop<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  特别注意<code>set</code>和<code>get</code>内<code>this</code>实例默认指向调用者，恰好传至内部实例<code>receiver</code>参数。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>proxy<span class="token punctuation">.</span>x <span class="token comment">// 1</span>
proxy<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">3</span>
object <span class="token comment">// {x: 1, y: 3}</span>
</code></pre></div><h4 id="代理数组"><a href="#代理数组" class="header-anchor">#</a> 代理数组</h4> <p>  ;<code>proxyObject</code>也适用于数组类型。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">var</span> internal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Internal</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token function">proxyObject</span><span class="token punctuation">(</span>internal<span class="token punctuation">)</span>

proxy<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token comment">// 3</span>
</code></pre></div><p>  唯一差异在于无法代理数组的原型方法。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>proxy<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span> <span class="token comment">// Uncaught TypeError: proxy.join is not a function</span>
</code></pre></div><p>  因为<code>proxy</code>并没有<code>join</code>属性，运行肯定报错。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token number">0</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token number">1</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token number">2</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  那就很简单了，<code>proxy</code>添加<code>join</code>属性。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">proxyArray</span><span class="token punctuation">(</span><span class="token parameter">internal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> descMap<span class="token punctuation">,</span> target <span class="token operator">=</span> internal<span class="token punctuation">[</span><span class="token constant">PROXY_TARGET</span><span class="token punctuation">]</span>
  <span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'set'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>

  descMap <span class="token operator">=</span> <span class="token function">observeProperties</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> internal<span class="token punctuation">)</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> descMap<span class="token punctuation">)</span>

  <span class="token keyword">return</span> proxy
<span class="token punctuation">}</span>
</code></pre></div><p>  拦截了<code>join</code>属性。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">var</span> internal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Internal</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token function">proxyArray</span><span class="token punctuation">(</span>internal<span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span>join <span class="token comment">// get</span>
</code></pre></div><p>  仍然借助内部实例方法，补全<code>get</code>和<code>set</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> internal<span class="token punctuation">[</span><span class="token constant">GET</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'join'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">set</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    internal<span class="token punctuation">[</span><span class="token constant">GET</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'join'</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  还存在一个问题，即无法支持别的数组方法，例如<code>pop</code>、<code>reverse</code>等。</p> <p>  刚才的<code>observeProto</code>就派上用场了，修改下<code>proxyArray</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">proxyArray</span><span class="token punctuation">(</span><span class="token parameter">internal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> descMap<span class="token punctuation">,</span> proxy <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> target <span class="token operator">=</span> internal<span class="token punctuation">[</span><span class="token constant">PROXY_TARGET</span><span class="token punctuation">]</span>

  descMap <span class="token operator">=</span> <span class="token function">observeProto</span><span class="token punctuation">(</span>internal<span class="token punctuation">)</span>
  <span class="token keyword">delete</span> descMap<span class="token punctuation">.</span>length
  Object<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> descMap<span class="token punctuation">)</span>

  descMap <span class="token operator">=</span> <span class="token function">observeProperties</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> internal<span class="token punctuation">)</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> descMap<span class="token punctuation">)</span>

  <span class="token keyword">return</span> proxy
<span class="token punctuation">}</span>
</code></pre></div><p>  已经支持数组原型上的所有方法了。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">var</span> internal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Internal</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token function">proxyArray</span><span class="token punctuation">(</span>internal<span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 3</span>
proxy
<span class="token comment">// {</span>
<span class="token comment">//   0: 1,</span>
<span class="token comment">//   1: 2,</span>
<span class="token comment">//   at: ƒ at(),</span>
<span class="token comment">//   concat: ƒ concat(),</span>
<span class="token comment">//   ...</span>
<span class="token comment">//   hasOwnProperty: ƒ hasOwnProperty(),</span>
<span class="token comment">//   ...</span>
<span class="token comment">//   isPrototypeOf: ƒ isPrototypeOf(),</span>
<span class="token comment">//   ...</span>
<span class="token comment">//   valueOf: ƒ valueOf(),</span>
<span class="token comment">//   values: ƒ values(),</span>
<span class="token comment">// }</span>
</code></pre></div><p>  现在来看看<code>es6-proxy-polyfill</code>内部<code>proxyArray</code>，与我们编写的版本大同小异。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">proxyArray</span><span class="token punctuation">(</span><span class="token parameter">internal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> descMap<span class="token punctuation">,</span> newProto<span class="token punctuation">,</span> target <span class="token operator">=</span> internal<span class="token punctuation">[</span><span class="token constant">PROXY_TARGET</span><span class="token punctuation">]</span>

  descMap <span class="token operator">=</span> <span class="token function">observeProto</span><span class="token punctuation">(</span>internal<span class="token punctuation">)</span>
  newProto <span class="token operator">=</span> <span class="token function">objectCreate</span><span class="token punctuation">(</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">,</span> descMap<span class="token punctuation">)</span>

  descMap <span class="token operator">=</span> <span class="token function">observeProperties</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> internal<span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token function">objectCreate</span><span class="token punctuation">(</span>newProto<span class="token punctuation">,</span> descMap<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  差异仅在<code>es6-proxy-polyfill</code>未将原型方法作为<code>proxy</code>的属性，个人猜测是为了不破坏<code>proxy</code>自身属性，将原型方法合并为对象放在<code>proxy</code>的原型链头部，并将其指向了目标对象的原型链，形成一条新原型链<code>newProto</code>，如橙色箭头指向。</p> <p><img src="/js/proxy/newProto.png" alt=""></p> <h4 id="代理函数"><a href="#代理函数" class="header-anchor">#</a> 代理函数</h4> <h5 id="call-construct"><a href="#call-construct" class="header-anchor">#</a> CALL / CONSTRUCT</h5> <p>  以下为内部实例上<code>CALL</code>方法，其中<code>target.apply(thisArg, argList)</code>用于将数组<code>argList</code>转换为参数数列。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">Internal</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span><span class="token constant">CALL</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">thisArg<span class="token punctuation">,</span> argList</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> target <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token constant">PROXY_TARGET</span><span class="token punctuation">]</span><span class="token punctuation">,</span> handler <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token constant">PROXY_HANDLER</span><span class="token punctuation">]</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>handler<span class="token punctuation">.</span>apply <span class="token operator">==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">target</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>thisArg<span class="token punctuation">,</span> argList<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> handler<span class="token punctuation">.</span>apply <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">handler</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> thisArg<span class="token punctuation">,</span> argList<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  类似的在未指定<code>handler.apply</code>时，默认调用目标对象。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> <span class="token function-variable function">object</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> x <span class="token operator">+</span> y <span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

<span class="token keyword">var</span> internal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Internal</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
internal<span class="token punctuation">[</span><span class="token constant">CALL</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 3</span>
</code></pre></div><p>  若指定了<code>handler.apply</code>，则正确传递参数由<code>handler.apply</code>来调用目标对象。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> <span class="token function-variable function">object</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> x <span class="token operator">+</span> y <span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> thisArg<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">Reflect</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> thisArg<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

<span class="token keyword">var</span> internal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Internal</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
internal<span class="token punctuation">[</span><span class="token constant">CALL</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 9</span>
</code></pre></div><p>  接着来看下<code>CONSTRUCT</code>方法。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">Internal</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span><span class="token constant">CONSTRUCT</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">argList<span class="token punctuation">,</span> newTarget</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> newObj<span class="token punctuation">,</span> target <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token constant">PROXY_TARGET</span><span class="token punctuation">]</span><span class="token punctuation">,</span> handler <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token constant">PROXY_HANDLER</span><span class="token punctuation">]</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>handler<span class="token punctuation">.</span>construct <span class="token operator">==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    newObj <span class="token operator">=</span> <span class="token function">evaluateNew</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> argList<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> handler<span class="token punctuation">.</span>construct <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    newObj <span class="token operator">=</span> handler<span class="token punctuation">.</span><span class="token function">construct</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> argList<span class="token punctuation">,</span> newTarget<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> newObj
<span class="token punctuation">}</span>
</code></pre></div><p>  也是类似的，在未指定<code>handler.construct</code>时，则默认<code>new</code>目标对象。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> <span class="token function-variable function">object</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x
  <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y
<span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

<span class="token keyword">var</span> internal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Internal</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
internal<span class="token punctuation">[</span><span class="token constant">CONSTRUCT</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token constant">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// object {x: 1, y: 2}</span>
</code></pre></div><p>  注意<code>ES6</code>构造函数中数组转参数数列很容易。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">new</span> <span class="token class-name">target</span><span class="token punctuation">(</span><span class="token operator">...</span>argList<span class="token punctuation">)</span>
</code></pre></div><p>  但在<code>ES5</code>中较困难，借助<code>eval</code>或者<code>new Function</code>拼接参数才可实现。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">evaluateNew</span><span class="token punctuation">(</span><span class="token parameter"><span class="token constant">F</span><span class="token punctuation">,</span> argList</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  argList <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>argList<span class="token punctuation">)</span>

  <span class="token keyword">var</span> executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">'Ctor'</span><span class="token punctuation">,</span> <span class="token string">'return new Ctor('</span> <span class="token operator">+</span> argList <span class="token operator">+</span> <span class="token string">')'</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token function">executor</span><span class="token punctuation">(</span><span class="token constant">F</span><span class="token punctuation">,</span> argList<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  若指定了<code>handler.construct</code>，则正确传递参数由<code>handler.construct</code>来调用目标对象。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> <span class="token function-variable function">object</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x
  <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y
<span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">construct</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> args<span class="token punctuation">,</span> newTarget</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">construct</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> args<span class="token punctuation">,</span> newTarget<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

<span class="token keyword">var</span> internal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Internal</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
internal<span class="token punctuation">[</span><span class="token constant">CONSTRUCT</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token constant">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// F {x: 1, y: 2}</span>
</code></pre></div><h5 id="proxyfunction"><a href="#proxyfunction" class="header-anchor">#</a> proxyFunction</h5> <p>  主函数部分提及到，<code>proxy()</code>支持函数式调用，则返回值一定为函数。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">proxyFunction</span><span class="token punctuation">(</span><span class="token parameter">internal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token constant">P</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'function'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token constant">P</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  拦截了函数式调用。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> <span class="token function-variable function">object</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> x <span class="token operator">+</span> y <span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">var</span> internal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Internal</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token function">proxyFunction</span><span class="token punctuation">(</span>internal<span class="token punctuation">)</span>

<span class="token function">proxy</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// function</span>
</code></pre></div><p>  借助内部实例，修改<code>P</code>函数。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token constant">P</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> internal<span class="token punctuation">[</span><span class="token constant">CALL</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">proxy</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 3</span>
</code></pre></div><p>  如何知晓外部是否<code>new</code>调用呢？</p> <p>  判断函数<code>P</code>内<code>this</code>是否为<code>P</code>函数实例即可。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token constant">P</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">P</span>
    <span class="token operator">?</span> internal<span class="token punctuation">[</span><span class="token constant">CONSTRUCT</span><span class="token punctuation">]</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token constant">P</span><span class="token punctuation">)</span>
    <span class="token operator">:</span> internal<span class="token punctuation">[</span><span class="token constant">CALL</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="小结-3"><a href="#小结-3" class="header-anchor">#</a> 小结</h4> <p>  以上分析了<code>es6-proxy-polyfill</code>核心部分，包括代理对象、数组、函数三种类型，处理方式均大同小异，都是依赖<code>Object.defineProperty</code>或者<code>Object.create</code>拦截属性的修改和读取，注意<code>Object.create</code>第二个参数与<code>Object.defineProperty</code>作用类似，关于<code>Object.create</code>更多细节参考 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/create" target="_blank" rel="noopener noreferrer">MDN<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>  外部读取属性、修改属性或者执行方法，都是借助内部实例原型上的方法。配置对象在未指定对应<code>trap</code>时，默认操作目标对象。若指定了对应<code>trap</code>，则正确传递参数由<code>trap</code>处理目标对象。</p> <p>  在代理数组时之所以支持数组方法，例如<code>proxy.join(',')</code>。原理是将数组每一级原型的属性取出并合并成一个对象，作为<code>proxy</code>原型链的头部，且将头部指向了目标对象。</p> <h3 id="proxy-与类型转换"><a href="#proxy-与类型转换" class="header-anchor">#</a> Proxy 与类型转换</h3> <p>  简单代理属性的读取操作。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>property<span class="token punctuation">,</span> result<span class="token punctuation">)</span>

    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
</code></pre></div><p>  显式地将<code>proxy</code>转换为字符串。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>proxy<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// toString ƒ toString()</span>
<span class="token comment">// Symbol(Symbol.toStringTag) undefined</span>
</code></pre></div><p>  发现<code>handler.get</code>触发了两次，其中第一次是读取<code>proxy.toString</code>属性，即<code>object.toString</code>属性，沿着原型链查找就是<code>Object.prototype.toString</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>proxy<span class="token punctuation">.</span>toString <span class="token operator">===</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString
</code></pre></div><blockquote><p><code>proxy.toString()</code>等价于<code>Object.prototype.toString.call(proxy)</code></p></blockquote> <p>  第二次是如何呢？</p> <p>  我们可以在<code>ECMA-262</code>规范中第 <a href="https://262.ecma-international.org/13.0/#sec-object.prototype.tostring" target="_blank" rel="noopener noreferrer">20.1.3.6<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 小节寻找答案。</p> <blockquote><p><code>20.1.3.6 Object.prototype.toString ( )</code><br> <code>...</code><br> <code>3.Let O be ! ToObject(this value).</code><br> <code>...</code><br> <code>13.Else if O has a [[RegExpMatcher]] internal slot, let builtinTag be &quot;RegExp&quot;.</code><br> <code>14.Else, let builtinTag be &quot;Object&quot;.</code><br> <code><strong>15.Let tag be ? Get(O, @@toStringTag).</strong></code><br> <code>16.If Type(tag) is not String, set tag to builtinTag.</code><br> <code>17.Return the string-concatenation of &quot;[object &quot;, tag, and &quot;]&quot;.</code></p></blockquote> <p>  ;<code>toString</code>步骤大致为。</p> <ul><li>把<code>this</code>转换为对象<code>O</code>，并判断<code>O</code>是否有特殊的内部槽，若没有<code>builtinTag</code>默认为<code>Object</code></li> <li>读取对象<code>O[Symbol.toStringTag]</code>属性值为<code>tag</code>，若<code>tag</code>不是字符串，则<code>tag</code>赋为<code>builtinTag</code></li> <li>返回由<code>&quot;[object &quot;</code>、<code>tag</code>和<code>&quot;]&quot;</code>拼接而成的字符串</li></ul> <p>  忽略内部槽判断，手动编写<code>toString</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">toString</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> <span class="token constant">O</span> <span class="token operator">=</span> <span class="token function">Object</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token keyword">var</span> builtinTag <span class="token operator">=</span> <span class="token string">'Object'</span>
  <span class="token keyword">var</span> tag <span class="token operator">=</span> <span class="token constant">O</span><span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>toStringTag<span class="token punctuation">]</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> tag <span class="token operator">!==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tag <span class="token operator">=</span> builtinTag
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[object </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>内部槽是引擎层面的东西，<code>JavaScript</code>代码无法实现</p></blockquote> <p>  故在<code>proxy.toString()</code>运行时，<code>toString</code>内部读取了<code>proxy[Symbol.toStringTag]</code>属性，代理导致第二次触发<code>handler.get</code>方法。</p> <p>  再来看看<code>proxy</code>隐式转换。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>proxy <span class="token operator">+</span> <span class="token number">1</span>
<span class="token comment">// Symbol(Symbol.toPrimitive) undefined</span>
<span class="token comment">// valueOf ƒ valueOf()</span>
<span class="token comment">// toString ƒ toString()</span>
<span class="token comment">// Symbol(Symbol.toStringTag) undefined</span>
</code></pre></div><p>  为什么触发了四次<code>handler.get</code>呢？</p> <p>  参考 <a href="/pages/js/symbol.html#symbol-toprimitive">Symbol.toPrimitive</a> 我们知道，形如<code>x + y</code>的表达式，将分别对<code>x</code>和<code>y</code>执行<code>ToPrimitive(input, preferredType)</code>抽象运算，转化为原始值。</p> <p>  ;<code>ToPrimitive(proxy, default)</code>简略过程为。</p> <ul><li>判断是否有<code>proxy[Symbol.toPrimitive]</code>方法，返回<code>undefined</code>表示没有</li> <li>执行<code>proxy.valueOf()</code>方法，返回<code>proxy</code>对象</li> <li>执行<code>proxy.toString()</code>方法，返回<code>[object Object]</code>（原始值）</li> <li>拼接两原始值返回<code>[object Object]1</code></li></ul> <h2 id="小结-4"><a href="#小结-4" class="header-anchor">#</a> 小结</h2> <ul><li>构造函数<code>Proxy</code>没有<code>prototype</code>原型属性，无法继承</li> <li>为了内部方法的统一性，不变量也会限制<code>trap</code>的返回结果</li> <li>内置对象或者私有属性严格依赖<code>this</code>实例的内部槽，代理可能出错</li> <li><code>Proxy</code>也有局限性，例如无法代理<code>==</code>或<code>===</code>等操作</li> <li><code>Proxy</code>存在性能问题，即使没有任何<code>trap</code></li></ul> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ul><li><a href="https://www.zhihu.com/question/330408977/answer/811228034" target="_blank" rel="noopener noreferrer">Trap 结果检测<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.zhihu.com/question/460133198" target="_blank" rel="noopener noreferrer">Proxy 里面为什么要用 Reflect？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.zhihu.com/question/426875859" target="_blank" rel="noopener noreferrer">Proxy 怎样代理 Map？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.zhihu.com/question/460330154" target="_blank" rel="noopener noreferrer">关于 Proxy 代理的性能问题？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h2 id="🎉-写在最后"><a href="#🎉-写在最后" class="header-anchor">#</a> 🎉 写在最后</h2> <p>🍻伙伴们，如果你已经看到了这里，觉得这篇文章有帮助到你的话不妨点赞👍或 <a href="https://github.com/dongwei1125/blog" target="_blank" rel="noopener noreferrer">Star<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ✨支持一下哦！</p> <p>手动码字，如有错误，欢迎在评论区指正💬~</p> <p>你的支持就是我更新的最大动力💪~</p> <p><a href="https://github.com/dongwei1125" target="_blank" rel="noopener noreferrer">GitHub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> / <a href="https://gitee.com/dongwei1125" target="_blank" rel="noopener noreferrer">Gitee<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://dongwei1125.github.io/" target="_blank" rel="noopener noreferrer">GitHub Pages<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://juejin.cn/user/2621689331987783" target="_blank" rel="noopener noreferrer">掘金<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://blog.csdn.net/Don_GW" target="_blank" rel="noopener noreferrer">CSDN<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 同步更新，欢迎关注😉~</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">11/27/2022, 9:20:44 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.0aa97f73.js" defer></script><script src="/assets/js/2.f850a8ef.js" defer></script><script src="/assets/js/47.a89cf7d2.js" defer></script>
  </body>
</html>
