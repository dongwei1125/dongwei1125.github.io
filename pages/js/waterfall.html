<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>解析图片的瀑布流（含懒加载）原理，并搭配服务端交互数据 | DonV</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/header.jpg">
    <meta name="description" content="A paper about JavaScript, HTML and CSS.">
    
    <link rel="preload" href="/assets/css/0.styles.87611319.css" as="style"><link rel="preload" href="/assets/js/app.0aa97f73.js" as="script"><link rel="preload" href="/assets/js/2.f850a8ef.js" as="script"><link rel="preload" href="/assets/js/55.937bfe09.js" as="script"><link rel="prefetch" href="/assets/js/10.cb041c1b.js"><link rel="prefetch" href="/assets/js/11.1aadbcee.js"><link rel="prefetch" href="/assets/js/12.77cc8e56.js"><link rel="prefetch" href="/assets/js/13.7e8162d9.js"><link rel="prefetch" href="/assets/js/14.dea6ba67.js"><link rel="prefetch" href="/assets/js/15.a786d687.js"><link rel="prefetch" href="/assets/js/16.163edf25.js"><link rel="prefetch" href="/assets/js/17.3a0232cb.js"><link rel="prefetch" href="/assets/js/18.91bd2dd7.js"><link rel="prefetch" href="/assets/js/19.a36993f8.js"><link rel="prefetch" href="/assets/js/20.30dd9f79.js"><link rel="prefetch" href="/assets/js/21.5e3c83a3.js"><link rel="prefetch" href="/assets/js/22.88d5e321.js"><link rel="prefetch" href="/assets/js/23.b54a65a7.js"><link rel="prefetch" href="/assets/js/24.51df379f.js"><link rel="prefetch" href="/assets/js/25.79342bd2.js"><link rel="prefetch" href="/assets/js/26.643d5441.js"><link rel="prefetch" href="/assets/js/27.54b7d7b4.js"><link rel="prefetch" href="/assets/js/28.d01a4aee.js"><link rel="prefetch" href="/assets/js/29.7d932073.js"><link rel="prefetch" href="/assets/js/3.31ebf682.js"><link rel="prefetch" href="/assets/js/30.4c2f5636.js"><link rel="prefetch" href="/assets/js/31.b00c42d5.js"><link rel="prefetch" href="/assets/js/32.e9a0f488.js"><link rel="prefetch" href="/assets/js/33.f510b5fd.js"><link rel="prefetch" href="/assets/js/34.6e78f32f.js"><link rel="prefetch" href="/assets/js/35.04d666a2.js"><link rel="prefetch" href="/assets/js/36.900a3beb.js"><link rel="prefetch" href="/assets/js/37.19ddf8d7.js"><link rel="prefetch" href="/assets/js/38.35f899bd.js"><link rel="prefetch" href="/assets/js/39.fe9ea525.js"><link rel="prefetch" href="/assets/js/4.3c7083a8.js"><link rel="prefetch" href="/assets/js/40.0d116ce0.js"><link rel="prefetch" href="/assets/js/41.6cdce4cf.js"><link rel="prefetch" href="/assets/js/42.ab0bd0d5.js"><link rel="prefetch" href="/assets/js/43.66c8f8eb.js"><link rel="prefetch" href="/assets/js/44.ac02981e.js"><link rel="prefetch" href="/assets/js/45.479814b0.js"><link rel="prefetch" href="/assets/js/46.29956259.js"><link rel="prefetch" href="/assets/js/47.a89cf7d2.js"><link rel="prefetch" href="/assets/js/48.859e3502.js"><link rel="prefetch" href="/assets/js/49.d0fa0b25.js"><link rel="prefetch" href="/assets/js/5.206809f3.js"><link rel="prefetch" href="/assets/js/50.d051084c.js"><link rel="prefetch" href="/assets/js/51.fa831e6a.js"><link rel="prefetch" href="/assets/js/52.3ed98760.js"><link rel="prefetch" href="/assets/js/53.016b1c3c.js"><link rel="prefetch" href="/assets/js/54.c88e06c5.js"><link rel="prefetch" href="/assets/js/56.03003660.js"><link rel="prefetch" href="/assets/js/57.8bcda68a.js"><link rel="prefetch" href="/assets/js/58.286692ba.js"><link rel="prefetch" href="/assets/js/59.fbfe98aa.js"><link rel="prefetch" href="/assets/js/6.6f9d9bda.js"><link rel="prefetch" href="/assets/js/60.0975844e.js"><link rel="prefetch" href="/assets/js/61.0af6cf48.js"><link rel="prefetch" href="/assets/js/62.66c23699.js"><link rel="prefetch" href="/assets/js/63.7fda9b3f.js"><link rel="prefetch" href="/assets/js/7.6f64fba1.js"><link rel="prefetch" href="/assets/js/8.a163349f.js"><link rel="prefetch" href="/assets/js/9.9058d3cc.js">
    <link rel="stylesheet" href="/assets/css/0.styles.87611319.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/header.jpg" alt="DonV" class="logo"> <span class="site-name can-hide">DonV</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/pages/js/nav.html" class="nav-link">
  JavaScript
</a></div><div class="nav-item"><a href="/pages/html/nav.html" class="nav-link">
  HTML
</a></div><div class="nav-item"><a href="/pages/css/nav.html" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/pages/other/nav.html" class="nav-link">
  其它
</a></div><div class="nav-item"><a href="/pages/app/nav.html" class="nav-link">
  应用
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="关于" class="dropdown-title"><span class="title">关于</span> <span class="arrow down"></span></button> <button type="button" aria-label="关于" class="mobile-dropdown-title"><span class="title">关于</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/dongwei1125" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/dongwei1125" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://juejin.cn/user/2621689331987783" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://blog.csdn.net/Don_GW" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.npmjs.com/~dongwei1125" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NPM
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/pages/js/nav.html" class="nav-link">
  JavaScript
</a></div><div class="nav-item"><a href="/pages/html/nav.html" class="nav-link">
  HTML
</a></div><div class="nav-item"><a href="/pages/css/nav.html" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/pages/other/nav.html" class="nav-link">
  其它
</a></div><div class="nav-item"><a href="/pages/app/nav.html" class="nav-link">
  应用
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="关于" class="dropdown-title"><span class="title">关于</span> <span class="arrow down"></span></button> <button type="button" aria-label="关于" class="mobile-dropdown-title"><span class="title">关于</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/dongwei1125" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/dongwei1125" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://juejin.cn/user/2621689331987783" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://blog.csdn.net/Don_GW" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.npmjs.com/~dongwei1125" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NPM
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>解析图片的瀑布流（含懒加载）原理，并搭配服务端交互数据</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/js/waterfall.html#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/js/waterfall.html#准备工作" class="sidebar-link">准备工作</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/js/waterfall.html#工具函数" class="sidebar-link">工具函数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/js/waterfall.html#getrandomint" class="sidebar-link">getRandomInt</a></li><li class="sidebar-sub-header"><a href="/pages/js/waterfall.html#getrandomheight" class="sidebar-link">getRandomHeight</a></li><li class="sidebar-sub-header"><a href="/pages/js/waterfall.html#getrandomcolor" class="sidebar-link">getRandomColor</a></li><li class="sidebar-sub-header"><a href="/pages/js/waterfall.html#createitem" class="sidebar-link">createItem</a></li><li class="sidebar-sub-header"><a href="/pages/js/waterfall.html#request" class="sidebar-link">request</a></li><li class="sidebar-sub-header"><a href="/pages/js/waterfall.html#debounce" class="sidebar-link">debounce</a></li></ul></li><li><a href="/pages/js/waterfall.html#原理部分" class="sidebar-link">原理部分</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/js/waterfall.html#getcols" class="sidebar-link">getCols</a></li><li class="sidebar-sub-header"><a href="/pages/js/waterfall.html#getminindex" class="sidebar-link">getMinIndex</a></li><li class="sidebar-sub-header"><a href="/pages/js/waterfall.html#setwaterfallrect" class="sidebar-link">setWaterFallRect</a></li><li class="sidebar-sub-header"><a href="/pages/js/waterfall.html#waterfall" class="sidebar-link">waterfall</a></li></ul></li><li><a href="/pages/js/waterfall.html#实现部分" class="sidebar-link">实现部分</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/js/waterfall.html#懒加载" class="sidebar-link">懒加载</a></li><li class="sidebar-sub-header"><a href="/pages/js/waterfall.html#响应式" class="sidebar-link">响应式</a></li></ul></li><li><a href="/pages/js/waterfall.html#完整代码" class="sidebar-link">完整代码</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/js/waterfall.html#效果图" class="sidebar-link">效果图</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/js/waterfall.html#懒加载-2" class="sidebar-link">懒加载</a></li><li class="sidebar-sub-header"><a href="/pages/js/waterfall.html#响应式-2" class="sidebar-link">响应式</a></li></ul></li><li><a href="/pages/js/waterfall.html#🎉-写在最后" class="sidebar-link">🎉 写在最后</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="解析图片的瀑布流-含懒加载-原理-并搭配服务端交互数据"><a href="#解析图片的瀑布流-含懒加载-原理-并搭配服务端交互数据" class="header-anchor">#</a> 解析图片的瀑布流（含懒加载）原理，并搭配服务端交互数据</h1> <p><img src="/js/waterfall/banner.gif" alt=""></p> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>  瀑布流是一种很常见的网页图片交互方式，效果可以参考 <a href="https://huaban.com/" target="_blank" rel="noopener noreferrer">花瓣网<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h2 id="准备工作"><a href="#准备工作" class="header-anchor">#</a> 准备工作</h2> <p>  首先来查看一下目录结构，其中<code>app.js</code>为服务端启动文件，主要用来提供接口，返回所需的图片数据，<code>index.html</code>为瀑布流页面。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>├── app<span class="token punctuation">.</span>js
├── index<span class="token punctuation">.</span>html
├── <span class="token keyword">package</span><span class="token punctuation">.</span>json
├── node_modules<span class="token operator">/</span>
</code></pre></div><p>  服务端<code>app.js</code>利用<code>express</code>搭建本地服务器，其中访问<code>http://127.0.0.1:3000</code>默认返回瀑布流页面，获取图片接口一般是以<code>pageNo</code>和<code>pageSize</code>的分页模式，由于仅是提供简单的数据服务，根据请求参数返回图片列表即可，不必太多纠结逻辑，注意图片数量一般有限，假定大于<code>300</code>则不再返回数据只返回空数组。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// app.js</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">3000</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./index.html'</span><span class="token punctuation">,</span> <span class="token string">'UTF-8'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">'404 not found'</span>

    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/imgs'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> pageSize<span class="token punctuation">,</span> pageNo <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query
  <span class="token keyword">const</span> lists <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> total <span class="token operator">=</span> <span class="token number">300</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pageSize<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    lists<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'http://127.0.0.1/images/img.png'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    pageNo<span class="token punctuation">,</span>
    pageSize<span class="token punctuation">,</span>
    total<span class="token punctuation">,</span>
    <span class="token literal-property property">lists</span><span class="token operator">:</span> pageNo <span class="token operator">*</span> pageSize <span class="token operator">&gt;</span> total <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">:</span> lists<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">app is running at http://127.0.0.1:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>  ;<code>index.html</code>页面内，为了支持<code>IE9</code>及以上浏览器，<code>Promise</code>需引入第三方<code>CDN</code>，同时页面<code>ajax</code>请求需要用到<code>axios</code>库，另外页面所有函数均为普通函数，变量声明也仅用<code>var</code>，别问为什么，问就是兼容<code>IE</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>waterfall<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;promise-polyfill.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;axios.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>
</code></pre></div><p>  ;<code>CSS</code>中将<code>waterfall</code>块水平居中，内部<code>item</code>元素加了阴影，效果上会更加好一点。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token operator">&lt;</span>style<span class="token operator">&gt;</span>
  body <span class="token punctuation">{</span>
    <span class="token literal-property property">margin</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    min<span class="token operator">-</span>width<span class="token operator">:</span> 600px<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  #waterfall <span class="token punctuation">{</span>
    <span class="token literal-property property">margin</span><span class="token operator">:</span> 16px auto<span class="token punctuation">;</span>
    <span class="token literal-property property">position</span><span class="token operator">:</span> relative<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token punctuation">.</span>item <span class="token punctuation">{</span>
    <span class="token literal-property property">width</span><span class="token operator">:</span> 230px<span class="token punctuation">;</span>
    border<span class="token operator">-</span>radius<span class="token operator">:</span> 10px<span class="token punctuation">;</span>
    <span class="token literal-property property">position</span><span class="token operator">:</span> absolute<span class="token punctuation">;</span>
    box<span class="token operator">-</span>shadow<span class="token operator">:</span> <span class="token function">rgba</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.24</span><span class="token punctuation">)</span> 0px 3px 8px<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  #msg <span class="token punctuation">{</span>
    font<span class="token operator">-</span>size<span class="token operator">:</span> 18px<span class="token punctuation">;</span>
    font<span class="token operator">-</span>weight<span class="token operator">:</span> bold<span class="token punctuation">;</span>
    text<span class="token operator">-</span>align<span class="token operator">:</span> center<span class="token punctuation">;</span>
    <span class="token literal-property property">margin</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token literal-property property">height</span><span class="token operator">:</span> 80px<span class="token punctuation">;</span>
    line<span class="token operator">-</span>height<span class="token operator">:</span> 80px<span class="token punctuation">;</span>
    <span class="token literal-property property">color</span><span class="token operator">:</span> #3d3d3d<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>style<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;waterfall&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>p id<span class="token operator">=</span><span class="token string">&quot;msg&quot;</span><span class="token operator">&gt;</span>正在加载中<span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
</code></pre></div><h2 id="工具函数"><a href="#工具函数" class="header-anchor">#</a> 工具函数</h2> <p>  ;<code>js</code>部分包括很多工具类函数，接下来逐个详述。</p> <h3 id="getrandomint"><a href="#getrandomint" class="header-anchor">#</a> getRandomInt</h3> <p>  ;<code>getRandomInt</code>函数用于获取指定范围内的随机整数，包括两端的边界值在内。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">getRandomInt</span><span class="token punctuation">(</span><span class="token parameter">min<span class="token punctuation">,</span> max</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>max <span class="token operator">-</span> min <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> min
<span class="token punctuation">}</span>
</code></pre></div><h3 id="getrandomheight"><a href="#getrandomheight" class="header-anchor">#</a> getRandomHeight</h3> <p>  ;<code>getRandomHeight</code>获取随机高度，介于<code>200</code>到<code>500</code>之间，几百张高度不一致的图片不太好收集，利用随机数模拟即可。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">getRandomHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">getRandomInt</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'px'</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="getrandomcolor"><a href="#getrandomcolor" class="header-anchor">#</a> getRandomColor</h3> <p>  ;<code>getRandomColor</code>获取随机背景色，包括透明度，介于为<code>0.1</code>到<code>1</code>之间。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">getRandomColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'rgba('</span> <span class="token operator">+</span> <span class="token function">getRandomInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">', '</span> <span class="token operator">+</span> <span class="token function">getRandomInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">', '</span> <span class="token operator">+</span> <span class="token function">getRandomInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">', '</span> <span class="token operator">+</span> <span class="token function">getRandomInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">10</span> <span class="token operator">+</span> <span class="token string">')'</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="createitem"><a href="#createitem" class="header-anchor">#</a> createItem</h3> <p>  ;<code>createItem</code>用于创建<code>div</code>元素项，由于图片地址不可用，所以代码中注释了，元素项的高度和背景色根据上述其它工具函数生成。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">createItem</span><span class="token punctuation">(</span><span class="token parameter">src</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span>

  <span class="token comment">// var img = document.createElement('img')</span>
  <span class="token comment">// img.src = src</span>
  <span class="token comment">// div.appendChild(img)</span>

  div<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">'item'</span>
  div<span class="token punctuation">.</span>style<span class="token punctuation">.</span>background <span class="token operator">=</span> <span class="token function">getRandomColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  div<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token function">getRandomHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> div
<span class="token punctuation">}</span>
</code></pre></div><h3 id="request"><a href="#request" class="header-anchor">#</a> request</h3> <p>  ;<code>request</code>用户请求获取图片，其中<code>params</code>为<code>pageNo</code>和<code>pageSize</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">axios</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">'http://127.0.0.1:3000/imgs'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">params</span><span class="token operator">:</span> params<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="debounce"><a href="#debounce" class="header-anchor">#</a> debounce</h3> <p>  ;<code>debounce</code>防抖函数，用于限制触发频率，取个参数列表还把数组原型抬出来了，因为要兼容<code>IE</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">debounce</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> delay</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  delay <span class="token operator">=</span> delay <span class="token operator">||</span> <span class="token number">100</span>
  <span class="token keyword">var</span> timer <span class="token operator">=</span> <span class="token keyword">null</span>

  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span>
      timer <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>

    timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="原理部分"><a href="#原理部分" class="header-anchor">#</a> 原理部分</h2> <p>  瀑布流内部的元素要形成交错的样式风格，只能通过定位实现，因此外层<code>waterfall</code>需要相对定位，内部元素需要绝对定位。</p> <h3 id="getcols"><a href="#getcols" class="header-anchor">#</a> getCols</h3> <p>  然后再确定页面具体显示几列，其中<code>width</code>为元素项宽，<code>gap</code>为项与项之间的间隙。其中<code>n * width + (n - 1) * gap</code>为多列元素项所占宽度，应默认小于<code>body</code>的宽度，但是<code>body</code>左右需要留部分间隙，因此默认小于<code>bodyWidth - margin * 2</code>。调整等式，再通过<code>~~</code>（类似<code>parseInt</code>）取整即可。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">getCols</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// n * width + (n - 1) * gap &lt;= bodyWidth - margin * 2</span>
  <span class="token keyword">return</span> <span class="token operator">~</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>offsetWidth <span class="token operator">-</span> <span class="token number">32</span> <span class="token operator">+</span> gap<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>width <span class="token operator">+</span> gap<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  瀑布流的最根本原理就是，首行铺满元素后，后续元素均定位在高度最小的列的后面，依次往后定位铺满。因此全局下需要维护<code>heights</code>数组，用于存放每一列的当前高度。</p> <p><img src="/js/waterfall/theory.gif" alt=""></p> <h3 id="getminindex"><a href="#getminindex" class="header-anchor">#</a> getMinIndex</h3> <p>  ;<code>getMinIndex</code>用于获取<code>heights</code>数组中值最小的列的索引。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">getMinIndex</span><span class="token punctuation">(</span><span class="token parameter">array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> min <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> array<span class="token punctuation">)</span>

  <span class="token keyword">return</span> array<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>min<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="setwaterfallrect"><a href="#setwaterfallrect" class="header-anchor">#</a> setWaterFallRect</h3> <p>  注意由于外层<code>waterfall</code>块和内层元素定位的原因，内层元素脱离文档流，造成外层高度塌陷了。因此需要根据列数和<code>heights</code>共同设置外层元素的宽高。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">setWaterFallRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> wf <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#waterfall'</span><span class="token punctuation">)</span>
  <span class="token keyword">var</span> max <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> heights<span class="token punctuation">)</span>

  wf<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> max <span class="token operator">+</span> <span class="token string">'px'</span>
  wf<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> width <span class="token operator">*</span> cols <span class="token operator">+</span> <span class="token punctuation">(</span>cols <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> gap <span class="token operator">+</span> <span class="token string">'px'</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="waterfall"><a href="#waterfall" class="header-anchor">#</a> waterfall</h3> <p>  ;<code>waterfall</code>函数即实现上述功能，首行铺满同时填充高度值到<code>heights</code>中，后续的元素需要判断<code>heights</code>数组中值最小的索引，计算出<code>left</code>和<code>top</code>定位值并应用于当前元素。<code>for</code>循环结束所有的元素项布局定位完成，此时再更新外层<code>waterfall</code>块的宽高。</p> <p>  注意<code>for</code>循环中变量<code>i</code>初始值为<code>loaded</code>，<code>loaded</code>用于对已经完成布局定位的元素计数。因为需要配合懒加载，每次懒加载新增元素时，都只对新增的元素进行布局定位，而之前的元素则不再布局，以此来优化性能。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">waterfall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  cols <span class="token operator">=</span> <span class="token function">getCols</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">var</span> items <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'#waterfall .item'</span><span class="token punctuation">)</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> loaded<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> items<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> item <span class="token operator">=</span> items<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">var</span> height <span class="token operator">=</span> item<span class="token punctuation">.</span>offsetHeight

    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> cols<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      item<span class="token punctuation">.</span>style<span class="token punctuation">.</span>top <span class="token operator">=</span> <span class="token number">0</span>
      item<span class="token punctuation">.</span>style<span class="token punctuation">.</span>left <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token punctuation">(</span>width <span class="token operator">+</span> gap<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'px'</span>
      heights<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> minIndex <span class="token operator">=</span> <span class="token function">getMinIndex</span><span class="token punctuation">(</span>heights<span class="token punctuation">)</span>
      <span class="token keyword">var</span> top <span class="token operator">=</span> heights<span class="token punctuation">[</span>minIndex<span class="token punctuation">]</span> <span class="token operator">+</span> gap

      item<span class="token punctuation">.</span>style<span class="token punctuation">.</span>top <span class="token operator">=</span> top <span class="token operator">+</span> <span class="token string">'px'</span>
      item<span class="token punctuation">.</span>style<span class="token punctuation">.</span>left <span class="token operator">=</span> minIndex <span class="token operator">*</span> <span class="token punctuation">(</span>width <span class="token operator">+</span> gap<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'px'</span>
      heights<span class="token punctuation">[</span>minIndex<span class="token punctuation">]</span> <span class="token operator">=</span> top <span class="token operator">+</span> height
    <span class="token punctuation">}</span>

    loaded<span class="token operator">++</span>
  <span class="token punctuation">}</span>

  <span class="token function">setWaterFallRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="实现部分"><a href="#实现部分" class="header-anchor">#</a> 实现部分</h2> <p>  基础的工具函数和功能函数都已经完成，首先需要初始化整个瀑布流界面，其中<code>isReq</code>用作节流阀，后面接入懒加载时，滚动条触发过于频繁，若接口处于请求过程中，则不再请求。</p> <p>  ;<code>total</code>用于记录请求的图片总数，每次请求成功分页码加<code>1</code>，下次请求则请求下一页的数据。</p> <p>  ;<code>createDocumentFragment</code>用于将创建的<code>DOM</code>元素加入到文档片中，待所有的<code>DOM</code>创建完成并加入到文档片中时，再将文档片一次性插入到<code>waterfall</code>块中。</p> <p>  常规的方式是创建完元素就<code>append</code>到<code>waterfall</code>中，但是每次插入都会造成页面重排，而由于<code>createDocumentFragment</code>存在于内存中，不在<code>DOM</code>树中，因此将文档片插入到<code>waterfall</code>块中时页面仅仅重排一次。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isReq<span class="token punctuation">)</span> <span class="token keyword">return</span>
  isReq <span class="token operator">=</span> <span class="token boolean">true</span>

  <span class="token function">request</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> lists <span class="token operator">=</span> res<span class="token punctuation">.</span>lists
    <span class="token keyword">var</span> frag <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createDocumentFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    total <span class="token operator">=</span> res<span class="token punctuation">.</span>total
    isReq <span class="token operator">=</span> <span class="token boolean">false</span>
    params<span class="token punctuation">.</span>pageNo<span class="token operator">++</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> lists<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      frag<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token function">createItem</span><span class="token punctuation">(</span>lists<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#waterfall'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>frag<span class="token punctuation">)</span>

    <span class="token function">waterfall</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="懒加载"><a href="#懒加载" class="header-anchor">#</a> 懒加载</h3> <p>  ;<code>window</code>绑定滚动条事件，每次滚动都会触发<code>lazyLoad</code>懒加载。</p> <p>  注意文档未显示的内容高度为<code>documentHeight - scrollTop - clientHeight</code>，一般此部分高度小于窗口高度的一半就加载新的数据。</p> <p>  满足此条件的同时，若完成布局的元素数量<code>loaded</code>大于或者等于请求的图片数量<code>total</code>，即表示服务端返回的数据已经全部加载完成，不用再请求数据，因此注销滚动条事件。</p> <p>  为什么此处不用做滚动条防抖呢？原因在于<code>init</code>函数做了节流处理，即便是<code>init</code>频繁触发，获取图片的请求也最多只会有一个。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">,</span> lazyLoad<span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">lazyLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> scrollTop <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>scrollTop <span class="token operator">||</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollTop
  <span class="token keyword">var</span> documentHeight <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>scrollHeight
  <span class="token keyword">var</span> clientHeight <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight

  <span class="token comment">// documentHeight - scrollTop - clientHeight &lt; 0.5 * clientHeight</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>documentHeight <span class="token operator">-</span> scrollTop <span class="token operator">&lt;</span> <span class="token number">1.5</span> <span class="token operator">*</span> clientHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>loaded <span class="token operator">&gt;=</span> total<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#msg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">'没有更多了'</span>
      window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">,</span> lazyLoad<span class="token punctuation">)</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="响应式"><a href="#响应式" class="header-anchor">#</a> 响应式</h3> <p>  在此基础上再做一个响应式功能，即浏览器窗口宽度改变，动态切换列数。</p> <p>  窗口宽度改变后，整个页面的元素项需要重新布局，因此<code>loaded</code>和<code>heights</code>都要重置。</p> <p>  窗口宽度低于<code>body</code>的最小宽度无需重新布局，即无论窗口如何改变，至少显示两列。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'resize'</span><span class="token punctuation">,</span> <span class="token function">debounce</span><span class="token punctuation">(</span>resize<span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>offsetWidth <span class="token operator">&lt;</span> <span class="token number">600</span><span class="token punctuation">)</span> <span class="token keyword">return</span>

  loaded <span class="token operator">=</span> <span class="token number">0</span>
  heights <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token function">waterfall</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="完整代码"><a href="#完整代码" class="header-anchor">#</a> 完整代码</h2> <p>  ;<a href="http://www.axios-js.com/" target="_blank" rel="noopener noreferrer">axios<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 和 <a href="https://github.com/taylorhakes/promise-polyfill" target="_blank" rel="noopener noreferrer">promise-polyfill<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 下载本地或<code>CDN</code>引入都可。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// index.html</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>waterfall<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;promise-polyfill.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;axios.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>style<span class="token operator">&gt;</span>
    body <span class="token punctuation">{</span>
      <span class="token literal-property property">margin</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
      min<span class="token operator">-</span>width<span class="token operator">:</span> 600px<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    #waterfall <span class="token punctuation">{</span>
      <span class="token literal-property property">margin</span><span class="token operator">:</span> 16px auto<span class="token punctuation">;</span>
      <span class="token literal-property property">position</span><span class="token operator">:</span> relative<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span>item <span class="token punctuation">{</span>
      <span class="token literal-property property">width</span><span class="token operator">:</span> 230px<span class="token punctuation">;</span>
      border<span class="token operator">-</span>radius<span class="token operator">:</span> 10px<span class="token punctuation">;</span>
      <span class="token literal-property property">position</span><span class="token operator">:</span> absolute<span class="token punctuation">;</span>
      box<span class="token operator">-</span>shadow<span class="token operator">:</span> <span class="token function">rgba</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.24</span><span class="token punctuation">)</span> 0px 3px 8px<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    #msg <span class="token punctuation">{</span>
      font<span class="token operator">-</span>size<span class="token operator">:</span> 18px<span class="token punctuation">;</span>
      font<span class="token operator">-</span>weight<span class="token operator">:</span> bold<span class="token punctuation">;</span>
      text<span class="token operator">-</span>align<span class="token operator">:</span> center<span class="token punctuation">;</span>
      <span class="token literal-property property">margin</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token literal-property property">height</span><span class="token operator">:</span> 80px<span class="token punctuation">;</span>
      line<span class="token operator">-</span>height<span class="token operator">:</span> 80px<span class="token punctuation">;</span>
      <span class="token literal-property property">color</span><span class="token operator">:</span> #3d3d3d<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>style<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;waterfall&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>p id<span class="token operator">=</span><span class="token string">&quot;msg&quot;</span><span class="token operator">&gt;</span>正在加载中<span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>

  <span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
    <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">function</span> <span class="token function">getRandomInt</span><span class="token punctuation">(</span><span class="token parameter">min<span class="token punctuation">,</span> max</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>max <span class="token operator">-</span> min <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> min
      <span class="token punctuation">}</span>

      <span class="token keyword">function</span> <span class="token function">getRandomHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">getRandomInt</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'px'</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">function</span> <span class="token function">getRandomColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;rgba(&quot;</span> <span class="token operator">+</span> <span class="token function">getRandomInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> <span class="token function">getRandomInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> <span class="token function">getRandomInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> <span class="token function">getRandomInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">10</span> <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">function</span> <span class="token function">createItem</span><span class="token punctuation">(</span><span class="token parameter">src</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span>

        <span class="token comment">// var img = document.createElement('img')</span>
        <span class="token comment">// img.src = src</span>
        <span class="token comment">// div.appendChild(img)</span>

        div<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">'item'</span>
        div<span class="token punctuation">.</span>style<span class="token punctuation">.</span>background <span class="token operator">=</span> <span class="token function">getRandomColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        div<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token function">getRandomHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> div
      <span class="token punctuation">}</span>

      <span class="token keyword">function</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">axios</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">'http://127.0.0.1:3000/imgs'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">params</span><span class="token operator">:</span> params<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">function</span> <span class="token function">debounce</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> delay</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        delay <span class="token operator">=</span> delay <span class="token operator">||</span> <span class="token number">100</span>
        <span class="token keyword">var</span> timer <span class="token operator">=</span> <span class="token keyword">null</span>

        <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span>
            timer <span class="token operator">=</span> <span class="token keyword">null</span>
          <span class="token punctuation">}</span>

          timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">function</span> <span class="token function">getCols</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// n * width + (n - 1) * gap &lt;= bodyWidth - margin * 2</span>
        <span class="token keyword">return</span> <span class="token operator">~</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>offsetWidth <span class="token operator">-</span> <span class="token number">32</span> <span class="token operator">+</span> gap<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>width <span class="token operator">+</span> gap<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">function</span> <span class="token function">getMinIndex</span><span class="token punctuation">(</span><span class="token parameter">array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> min <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> array<span class="token punctuation">)</span>

        <span class="token keyword">return</span> array<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>min<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">function</span> <span class="token function">setWaterFallRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> wf <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#waterfall'</span><span class="token punctuation">)</span>
        <span class="token keyword">var</span> max <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> heights<span class="token punctuation">)</span>

        wf<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> max <span class="token operator">+</span> <span class="token string">'px'</span>
        wf<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> width <span class="token operator">*</span> cols <span class="token operator">+</span> <span class="token punctuation">(</span>cols <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> gap <span class="token operator">+</span> <span class="token string">'px'</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">function</span> <span class="token function">waterfall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cols <span class="token operator">=</span> <span class="token function">getCols</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">var</span> items <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#waterfall .item'</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> loaded<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> items<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">var</span> item <span class="token operator">=</span> items<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
          <span class="token keyword">var</span> height <span class="token operator">=</span> item<span class="token punctuation">.</span>offsetHeight

          <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> cols<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            item<span class="token punctuation">.</span>style<span class="token punctuation">.</span>top <span class="token operator">=</span> <span class="token number">0</span>
            item<span class="token punctuation">.</span>style<span class="token punctuation">.</span>left <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token punctuation">(</span>width <span class="token operator">+</span> gap<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'px'</span>
            heights<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> minIndex <span class="token operator">=</span> <span class="token function">getMinIndex</span><span class="token punctuation">(</span>heights<span class="token punctuation">)</span>
            <span class="token keyword">var</span> top <span class="token operator">=</span> heights<span class="token punctuation">[</span>minIndex<span class="token punctuation">]</span> <span class="token operator">+</span> gap

            item<span class="token punctuation">.</span>style<span class="token punctuation">.</span>top <span class="token operator">=</span> top <span class="token operator">+</span> <span class="token string">'px'</span>
            item<span class="token punctuation">.</span>style<span class="token punctuation">.</span>left <span class="token operator">=</span> minIndex <span class="token operator">*</span> <span class="token punctuation">(</span>width <span class="token operator">+</span> gap<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'px'</span>
            heights<span class="token punctuation">[</span>minIndex<span class="token punctuation">]</span> <span class="token operator">=</span> top <span class="token operator">+</span> height
          <span class="token punctuation">}</span>

          loaded<span class="token operator">++</span>
        <span class="token punctuation">}</span>

        <span class="token function">setWaterFallRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isReq<span class="token punctuation">)</span> <span class="token keyword">return</span>
        isReq <span class="token operator">=</span> <span class="token boolean">true</span>

        <span class="token function">request</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">var</span> lists <span class="token operator">=</span> res<span class="token punctuation">.</span>lists
          <span class="token keyword">var</span> frag <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createDocumentFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

          total <span class="token operator">=</span> res<span class="token punctuation">.</span>total
          isReq <span class="token operator">=</span> <span class="token boolean">false</span>
          params<span class="token punctuation">.</span>pageNo<span class="token operator">++</span>

          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> lists<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            frag<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token function">createItem</span><span class="token punctuation">(</span>lists<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>

          document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#waterfall'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>frag<span class="token punctuation">)</span>

          <span class="token function">waterfall</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">function</span> <span class="token function">lazyLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> scrollTop <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>scrollTop <span class="token operator">||</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollTop
        <span class="token keyword">var</span> documentHeight <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>scrollHeight
        <span class="token keyword">var</span> clientHeight <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight

        <span class="token comment">// documentHeight - scrollTop - clientHeight &lt; 0.5 * clientHeight</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>documentHeight <span class="token operator">-</span> scrollTop <span class="token operator">&lt;</span> <span class="token number">1.5</span> <span class="token operator">*</span> clientHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>loaded <span class="token operator">&gt;=</span> total<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#msg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">'没有更多了'</span>
            window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">,</span> lazyLoad<span class="token punctuation">)</span>
            <span class="token keyword">return</span>
          <span class="token punctuation">}</span>

          <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">function</span> <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>offsetWidth <span class="token operator">&lt;</span> <span class="token number">600</span><span class="token punctuation">)</span> <span class="token keyword">return</span>

        loaded <span class="token operator">=</span> <span class="token number">0</span>
        heights <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token function">waterfall</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">var</span> width <span class="token operator">=</span> <span class="token number">230</span>

      <span class="token keyword">var</span> gap <span class="token operator">=</span> <span class="token number">16</span>

      <span class="token keyword">var</span> loaded <span class="token operator">=</span> <span class="token number">0</span>

      <span class="token keyword">var</span> cols <span class="token operator">=</span> <span class="token number">0</span>

      <span class="token keyword">var</span> params <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">pageNo</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token literal-property property">pageSize</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">var</span> total <span class="token operator">=</span> <span class="token number">0</span>

      <span class="token keyword">var</span> heights <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

      <span class="token keyword">var</span> isReq <span class="token operator">=</span> <span class="token boolean">false</span>

      <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

      window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">,</span> lazyLoad<span class="token punctuation">)</span>

      window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'resize'</span><span class="token punctuation">,</span> <span class="token function">debounce</span><span class="token punctuation">(</span>resize<span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>
</code></pre></div><h2 id="效果图"><a href="#效果图" class="header-anchor">#</a> 效果图</h2> <h3 id="懒加载-2"><a href="#懒加载-2" class="header-anchor">#</a> 懒加载</h3> <p><img src="/js/waterfall/lazyload.gif" alt=""></p> <h3 id="响应式-2"><a href="#响应式-2" class="header-anchor">#</a> 响应式</h3> <p><img src="/js/waterfall/reactive.gif" alt=""></p> <h2 id="🎉-写在最后"><a href="#🎉-写在最后" class="header-anchor">#</a> 🎉 写在最后</h2> <p>🍻伙伴们，如果你已经看到了这里，觉得这篇文章有帮助到你的话不妨点赞👍或 <a href="https://github.com/dongwei1125/blog" target="_blank" rel="noopener noreferrer">Star<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ✨支持一下哦！</p> <p>手动码字，如有错误，欢迎在评论区指正💬~</p> <p>你的支持就是我更新的最大动力💪~</p> <p><a href="https://github.com/dongwei1125" target="_blank" rel="noopener noreferrer">GitHub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> / <a href="https://gitee.com/dongwei1125" target="_blank" rel="noopener noreferrer">Gitee<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://dongwei1125.github.io/" target="_blank" rel="noopener noreferrer">GitHub Pages<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://juejin.cn/user/2621689331987783" target="_blank" rel="noopener noreferrer">掘金<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://blog.csdn.net/Don_GW" target="_blank" rel="noopener noreferrer">CSDN<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 同步更新，欢迎关注😉~</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">3/6/2022, 9:06:37 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.0aa97f73.js" defer></script><script src="/assets/js/2.f850a8ef.js" defer></script><script src="/assets/js/55.937bfe09.js" defer></script>
  </body>
</html>
